<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>經期觀測站（醫護版 V1）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js">
/* ======================== 月經週期摘要（自動顯示） ======================== */
async function showCycleSummary(){
    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=1000`);
    let d = await r.json();

    let startDates = [];
    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        if(o.code.text==="經期開始日" && o.valueDateTime){
            startDates.push(o.valueDateTime.substring(0,10));
        }
    });

    if(startDates.length < 2){
        document.getElementById("cycleStats").innerHTML = "<b>至少需要 2 筆經期開始資料才能計算週期。</b>";
        document.getElementById("cycleSummaryCard").classList.remove("hidden");
        return;
    }

    startDates.sort();
    let intervals=[];
    for(let i=1;i<startDates.length;i++){
        let d1=new Date(startDates[i-1]);
        let d2=new Date(startDates[i]);
        intervals.push(Math.round((d2-d1)/86400000));
    }

    let avg = Math.round(intervals.reduce((a,b)=>a+b)/intervals.length);
    let minv = Math.min(...intervals);
    let maxv = Math.max(...intervals);
    let regular = (maxv-minv)<=3? "✔ 正常（差異 ≤ 3 天）" : "⚠ 較不規律（>3 天）";

    document.getElementById("cycleStats").innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div style="padding:10px;background:#f6f0e8;border-radius:6px;"><strong>平均週期：</strong>${avg} 天</div>
            <div style="padding:10px;background:#f6f0e8;border-radius:6px;"><strong>最短：</strong>${minv} 天</div>
            <div style="padding:10px;background:#f6f0e8;border-radius:6px;"><strong>最長：</strong>${maxv} 天</div>
            <div style="padding:10px;background:#f6f0e8;border-radius:6px;"><strong>規律度：</strong>${regular}</div>
        </div>
    `;

    const ctx=document.getElementById("cycleChart");
    if(window.cycleChartInstance) window.cycleChartInstance.destroy();

    window.cycleChartInstance = new Chart(ctx,{
        type:"bar",
        data:{
            labels: intervals.map((v,i)=>"週期 "+(i+1)),
            datasets:[{
                label:"週期天數",
                data:intervals,
                backgroundColor: intervals.map(v=> v>=21 && v<=35 ? "rgba(74,124,89,0.7)" : "rgba(201,76,76,0.7)"),
                borderColor: intervals.map(v=> v>=21 && v<=35 ? "#4a7c59" : "#c94c4c"),
                borderWidth:2
            }]
        },
        options:{
            responsive:true,
            scales:{y:{beginAtZero:true}}
        }
    });

    document.getElementById("cycleSummaryCard").classList.remove("hidden");
}

</script>

<style>
body {background:#eef3ff;font-family:Arial;color:#333;margin:0;padding:20px;}
h2 {text-align:center;color:#345b9c;margin-bottom:15px;}
.card {
    background:white;padding:18px;border-radius:12px;
    border-left:5px solid #345b9c;margin-bottom:20px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
button {
    padding:10px 18px;background:#345b9c;color:white;
    border:none;border-radius:8px;cursor:pointer;font-size:15px;
    margin-top:6px;
}
button:hover {opacity:0.9;}
label {font-weight:bold;margin-top:6px;display:block;}
input,select {
    width:100%;padding:6px;margin-top:4px;
    border-radius:6px;border:1px solid #bbb;background:white;
}
table {width:100%;border-collapse:collapse;margin-top:10px;}
th,td {border:1px solid #cfcfcf;padding:6px;text-align:left;}
.hidden {display:none;}
.row {display:flex;gap:10px;}
.col {flex:1;}
#popupOverlay{
    display:none;position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.55);align-items:center;justify-content:center;
}
#popup{
    background:white;padding:20px;border-radius:12px;width:80%;max-width:420px;
}
</style>
</head>

<body>

<!-- ⭐ 登出按鈕 -->
<button onclick="window.location.href='index.html'"
        style="position:fixed; top:15px; right:15px;
               background:#888; padding:8px 14px;
               border-radius:8px; font-size:14px; z-index:999;">
    登出
</button>

<h2>經期觀測站（醫護版）</h2>

<!-- ======================== 病人查詢 ======================== -->
<div class="card">
<h3>查詢病人資料</h3>

<label>病人姓名</label>
<input type="text" id="patientName">

<button onclick="loadPatient()">查詢資料</button>
<div id="statusBox" style="font-weight:bold;margin-top:10px;"></div>
</div>

<!-- ======================== 資料表格 ======================== -->
<div class="card hidden" id="dataCard">
<h3>完整欄位資料（依日期整併）</h3>
<div id="tableBox"></div>
</div>

<!-- ======================== 疼痛圖 ======================== -->
<div class="card hidden" id="chartCard">
<h3>疼痛趨勢圖（24 個月）</h3>
<canvas id="trendChart" height="120"></canvas>
</div>

<!-- ======================== 建議輸入彈出視窗 ======================== -->
<div id="popupOverlay">
  <div id="popup">
    <h3 id="popupTitle">輸入醫護建議</h3>
    <label>醫護建議內容：</label>
    <input type="text" id="adviceInput">
    <button onclick="submitAdvice()">送出建議</button>
    <button onclick="closePopup()" style="background:#aaa;margin-left:10px;">取消</button>
  </div>
</div>

<script>
const server="https://hapi.fhir.org/baseR4";
let patientId=null;
let selectedDate=null;

/* 查詢病人 */
async function loadPatient(){
    const name = patientName.value.trim();
    if(!name){ alert("請輸入病人姓名"); return; }

    statusBox.textContent="查詢中…";

    let r = await fetch(`${server}/Patient?name=${encodeURIComponent(name)}`);
    let d = await r.json();

    if(!d.entry){
        statusBox.textContent="查無此病人";
        return;
    }

    patientId = d.entry[0].resource.id;
    statusBox.textContent="已找到病人，載入資料…";

    loadTable();
    loadTrend24();
    showCycleSummary();
}

/* 載入表格 */
async function loadTable(){
    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=1000`);
    let d = await r.json();

    let map={};
    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        let date=o.effectiveDateTime?.substring(0,10);
        if(!date) return;
        if(!map[date]) map[date]={};
        map[date][o.code.text]={
            s:o.valueString||"",
            n:o.valueQuantity?o.valueQuantity.value:""
        };
    });

    let rows=Object.keys(map).sort().map(date=>{
        let v=map[date];
        return `
        <tr>
            <td>${date}</td>
            <td>${v["出血量"]?.s||""}</td>
            <td>${v["疼痛程度"]?.n||""}</td>
            <td>${v["症狀"]?.s||""}</td>
            <td>${v["心情"]?.s||""}</td>
            <td>${v["壓力"]?.n||""}</td>
            <td>${v["睡眠"]?.s||""}</td>
            <td>${v["醫護建議"]?.s||""}</td>
            <td><button onclick="openAdvice('${date}')">輸入建議</button></td>
        </tr>`;
    }).join("");

    tableBox.innerHTML=
        `<table>
            <tr>
                <th>日期</th><th>出血量</th><th>疼痛</th><th>症狀</th>
                <th>心情</th><th>壓力</th><th>睡眠</th>
                <th>現有醫護建議</th><th>新增建議</th>
            </tr>${rows}
        </table>`;

    dataCard.classList.remove("hidden");
}

/* 建議視窗 */
function openAdvice(date){
    selectedDate=date;
    adviceInput.value="";
    popupOverlay.style.display="flex";
    popupTitle.textContent=`針對 ${date} 的醫護建議：`;
}
function closePopup(){ popupOverlay.style.display="none"; }

async function submitAdvice(){
    if(!adviceInput.value.trim()){
        alert("請輸入內容"); return;
    }

    await fetch(`${server}/Observation`,{
        method:"POST",
        headers:{"Content-Type":"application/fhir+json"},
        body:JSON.stringify({
            resourceType:"Observation",
            status:"final",
            code:{text:"醫護建議"},
            subject:{reference:`Patient/${patientId}`},
            effectiveDateTime:selectedDate,
            valueString:adviceInput.value.trim()
        })
    });

    closePopup();
    loadTable();
    alert("已送出醫護建議！");
}

/* 24 個月趨勢圖 */
async function loadTrend24(){
    let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=1000`);
    let d=await r.json();

    let painMap={};
    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        let ds=o.effectiveDateTime;
        if(!ds) return;
        let m=ds.substring(0,7);
        if(o.code.text==="疼痛程度" && o.valueQuantity)
            painMap[m] = o.valueQuantity.value;
    });

    let now=new Date();
    let baseY=now.getFullYear();
    let baseM=now.getMonth();

    let labels=[];
    for(let i=0;i<24;i++){
        let dd=new Date(baseY,baseM+i,1);
        labels.push(dd.toISOString().substring(0,7));
    }

    let painData=labels.map(m=>painMap[m] || null);

    const ctx=document.getElementById("trendChart");
    if(window.trc) window.trc.destroy();

    window.trc=new Chart(ctx,{
        type:"line",
        data:{
            labels:labels,
            datasets:[{
                label:"疼痛程度（24 個月）",
                data:painData,
                borderColor:"#345b9c",
                borderWidth:3,
                pointRadius:5,
                tension:0.25
            }]
        }
    });

    chartCard.classList.remove("hidden");
}

/* ======================== 月經週期摘要（自動顯示） ======================== */
async function showCycleSummary(){
    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=1000`);
    let d = await r.json();

    let startDates = [];
    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        if(o.code.text==="經期開始日" && o.valueDateTime){
            startDates.push(o.valueDateTime.substring(0,10));
        }
    });

    if(startDates.length < 2){
        document.getElementById("cycleStats").innerHTML = "<b>至少需要 2 筆經期開始資料才能計算週期。</b>";
        document.getElementById("cycleSummaryCard").classList.remove("hidden");
        return;
    }

    startDates.sort();
    let intervals=[];
    for(let i=1;i<startDates.length;i++){
        let d1=new Date(startDates[i-1]);
        let d2=new Date(startDates[i]);
        intervals.push(Math.round((d2-d1)/86400000));
    }

    let avg = Math.round(intervals.reduce((a,b)=>a+b)/intervals.length);
    let minv = Math.min(...intervals);
    let maxv = Math.max(...intervals);
    let regular = (maxv-minv)<=3? "✔ 正常（差異 ≤ 3 天）" : "⚠ 較不規律（>3 天）";

    document.getElementById("cycleStats").innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div style="padding:10px;background:#f6f0e8;border-radius:6px;"><strong>平均週期：</strong>${avg} 天</div>
            <div style="padding:10px;background:#f6f0e8;border-radius:6px;"><strong>最短：</strong>${minv} 天</div>
            <div style="padding:10px;background:#f6f0e8;border-radius:6px;"><strong>最長：</strong>${maxv} 天</div>
            <div style="padding:10px;background:#f6f0e8;border-radius:6px;"><strong>規律度：</strong>${regular}</div>
        </div>
    `;

    const ctx=document.getElementById("cycleChart");
    if(window.cycleChartInstance) window.cycleChartInstance.destroy();

    window.cycleChartInstance = new Chart(ctx,{
        type:"bar",
        data:{
            labels: intervals.map((v,i)=>"週期 "+(i+1)),
            datasets:[{
                label:"週期天數",
                data:intervals,
                backgroundColor: intervals.map(v=> v>=21 && v<=35 ? "rgba(74,124,89,0.7)" : "rgba(201,76,76,0.7)"),
                borderColor: intervals.map(v=> v>=21 && v<=35 ? "#4a7c59" : "#c94c4c"),
                borderWidth:2
            }]
        },
        options:{
            responsive:true,
            scales:{y:{beginAtZero:true}}
        }
    });

    document.getElementById("cycleSummaryCard").classList.remove("hidden");
}

</script>

</body>
</html>
