
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¶“æœŸè§€æ¸¬ç«™ï¼ˆDebug å¼·åŒ–ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {background:#f3e9dd;font-family:Arial;color:#4b3f2f;margin:0;padding:20px;}
h2{text-align:center;color:#6d4b3a;margin-bottom:10px;}
#welcome{text-align:center;margin-bottom:20px;font-size:18px;}
.row{display:flex;gap:20px;}
.col{flex:1;}
.card{background:#fffaf3;padding:18px;border-radius:12px;
box-shadow:0 3px 6px rgba(0,0,0,0.1);border-left:5px solid #c19a6b;margin-bottom:20px;}
label{font-weight:bold;margin-top:10px;display:block;}
input,select,textarea{width:100%;padding:9px;margin-top:4px;margin-bottom:12px;
border-radius:6px;border:1px solid #d8c3a5;background:#fff7ef;}
textarea{height:60px;}
.separator{width:2px;background:#c9b8a4;margin:0 10px;border-radius:2px;}
button{width:100%;padding:14px;margin-top:10px;background:#c9a37c;color:white;
border:none;border-radius:8px;font-size:16px;}
#calendarTable td{border:1px solid #e5d3c0;width:14%;height:60px;vertical-align:top;padding:3px;}
.period-day{background:#ffe5e5 !important;}
.status-log{font-size:15px;color:#6b4c3c;margin-top:5px;}
</style>
</head>
<body>

<h2>ç¶“ æœŸ è§€ æ¸¬ ç«™ï¼ˆDebug å¼·åŒ–ç‰ˆï¼‰</h2>
<div id="welcome">è³‡æ–™è®€å–ä¸­â€¦</div>

<div class="row">
  <div class="col">
    <div class="card">
      <h3>ç”Ÿç†æœŸè¨˜éŒ„</h3>
      <label>ç¶“æœŸé–‹å§‹æ—¥</label><input type="date" id="startDate">
      <label>ç¶“æœŸçµæŸæ—¥</label><input type="date" id="endDate">
      <label>å‡ºè¡€é‡</label>
      <select id="flow"><option>å°‘</option><option>ä¸­</option><option>å¤š</option></select>
      <label>ç–¼ç—›ç¨‹åº¦ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="pain" min="0" max="10">
    </div>
  </div>

  <div class="separator"></div>

  <div class="col">
    <div class="card">
      <h3>ä»Šæ—¥èº«å¿ƒç—‡ç‹€</h3>
      <label>å…¶ä»–ç—‡ç‹€</label><textarea id="symptoms"></textarea>
      <label>å¿ƒæƒ…</label><select id="mood">
        <option>å¹³éœ</option><option>æ™®é€š</option><option>é›£é</option><option>ç”Ÿæ°£</option><option>ç„¦æ…®</option></select>
      <label>å£“åŠ›æŒ‡æ•¸ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="stress" min="0" max="10">
      <label>ç¡çœ å“è³ª</label><select id="sleep"><option>å¥½</option><option>æ™®é€š</option><option>å·®</option></select>
    </div>
  </div>
</div>

<button onclick="submitAll()">é€å‡ºä»Šæ—¥ç´€éŒ„</button>
<div class="status-log" id="submitStatus"></div>

<button onclick="generateHalfYear()">æ¸¬è©¦åŠå¹´è³‡æ–™ï¼ˆæ–¹æ¡ˆ Cï¼‰</button>
<div class="status-log" id="generateStatus"></div>

<button onclick="autoLoad()">ğŸ”„ è®€å–ä¼ºæœå™¨è³‡æ–™</button>
<div class="status-log" id="loadStatus"></div>


<div id="statusBox" class="card">è³‡æ–™è®€å–ä¸­â€¦</div>

<div class="card">
  <h3>æœˆç–¼ç—›è¶¨å‹¢ï¼ˆæœ€å¤§ç–¼ç—›å€¼ï¼‰</h3>
  <canvas id="painChart"></canvas>
  <div class="status-log" id="chartStatus"></div>
</div>

<div class="card">
  <h3>ç¶“æœŸæœˆæ›†</h3>
  <div style="display:flex;justify-content:space-between;">
    <button onclick="prevMonth()">â¬… ä¸Šå€‹æœˆ</button>
    <div id="calendarTitle"></div>
    <button onclick="nextMonth()">ä¸‹å€‹æœˆ â¡</button>
  </div>
  <table id="calendarTable" style="width:100%;border-collapse:collapse;"></table>
</div>

<script>
const server = "https://hapi.fhir.org/baseR4";
const userName = new URLSearchParams(location.search).get("name") || "è¨ªå®¢";
document.getElementById("welcome").textContent = "æ­¡è¿ï¼Œ" + userName + "ï¼ˆè«‹é»æŒ‰éˆ•é–‹å§‹è¼‰å…¥ï¼‰";
let patientId = null;
</script>
<script>

/* ==============================
   Utility: Debug ç‹€æ…‹é¡¯ç¤º
============================== */
function logStatus(id, message, isError = false) {
  const el = document.getElementById(id);
  el.textContent = message;
  el.style.color = isError ? "red" : "#6b4c3c";
}

/* ==============================
   Find or Create Patient
============================== */
async function findOrCreatePatient() {
  try {
    let r = await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
    let d = await r.json();
    console.log("ğŸ” Patient Search:", d);

    if (d.entry) {
      patientId = d.entry[0].resource.id;
      return patientId;
    }

    let res = await fetch(`${server}/Patient`, {
      method: "POST",
      headers: { "Content-Type": "application/fhir+json" },
      body: JSON.stringify({
        resourceType: "Patient",
        name: [{ text: userName }],
        identifier: [{ system: "http://example.org/pid", value: userName }]
      })
    });
    let x = await res.json();
    console.log("âœ… Patient Created:", x);
    patientId = x.id;
    return patientId;

  } catch (e) {
    console.error("âŒ Error finding/creating patient", e);
    logStatus("statusBox", "âŒ ç„¡æ³•å»ºç«‹ Patient", true);
  }
}

/* ==============================
   Submit Todayâ€™s Data
============================== */
async function submitAll() {
  document.getElementById("loadingOverlay").style.display = "flex";
  logStatus("submitStatus", "ğŸ“¤ å‚³é€ä¸­â€¦");

  try {
    await findOrCreatePatient();
    let today = new Date().toISOString().substring(0, 10);

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&date=${today}`);
    let d = await r.json();

    let entries = [];
    if (d.entry) {
      d.entry.forEach(e => {
        entries.push({ request: { method: "DELETE", url: `Observation/${e.resource.id}` }});
      });
    }

    let list = [
      { name: "ç¶“æœŸé–‹å§‹æ—¥", val: { valueDateTime: startDate.value } },
      { name: "ç¶“æœŸçµæŸæ—¥", val: { valueDateTime: endDate.value } },
      { name: "å‡ºè¡€é‡", val: { valueString: flow.value } },
      { name: "ç–¼ç—›ç¨‹åº¦", val: { valueQuantity: { value: Number(pain.value) } } },
      { name: "å…¶ä»–ç—‡ç‹€", val: { valueString: symptoms.value } },
      { name: "å¿ƒæƒ…", val: { valueString: mood.value } },
      { name: "å£“åŠ›æŒ‡æ•¸", val: { valueQuantity: { value: Number(stress.value) } } },
      { name: "ç¡çœ å“è³ª", val: { valueString: sleep.value } }
    ];

    list.forEach(o => {
      entries.push({
        resource: {
          resourceType: "Observation",
          status: "final",
          code: { coding: [{ system: "http://loinc.org", code: "TMP", display: o.name }], text: o.name },
          subject: { reference: `Patient/${patientId}` },
          effectiveDateTime: today,
          ...o.val
        },
        request: { method: "POST", url: "Observation" }
      });
    });

    const bundle = await fetch(`${server}`, {
      method: "POST",
      headers: { "Content-Type": "application/fhir+json" },
      body: JSON.stringify({ resourceType: "Bundle", type: "transaction", entry: entries })
    });

    const result = await bundle.json();
    console.log("ğŸ“¦ Bundle Result:", result);

    logStatus("submitStatus", "âœ… è³‡æ–™å·²é€å‡ºï¼");
    renderCalendar();

  } catch (err) {
    console.error("âŒ Submit Error", err);
    logStatus("submitStatus", "âŒ å‚³é€å¤±æ•—", true);
  } finally {
    document.getElementById("loadingOverlay").style.display = "none";
  }
}

/* ==============================
   Generate Half-Year Data
============================== */
async function generateHalfYear() {
  document.getElementById("loadingOverlay").style.display = "flex";
  logStatus("generateStatus", "â³ ç”¢ç”Ÿä¸­â€¦");

  try {
    await findOrCreatePatient();

    let today = new Date();
    let startYear = today.getFullYear();
    let startMonth = today.getMonth() - 5;
    if (startMonth < 0) { startYear--; startMonth += 12; }

    let arr = [];
    for (let m = 0; m < 6; m++) {
      let d = new Date(startYear, startMonth + m, 25);
      let ds = d.toISOString();
      arr.push({
        date: ds,
        flow: ["å°‘", "ä¸­", "å¤š"][Math.floor(Math.random() * 3)],
        pain: Math.floor(Math.random() * 6) + 3,
        stress: Math.floor(Math.random() * 10),
        sleep: ["å¥½", "æ™®é€š", "å·®"][Math.floor(Math.random() * 3)],
        mood: ["å¹³éœ", "æ™®é€š", "é›£é", "ç”Ÿæ°£", "ç„¦æ…®"][Math.floor(Math.random() * 5)]
      });
    }

    const res = await fetch(`${server}/Observation`, {
      method: "POST",
      headers: { "Content-Type": "application/fhir+json" },
      body: JSON.stringify({
        resourceType: "Observation",
        status: "final",
        code: { coding: [{ system: "http://loinc.org", code: "TMP", display: "åŠå¹´è³‡æ–™(JSON)" }], text: "åŠå¹´è³‡æ–™(JSON)" },
        subject: { reference: `Patient/${patientId}` },
        effectiveDateTime: new Date().toISOString(),
        valueString: JSON.stringify(arr)
      })
    });

    const out = await res.json();
    console.log("ğŸ“Š HalfYear Data POST:", out);

    logStatus("generateStatus", "ğŸ‰ è³‡æ–™å·²ç”¢ç”Ÿï¼");
    await loadMonthlyPain();
    renderCalendar();

  } catch (e) {
    console.error("âŒ HalfYear Gen Error", e);
    logStatus("generateStatus", "âŒ ç”¢ç”Ÿå¤±æ•—", true);
  } finally {
    document.getElementById("loadingOverlay").style.display = "none";
  }
}

</script>

<div id="loadingOverlay"
style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,0.5);color:white;font-size:32px;
align-items:center;justify-content:center;z-index:9999;">
è™•ç†ä¸­â€¦
</div>

</body>
</html>
