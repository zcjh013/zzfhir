<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>ç¶“æœŸè§€æ¸¬ç«™ - ç—…äººç«¯ï¼ˆæ–°ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background:#f3e9dd; font-family:Arial; color:#4b3f2f; margin:0; padding:20px; }
h2 { text-align:center; color:#6d4b3a; margin-bottom:10px; }
#welcome { text-align:center; margin-bottom:20px; }
.card { background:#fffaf3; padding:15px; border-radius:10px; box-shadow:0 3px 6px rgba(0,0,0,0.1); margin-bottom:20px; }
#calendarTable td { border:1px solid #e5d3c0; height:60px; vertical-align:top; position:relative; padding:3px; }
.period-day { background:#ffe5e5 !important; }
.pain-dot { width:8px; height:8px; position:absolute; bottom:3px; right:3px; border-radius:50%; background:#b47f4e; }
</style>
</head>

<body>
<h2>ç¶“æœŸè§€æ¸¬ç«™ï¼ˆæ–°ç‰ˆï¼‰</h2>
<div id="welcome">è¼‰å…¥ä¸­...</div>

<div class="card">
<h3>ä»Šæ—¥ç´€éŒ„</h3>
<label>ç¶“æœŸé–‹å§‹æ—¥</label><input type="date" id="startDate">
<label>ç¶“æœŸçµæŸæ—¥</label><input type="date" id="endDate">
<label>å‡ºè¡€é‡</label><select id="flow"><option>å°‘</option><option>ä¸­</option><option>å¤š</option></select>
<label>ç–¼ç—›ç¨‹åº¦ï¼ˆ0ï½10ï¼‰</label><input type="number" id="pain" min="0" max="10">
<button onclick="submitAll()">é€å‡ºä»Šæ—¥ç´€éŒ„</button>
</div>

<div class="card">
<h3>æœˆç–¼ç—›è¶¨å‹¢ï¼ˆæ¯æœˆ 1 æ¬¡ï¼‰</h3>
<canvas id="painChart"></canvas>
<button onclick="loadMonthlyPain()">æ›´æ–°è¶¨å‹¢åœ–</button>
</div>

<div class="card">
<h3>ç¶“æœŸæœˆæ›†</h3>
<div style="display:flex; justify-content:space-between;">
<button onclick="prevMonth()">â¬… ä¸Šå€‹æœˆ</button>
<div id="calendarTitle"></div>
<button onclick="nextMonth()">ä¸‹å€‹æœˆ â¡</button>
</div>
<table id="calendarTable" style="width:100%; border-collapse:collapse;"></table>
</div>

<script>
const server="https://hapi.fhir.org/baseR4";
const userName=new URLSearchParams(location.search).get("name")||"è¨ªå®¢";
document.getElementById("welcome").textContent="æ­¡è¿ï¼Œ"+userName;
let patientId=null;

//â”€â”€ å–å¾—æˆ–å»ºç«‹ç—…äºº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function findOrCreatePatient(){
    let r=await fetch(`${server}/Patient?name=${userName}`);
    let d=await r.json();
    if(d.entry){ patientId=d.entry[0].resource.id; return patientId; }
    let res=await fetch(`${server}/Patient`,{
        method:"POST", headers:{ "Content-Type":"application/fhir+json"},
        body:JSON.stringify({resourceType:"Patient",name:[{text:userName}]})
    });
    let created=await res.json(); patientId=created.id; return patientId;
}

//â”€â”€ ä»Šæ—¥ç´€éŒ„ï¼ˆè¦†è“‹å–ä»£ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitAll(){
    await findOrCreatePatient();
    let today=new Date().toISOString().substring(0,10);

    // åˆªé™¤ä»Šå¤©èˆŠç´€éŒ„ï¼ˆé¿å…å †ç–Šï¼‰
    let r1=await fetch(`${server}/Observation?subject=Patient/${patientId}&date=${today}`);
    let d1=await r1.json();
    if(d1.entry){
        for(let e of d1.entry){
            await fetch(`${server}/Observation/${e.resource.id}`,{method:"DELETE"});
        }
    }

    let list=[
        {code:"ç¶“æœŸé–‹å§‹æ—¥", val:{valueDateTime:startDate.value}},
        {code:"ç¶“æœŸçµæŸæ—¥", val:{valueDateTime:endDate.value}},
        {code:"å‡ºè¡€é‡", val:{valueString:flow.value}},
        {code:"ç–¼ç—›ç¨‹åº¦", val:{valueQuantity:{value:Number(pain.value)}}}
    ];

    for(let o of list){
        await fetch(`${server}/Observation`,{
            method:"POST",
            headers:{ "Content-Type":"application/fhir+json"},
            body:JSON.stringify({
                resourceType:"Observation",
                status:"final",
                code:{text:o.code},
                subject:{reference:`Patient/${patientId}`},
                effectiveDateTime: today,
                ...o.val
            })
        });
    }

    renderCalendar();
}

//â”€â”€ æœˆæ›† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentMonth=new Date();

function renderCalendar(){
    const y=currentMonth.getFullYear();
    const m=currentMonth.getMonth();
    document.getElementById("calendarTitle").textContent=`${y} å¹´ ${m+1} æœˆ`;

    const first=new Date(y,m,1).getDay();
    const days=new Date(y,m+1,0).getDate();

    let html="<tr><th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr><tr>";
    for(let i=0;i<first;i++) html+="<td></td>";

    for(let d=1;d<=days;d++){
        const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        html+=`<td id="d${ds}"><div>${d}</div></td>`;
        if((d+first)%7===0) html+="</tr><tr>";
    }
    html+="</tr>";

    document.getElementById("calendarTable").innerHTML=html;
    fillCal();
}

function prevMonth(){ currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); }
function nextMonth(){ currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); }

async function fillCal(){
    await findOrCreatePatient();
    const y=currentMonth.getFullYear();
    const m=currentMonth.getMonth();

    let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d=await r.json();
    let start=null, end=null;

    // å…ˆæ‰¾é–‹å§‹æ—¥ã€çµæŸæ—¥
    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        if(o.code.text==="ç¶“æœŸé–‹å§‹æ—¥") start=o.valueDateTime;
        if(o.code.text==="ç¶“æœŸçµæŸæ—¥") end=o.valueDateTime;
    });

    // æ¨™è¨˜ç¶“æœŸå€é–“
    if(start && end){
        let sd=new Date(start), ed=new Date(end);
        for(let dt=new Date(sd); dt<=ed; dt.setDate(dt.getDate()+1)){
            let ds=dt.toISOString().substring(0,10);
            let cell=document.getElementById("d"+ds);
            if(cell) cell.classList.add("period-day");
        }
    }

    // æ”¾å‡ºè¡€é‡èˆ‡ç–¼ç—›
    let dayMap={}; // ä¸€å¤©åªé¡¯ç¤ºä¸€ç­†
    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        let ds=o.effectiveDateTime?.substring(0,10);
        if(!ds) return;

        if(!dayMap[ds]) dayMap[ds]={};
        if(o.code.text==="å‡ºè¡€é‡") dayMap[ds].flow=o.valueString;
        if(o.code.text==="ç–¼ç—›ç¨‹åº¦") dayMap[ds].pain=o.valueQuantity?.value;
    });

    for(let ds in dayMap){
        let cell=document.getElementById("d"+ds);
        if(!cell) continue;
        let info=dayMap[ds];

        if(info.flow){
            cell.innerHTML+=`<div>ğŸ©¸${info.flow}</div>`;
        }
        if(info.pain>0){
            cell.innerHTML+=`<div class="pain-dot"></div>`;
        }
    }
}

//â”€â”€ æœˆç–¼ç—›è¶¨å‹¢ï¼ˆæ¯æœˆä¸€æ¬¡ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let painChart=null;

async function loadMonthlyPain(){
    await findOrCreatePatient();

    let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&code=ç–¼ç—›ç¨‹åº¦&_sort=-date`);
    let d=await r.json();
    const map={}; // {yyyy-mm : value}

    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        if(!o.valueQuantity) return;
        let month=o.effectiveDateTime.substring(0,7);
        if(!map[month]) map[month]=o.valueQuantity.value; // æ¯æœˆç¬¬ä¸€ç­†è¦–ç‚ºç•¶æœˆç—›å€¼
    });

    let labels=Object.keys(map).sort();
    let values=labels.map(m=>map[m]);

    const ctx=document.getElementById("painChart");
    if(painChart) painChart.destroy();

    painChart=new Chart(ctx,{
        type:"line",
        data:{
            labels:labels,
            datasets:[{
                label:"æ¯æœˆç–¼ç—›ç¨‹åº¦",
                data:values,
                borderColor:"#b47f4e",
                tension:0.3
            }]
        }
    });
}

//â”€â”€ åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderCalendar();
findOrCreatePatient().then(()=>{ fillCal(); loadMonthlyPain(); });

</script>
</body>
</html>
