
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¶“æœŸè§€æ¸¬ç«™ï¼ˆCycleChart Debug V5ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {background:#f3e9dd;font-family:Arial;color:#4b3f2f;margin:0;padding:20px;}
h2{text-align:center;color:#6d4b3a;margin-bottom:10px;}
#debugBox{background:#fff8e6;padding:10px;border-radius:10px;border:1px solid #d3b782;margin-bottom:15px;}
.status-log{font-size:15px;margin-top:4px;color:#5c4b3a;}
.row{display:flex;gap:20px;}
.col{flex:1;}
.card{background:#fffaf3;padding:18px;border-radius:12px;
box-shadow:0 3px 6px rgba(0,0,0,0.1);border-left:5px solid #c19a6b;margin-bottom:20px;}
label{font-weight:bold;margin-top:10px;display:block;}
input,select,textarea{width:100%;padding:9px;margin-top:4px;margin-bottom:12px;
border-radius:6px;border:1px solid #d8c3a5;background:#fff7ef;}
textarea{height:60px;}
.separator{width:2px;background:#c9b8a4;margin:0 10px;border-radius:2px;}
button{padding:10px 20px;margin:5px;background:#c9a37c;color:white;border:none;
border-radius:6px;font-size:15px;cursor:pointer;}
button:hover{background:#b88b63;}
#cycleChart{width:100%;height:420px;}
</style>
</head>
<body>

<h2>ç¶“ æœŸ è§€ æ¸¬ ç«™ï¼ˆCycleChart Debug V5ï¼‰</h2>
<div id="debugBox">
<b>ğŸ§© Debug æ§åˆ¶å°</b><br>
<div id="debugStatus">ç‹€æ…‹ï¼šé–’ç½®ä¸­</div>
<div id="debugError">éŒ¯èª¤ï¼šç„¡</div>
<div id="debugServer">ä¼ºæœå™¨ï¼šHAPI FHIR</div>
<div id="debugVersion">ç‰ˆæœ¬ï¼šCycleChart V5</div>
</div>

<div class="row">
<div class="col">
<div class="card">
<h3>ç”Ÿç†æœŸè¨˜éŒ„</h3>
<label>ç¶“æœŸé–‹å§‹æ—¥</label><input type="date" id="startDate">
<label>ç¶“æœŸçµæŸæ—¥</label><input type="date" id="endDate">
<label>å‡ºè¡€é‡</label><select id="flow"><option>å°‘</option><option>ä¸­</option><option>å¤š</option></select>
<label>ç–¼ç—›ç¨‹åº¦ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="pain" min="0" max="10">
</div></div>

<div class="separator"></div>

<div class="col">
<div class="card">
<h3>ä»Šæ—¥èº«å¿ƒç—‡ç‹€</h3>
<label>å…¶ä»–ç—‡ç‹€</label><textarea id="symptoms"></textarea>
<label>å¿ƒæƒ…</label><select id="mood"><option>å¹³éœ</option><option>æ™®é€š</option><option>é›£é</option><option>ç”Ÿæ°£</option><option>ç„¦æ…®</option></select>
<label>å£“åŠ›æŒ‡æ•¸ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="stress" min="0" max="10">
<label>ç¡çœ å“è³ª</label><select id="sleep"><option>å¥½</option><option>æ™®é€š</option><option>å·®</option></select>
</div></div>
</div>

<div style="text-align:center;margin-bottom:10px;">
<button onclick="submitAll()">ğŸš€ é€å‡ºä»Šæ—¥ç´€éŒ„</button>
<button onclick="generateHalfYear()">ğŸ§© ç”¢ç”ŸåŠå¹´è³‡æ–™</button>
<button onclick="renderCalendar()">ğŸ“… è¼‰å…¥æœˆæ›†</button>
<button onclick="loadMonthlyPain()">ğŸ“ˆ è¼‰å…¥è¶¨å‹¢åœ–</button>
<button onclick="checkServerData()">ğŸ” æŸ¥è©¢ä¼ºæœå™¨è³‡æ–™</button>
<button onclick="loadCycleChart()">ğŸ“Š é¡¯ç¤ºç¶“æœŸç‹€æ³è¡¨</button>
</div>

<div class="card">
<h3>ğŸ“Š ç¶“æœŸç‹€æ³è¡¨ï¼ˆç–¼ç—›ã€å‡ºè¡€é‡ã€é€±æœŸé–“éš”ï¼‰</h3>
<canvas id="cycleChart"></canvas>
</div>

<script>
const server = "https://hapi.fhir.org/baseR4";
const userName = new URLSearchParams(location.search).get("name") || "è¨ªå®¢";
let patientId = null;
let cycleChart = null;

function updateDebug(status, error="ç„¡"){
 document.getElementById("debugStatus").textContent="ç‹€æ…‹ï¼š"+status;
 document.getElementById("debugError").textContent="éŒ¯èª¤ï¼š"+error;
 console.log("ğŸ§©",status,error);
}

async function findOrCreatePatient(){
 try{
  let r=await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
  let d=await r.json();
  if(d.entry){patientId=d.entry[0].resource.id;return patientId;}
  let res=await fetch(`${server}/Patient`,{
   method:"POST",headers:{"Content-Type":"application/fhir+json"},
   body:JSON.stringify({resourceType:"Patient",name:[{text:userName}]})
  });
  let x=await res.json();patientId=x.id;return patientId;
 }catch(e){updateDebug("å»ºç«‹ç—…äººå¤±æ•—",e);}
}

async function loadCycleChart(){
 updateDebug("ğŸ“Š ç¶“æœŸç‹€æ³è¡¨è®€å–ä¸­...");
 try{
  await findOrCreatePatient();
  let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
  let d=await r.json();
  if(!d.entry){updateDebug("âš  ç„¡è§€æ¸¬è³‡æ–™");return;}
  let records=[];
  d.entry.forEach(e=>{
   let o=e.resource;let ds=o.effectiveDateTime?.substring(0,10);if(!ds)return;
   let pain=o.valueQuantity?.value||null;
   let flow=o.valueString||null;
   if(o.code.text.includes("ç–¼ç—›")||o.code.text.includes("å‡ºè¡€")||o.code.text.includes("ç¶“æœŸ")){
     records.push({date:ds,pain,flow});
   }
  });
  records.sort((a,b)=>new Date(a.date)-new Date(b.date));
  if(records.length===0){updateDebug("âš  ç„¡æœ‰æ•ˆè³‡æ–™");return;}
  // æ¨¡æ“¬ç¶“æœŸé–“éš”
  let cycleIntervals=[],lastStart=null;
  records.forEach(r=>{if(r.flow){if(lastStart){let diff=(new Date(r.date)-new Date(lastStart))/86400000;cycleIntervals.push({date:r.date,diff});}lastStart=r.date;}});

  const ctx=document.getElementById("cycleChart");
  if(cycleChart)cycleChart.destroy();

  const labels=records.map(r=>r.date.substring(5));
  const painValues=records.map(r=>r.pain||0);
  const flowColors=records.map(r=>{
   if(r.flow==="å¤š")return "rgba(255,0,0,0.4)";
   if(r.flow==="ä¸­")return "rgba(255,100,100,0.3)";
   if(r.flow==="å°‘")return "rgba(255,150,150,0.2)";
   return "rgba(0,0,0,0)";
  });

  cycleChart=new Chart(ctx,{
   type:"bar",
   data:{
     labels:labels,
     datasets:[
      {label:"å‡ºè¡€é‡",data:Array(records.length).fill(1),
       backgroundColor:flowColors,yAxisID:"y2",barPercentage:1.0,categoryPercentage:1.0},
      {label:"ç–¼ç—›ç¨‹åº¦",data:painValues,borderColor:"#b30000",backgroundColor:"rgba(255,0,0,0.2)",tension:0.25,type:"line",yAxisID:"y1"}
     ]
   },
   options:{
    scales:{
     y1:{beginAtZero:true,max:10,title:{display:true,text:"ç–¼ç—›ç¨‹åº¦"}},
     y2:{display:false}
    },
    plugins:{
     title:{display:true,text:"ç¶“æœŸç‹€æ³è¡¨ï¼ˆç–¼ç—›ã€å‡ºè¡€é‡ã€é€±æœŸé–“éš”ï¼‰"},
     tooltip:{enabled:true,callbacks:{label:(ctx)=>`ç–¼ç—›:${ctx.parsed.y}`}},
     legend:{display:true}
    }
   }
  });

  updateDebug("âœ… ç¶“æœŸç‹€æ³è¡¨å·²ç¹ªè£½");
 }catch(e){updateDebug("âŒ ç¹ªè£½éŒ¯èª¤",e);}
}
</script>

<div id="loadingOverlay">è™•ç†ä¸­â€¦</div>
</body>
</html>
