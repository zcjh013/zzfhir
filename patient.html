<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>經期觀測站（HAPI 整合版 V2）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {background:#f3e9dd;font-family:Arial;color:#4b3f2f;margin:0;padding:20px;}
h2 {text-align:center;color:#6d4b3a;margin-bottom:15px;}
.card {
    background:#fffaf3;padding:18px;border-radius:12px;
    border-left:5px solid #c19a6b;margin-bottom:20px;
}
button {
    padding:10px 20px;background:#c9a37c;color:white;
    border:none;border-radius:8px;cursor:pointer;font-size:16px;
    margin-top:10px;
}
label {font-weight:bold;margin-top:6px;display:block;}
input,select,textarea {
    width:100%;padding:6px;margin-top:4px;
    border-radius:6px;border:1px solid #d8c3a5;background:#fff7ef;
}
table {width:100%;border-collapse:collapse;margin-top:10px;}
th,td {border:1px solid #bda993;padding:6px;text-align:left;}
.hidden {display:none;}
.row {display:flex;gap:10px;}
.col {flex:1;}
</style>
</head>

<body>

<h2 id="welcome"></h2>

<!-- ======================== 上傳區 ======================== -->
<div class="card">
<h3>上傳紀錄</h3>

<div class="row">
    <div class="col"><label>經期開始日</label><input type="date" id="startDate"></div>
    <div class="col"><label>經期結束日</label><input type="date" id="endDate"></div>
    <div class="col"><label>出血量</label>
        <select id="flow"><option>少</option><option>中</option><option>多</option></select>
    </div>
    <div class="col"><label>疼痛程度（0〜10）</label>
        <input type="number" id="pain" min="0" max="10">
    </div>
</div>

<div class="row">
    <div class="col"><label>症狀</label><input type="text" id="symptoms"></div>
    <div class="col"><label>心情</label>
        <select id="mood"><option>平靜</option><option>普通</option><option>難過</option><option>生氣</option><option>焦慮</option></select>
    </div>
    <div class="col"><label>壓力（0〜10）</label><input type="number" id="stress" min="0" max="10"></div>
    <div class="col"><label>睡眠</label>
        <select id="sleep"><option>好</option><option>普通</option><option>差</option></select>
    </div>
</div>

<div class="row">
    <div class="col"><label>家屬建議</label><input type="text" id="familyAdvice"></div>
    <div class="col"><label>醫護建議</label><input type="text" id="doctorAdvice"></div>
</div>

<button onclick="submitAll()">送出紀錄</button>
<div id="statusBox" style="margin-top:8px;font-weight:bold;">尚未送出資料</div>
</div>

<!-- ======================== 查詢區 ======================== -->
<div class="card">
<h3>資料查詢</h3>

<button onclick="queryRaw()">查詢所有資料（原始表格）</button>
<button onclick="queryFull()">顯示全部欄位（合併版本）</button>
<button onclick="showTrend()">顯示疼痛趨勢圖</button>

<div id="queryStatus" style="font-weight:bold;margin-top:8px;"></div>

<!-- 原始簡易表格 -->
<div id="rawTableBox"></div>

<!-- 合併欄位表格 -->
<div id="fullTableBox" class="hidden"></div>

<!-- 趨勢圖 -->
<canvas id="trendChart" class="hidden" height="120"></canvas>
</div>

<script>
// ============================================
// 伺服器與基本設定
// ============================================
const server = "https://hapi.fhir.org/baseR4";
const userName = new URLSearchParams(location.search).get("name") || "訪客";
document.getElementById("welcome").textContent = "歡迎，" + userName + "（HAPI 整合版 V2）";
let patientId = null;

async function findOrCreatePatient(){
    let r = await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
    let d = await r.json();
    if(d.entry){
        patientId = d.entry[0].resource.id;
        return patientId;
    }
    let res = await fetch(`${server}/Patient`,{
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({
            resourceType:"Patient",
            name:[{text:userName}],
            identifier:[{system:"http://example.org/user", value:userName}]
        })
    });
    let x = await res.json();
    patientId = x.id;
    return patientId;
}

function obsCode(txt){ return {coding:[{system:"http://loinc.org", code:"TMP", display:txt}], text:txt}; }

// ============================================
// 送出紀錄
// ============================================
async function submitAll(){
    await findOrCreatePatient();

    let recordDate = startDate.value;
    if(!recordDate){ alert("請選擇經期開始日"); return; }

    document.getElementById("statusBox").textContent="送出中…";

    // 刪除當日舊資料
    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&date=${recordDate}`);
    let d = await r.json();
    let entries=[];
    if(d.entry){
        d.entry.forEach(e=>{
            entries.push({request:{method:"DELETE",url:`Observation/${e.resource.id}`}});
        });
    }

    let list=[
        { name:"經期開始日", v:{valueDateTime:startDate.value}},
        { name:"經期結束日", v:{valueDateTime:endDate.value}},
        { name:"出血量", v:{valueString:flow.value}},
        { name:"疼痛程度", v:{valueQuantity:{value:Number(pain.value)}}},
        { name:"症狀", v:{valueString:symptoms.value}},
        { name:"心情", v:{valueString:mood.value}},
        { name:"壓力", v:{valueQuantity:{value:Number(stress.value)}}},
        { name:"睡眠", v:{valueString:sleep.value}},
        { name:"家屬建議", v:{valueString:familyAdvice.value}},
        { name:"醫護建議", v:{valueString:doctorAdvice.value}}
    ];

    list.forEach(o=>{
        entries.push({
            resource:{
                resourceType:"Observation", status:"final",
                code: obsCode(o.name),
                subject:{reference:`Patient/${patientId}`},
                effectiveDateTime:recordDate,
                ...o.v
            },
            request:{method:"POST", url:"Observation"}
        });
    });

    await fetch(server,{
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({resourceType:"Bundle",type:"transaction",entry:entries})
    });

    document.getElementById("statusBox").textContent="送出成功！";
}

// ============================================
// 查詢資料（簡易原始版）
// ============================================
async function queryRaw(){
    document.getElementById("queryStatus").textContent="查詢中…";
    trendChart.classList.add("hidden");
    fullTableBox.classList.add("hidden");

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let rows = (d.entry||[]).map(e=>{
        let o=e.resource;
        return `<tr>
            <td>${o.code.text||""}</td>
            <td>${o.effectiveDateTime||""}</td>
            <td>${o.valueString||""}</td>
            <td>${o.valueQuantity?o.valueQuantity.value:""}</td>
        </tr>`;
    }).join("");

    rawTableBox.innerHTML =
        `<table>
            <tr><th>欄位</th><th>日期</th><th>字串值</th><th>數值</th></tr>
            ${rows}
        </table>`;

    rawTableBox.classList.remove("hidden");
    document.getElementById("queryStatus").textContent="查詢完成（原始版）";
}

// ============================================
// 查詢資料（合併版本）
// ============================================
async function queryFull(){
    document.getElementById("queryStatus").textContent="查詢中…";

    rawTableBox.classList.add("hidden");
    trendChart.classList.add("hidden");

    await findOrCreatePatient();
    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    // 建立以日期為主的資料表
    let map = {};

    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        let date = o.effectiveDateTime?.substring(0,10);
        if(!date) return;

        if(!map[date]) map[date]={};

        map[date][o.code.text] = {
            s: o.valueString || "",
            n: o.valueQuantity?o.valueQuantity.value:""
        };
    });

    // 轉成表格
    let rows = Object.keys(map).sort().map(date=>{
        let v = map[date];
        return `<tr>
            <td>${date}</td>
            <td>${v["出血量"]?.s||""}</td>
            <td>${v["疼痛程度"]?.n||""}</td>
            <td>${v["症狀"]?.s||""}</td>
            <td>${v["心情"]?.s||""}</td>
            <td>${v["壓力"]?.n||""}</td>
            <td>${v["睡眠"]?.s||""}</td>
            <td>${v["家屬建議"]?.s||""}</td>
            <td>${v["醫護建議"]?.s||""}</td>
        </tr>`;
    }).join("");

    fullTableBox.innerHTML =
        `<table>
            <tr>
                <th>日期</th><th>出血量</th><th>疼痛</th><th>症狀</th>
                <th>心情</th><th>壓力</th><th>睡眠</th>
                <th>家屬建議</th><th>醫護建議</th>
            </tr>
            ${rows}
        </table>`;

    fullTableBox.classList.remove("hidden");
    document.getElementById("queryStatus").textContent="完成（全部欄位）";
}

// ============================================
// 顯示疼痛趨勢圖
// ============================================
async function showTrend(){
    rawTableBox.classList.add("hidden");
    fullTableBox.classList.add("hidden");

    await findOrCreatePatient();
    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let painMap = {};
    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        let ds=o.effectiveDateTime;
        if(!ds) return;
        let m = ds.substring(0,7);
        if(o.code.text==="疼痛程度" && o.valueQuantity)
            painMap[m] = o.valueQuantity.value;
    });

    let year = (new Date()).getFullYear();
    let labels = [
        `${year}-01`,`${year}-02`,`${year}-03`,`${year}-04`,
        `${year}-05`,`${year}-06`,`${year}-07`,`${year}-08`,
        `${year}-09`,`${year}-10`,`${year}-11`,`${year}-12`
    ];

    let painData = labels.map(m=>painMap[m]||null);

    const ctx=document.getElementById("trendChart");
    if(window.trc) window.trc.destroy();

    window.trc = new Chart(ctx,{
        type:"line",
        data:{
            labels:labels,
            datasets:[{
                label:"疼痛程度",
                data:painData,
                borderColor:"#c94c4c",
                borderWidth:3,
                tension:0.3,
                pointRadius:5
            }]
        }
    });

    trendChart.classList.remove("hidden");
    document.getElementById("queryStatus").textContent="已顯示疼痛趨勢圖";
}
</script>

</body>
</html>
