<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>ç¶“æœŸè§€æ¸¬ç«™ - ç—…äººç«¯</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#f3e9dd; font-family:Arial; color:#4b3f2f; margin:0; padding:20px; }
h2 { text-align:center; color:#6d4b3a; margin-bottom:10px; }
#welcome { text-align:center; margin-bottom:20px; }
.container { display:flex; gap:20px; flex-wrap:wrap; }
.col { flex:1; min-width:280px; }
.card { background:#fffaf3; padding:15px; border-radius:10px; box-shadow:0 3px 6px rgba(0,0,0,0.1); margin-bottom:20px; }
.card h3 { margin-top:0; }
label { font-weight:bold; }
input, select, textarea { width:100%; padding:8px; margin:5px 0 10px; border-radius:6px; border:1px solid #d8c3a5; }
textarea { height:60px; }
button { width:100%; padding:12px; border:none; background:#c9a37c; color:white; border-radius:8px; margin-top:10px; }
button:hover { background:#b08968; }
#statusBox { background:#fff4e6; padding:12px; border-left:4px solid #d39f61; margin-top:10px; white-space:pre-line; }

/* Calendar */
#calendarTable td { border:1px solid #e5d3c0; height:60px; vertical-align:top; position:relative; padding:3px; }
.period-day { background:#ffe5e5 !important; }
.flow-low { color:#8a6f5a; }
.flow-mid { color:#b05b3c; font-weight:bold; }
.flow-high { color:#d62828; font-weight:bold; }
.pain-dot { width:8px; height:8px; position:absolute; bottom:3px; right:3px; border-radius:50%; background:#b47f4e; }
</style>
</head>

<body>
<h2>ç¶“ æœŸ è§€ æ¸¬ ç«™</h2>
<div id="welcome">è¼‰å…¥ä¸­...</div>

<div class="container">
    <!-- å·¦å´ -->
    <div class="col">
        <div class="card">
            <h3>ç”Ÿç†æœŸè¨˜éŒ„</h3>
            <label>ç¶“æœŸé–‹å§‹æ—¥</label>
            <input type="date" id="startDate">
            <label>ç¶“æœŸçµæŸæ—¥</label>
            <input type="date" id="endDate">
            <label>å‡ºè¡€é‡</label>
            <select id="flow"><option>å°‘</option><option>ä¸­</option><option>å¤š</option></select>
            <label>ç–¼ç—›ç¨‹åº¦ï¼ˆ0ï½10ï¼‰</label>
            <input type="number" id="pain" min="0" max="10">
        </div>
    </div>

    <!-- å³å´ -->
    <div class="col">
        <div class="card">
            <h3>ç—‡ç‹€ & èº«å¿ƒç‹€æ…‹</h3>
            <label>å…¶ä»–ç—‡ç‹€</label>
            <textarea id="symptoms"></textarea>

            <label>å¿ƒæƒ…</label>
            <select id="mood">
                <option>å¹³éœ</option><option>æ™®é€š</option><option>é›£é</option>
                <option>ç”Ÿæ°£</option><option>ç„¦æ…®</option>
            </select>

            <label>å£“åŠ›æŒ‡æ•¸ï¼ˆ0ï½10ï¼‰</label>
            <input type="number" id="stress" min="0" max="10">

            <label>ç¡çœ å“è³ª</label>
            <select id="sleep">
                <option>å¥½</option><option>æ™®é€š</option><option>å·®</option>
            </select>
        </div>
    </div>
</div>

<button onclick="submitAll()">é€å‡ºä»Šæ—¥ç´€éŒ„</button>
<button onclick="generateCycleData()">ç”¢ç”Ÿ 28 å¤©é€±æœŸæ¸¬è©¦è³‡æ–™</button>

<div id="statusBox">å°šæœªé€£ç·š</div>

<div class="card">
    <h3>ç–¼ç—›è¶¨å‹¢åœ–</h3>
    <button onclick="loadHistory()">è¼‰å…¥æ­·å²è³‡æ–™</button>
    <canvas id="cycleChart"></canvas>
</div>

<div class="card">
    <h3>ç¶“æœŸæœˆæ›†</h3>
    <div style="display:flex; justify-content:space-between;">
        <button onclick="prevMonth()">â¬… ä¸Šå€‹æœˆ</button>
        <div id="calendarTitle"></div>
        <button onclick="nextMonth()">ä¸‹å€‹æœˆ â¡</button>
    </div>
    <table id="calendarTable" style="width:100%; border-collapse:collapse;"></table>
</div>

<script>
// ===== å–å¾—ç™»å…¥åç¨± =====
const userName = new URLSearchParams(location.search).get("name") || "è¨ªå®¢";
document.getElementById("welcome").textContent = "æ­¡è¿ï¼Œ" + userName;

// ===== FHIR ä¼ºæœå™¨ =====
const server = "https://hapi.fhir.org/baseR4";
let patientId = null;

function showStatus(msg){ document.getElementById("statusBox").textContent = msg; }

// ===== æ‰¾/å»ºç—…äºº =====
async function findOrCreatePatient(){
    let r = await fetch(`${server}/Patient?name=${userName}`);
    let data = await r.json();
    if(data.entry){ patientId = data.entry[0].resource.id; return patientId; }

    let res = await fetch(`${server}/Patient`,{
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({ resourceType:"Patient", name:[{text:userName}], gender:"female" })
    });
    let created = await res.json();
    patientId = created.id;
    return patientId;
}

// ===== é€å‡ºç´€éŒ„ =====
async function submitAll(){
    await findOrCreatePatient();
    const today = new Date().toISOString();
    const list = [
        {name:"ç¶“æœŸé–‹å§‹æ—¥", obj:{valueDateTime: startDate.value}},
        {name:"ç¶“æœŸçµæŸæ—¥", obj:{valueDateTime: endDate.value}},
        {name:"å‡ºè¡€é‡", obj:{valueString: flow.value}},
        {name:"ç–¼ç—›ç¨‹åº¦", obj:{valueQuantity:{value:Number(pain.value)}}},
        {name:"å…¶ä»–ç—‡ç‹€", obj:{valueString: symptoms.value}},
        {name:"å¿ƒæƒ…", obj:{valueString: mood.value}},
        {name:"å£“åŠ›æŒ‡æ•¸", obj:{valueQuantity:{value:Number(stress.value)}}},
        {name:"ç¡çœ å“è³ª", obj:{valueString: sleep.value}},
    ];
    for(let o of list){
        await fetch(`${server}/Observation`,{
            method:"POST",
            headers:{ "Content-Type":"application/fhir+json" },
            body:JSON.stringify({
                resourceType:"Observation",
                status:"final",
                code:{text:o.name},
                subject:{reference:`Patient/${patientId}`},
                effectiveDateTime: today,
                ...o.obj
            })
        });
    }
    showStatus("ğŸ‰ ä»Šæ—¥ç´€éŒ„å·²é€å‡ºï¼");
}

// ===== ç–¼ç—›è¶¨å‹¢ =====
let chart=null;
async function loadHistory(){
    await findOrCreatePatient();
    let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&_sort=-date`);
    let d=await r.json();
    let labels=[], pain=[];
    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        if(o.code.text==="ç–¼ç—›ç¨‹åº¦" && o.valueQuantity){
            labels.push(o.effectiveDateTime.substring(0,10));
            pain.push(o.valueQuantity.value);
        }
    });
    const ctx=document.getElementById("cycleChart");
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
        type:"line",
        data:{ labels:labels.reverse(), datasets:[{ label:"ç–¼ç—›ç¨‹åº¦", data:pain.reverse(), borderColor:"#b47f4e" }] }
    });
    showStatus("ğŸ“ˆ è¶¨å‹¢åœ–å·²æ›´æ–°");
}

// ===== æœˆæ›† =====
let currentMonth=new Date();
function renderCalendar(){
    const y=currentMonth.getFullYear();
    const m=currentMonth.getMonth();
    document.getElementById("calendarTitle").textContent=`${y} å¹´ ${m+1} æœˆ`;
    const first=new Date(y,m,1).getDay();
    const days=new Date(y,m+1,0).getDate();
    let html="<tr><th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr><tr>";
    for(let i=0;i<first;i++) html+="<td></td>";
    for(let d=1;d<=days;d++){
        const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        html+=`<td id="d${ds}"><div>${d}</div><div class="dayInfo"></div></td>`;
        if((d+first)%7===0) html+="</tr><tr>";
    }
    html+="</tr>";
    document.getElementById("calendarTable").innerHTML=html;
}
function prevMonth(){ currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); fillCal(); }
function nextMonth(){ currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); fillCal(); }

// ===== å¡«å…¥æœˆæ›†è³‡æ–™ =====
async function fillCal(){
    await findOrCreatePatient();
    let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d=await r.json();
    (d.entry||[]).forEach(e=>{
        let o=e.resource, date=o.effectiveDateTime;
        if(!date) return;
        let s=date.substring(0,10);
        let td=document.getElementById("d"+s);
        if(!td) return;

        if(o.code.text==="å‡ºè¡€é‡"){
            let cls = o.valueString==="å°‘" ? "flow-low": o.valueString==="ä¸­" ? "flow-mid":"flow-high";
            td.querySelector(".dayInfo").innerHTML+=`<div class="${cls}">ğŸ©¸ ${o.valueString}</div>`;
        }
        if(o.code.text==="ç–¼ç—›ç¨‹åº¦") td.innerHTML+=`<div class="pain-dot"></div>`;
        if(o.code.text==="ç¶“æœŸé–‹å§‹æ—¥" || o.code.text==="ç¶“æœŸçµæŸæ—¥") td.classList.add("period-day");
    });
}

// ===== 28 å¤©é€±æœŸè³‡æ–™ =====
async function generateCycleData(){
    showStatus("ğŸ› ï¸ ç”¢ç”Ÿ 28 å¤©é€±æœŸè³‡æ–™ä¸­â€¦");
    await findOrCreatePatient();

    const today=new Date();
    const cycle=28;

    for(let i=0;i<cycle;i++){
        let d=new Date(today);
        d.setDate(d.getDate()-i);
        let iso=d.toISOString();
        let day=cycle-i;

        let pain=0, flow="ç„¡", stress=0, mood="å¹³éœ";

        if(day>=1 && day<=5){ flow=["å°‘","ä¸­","å¤š","ä¸­","å°‘"][day-1]; pain=4+Math.floor(Math.random()*4); stress=2+Math.random()*4; }
        else if(day>=6 && day<=14){ pain=Math.floor(Math.random()*3); }
        else if(day>=15 && day<=17){ pain=1+Math.floor(Math.random()*3); }
        else { pain=1+Math.floor(Math.random()*3); stress=3+Math.random()*4; }

        const list=[
            {name:"å‡ºè¡€é‡", obj:{valueString:flow}},
            {name:"ç–¼ç—›ç¨‹åº¦", obj:{valueQuantity:{value:pain}}},
            {name:"å£“åŠ›æŒ‡æ•¸", obj:{valueQuantity:{value:Math.floor(stress)}}},
            {name:"å¿ƒæƒ…", obj:{valueString:mood}},
        ];

        for(let o of list){
            await fetch(`${server}/Observation`,{
                method:"POST",
                headers:{ "Content-Type":"application/fhir+json" },
                body:JSON.stringify({
                    resourceType:"Observation",
                    status:"final",
                    code:{text:o.name},
                    subject:{reference:`Patient/${patientId}`},
                    effectiveDateTime: iso,
                    ...o.obj
                })
            });
        }
    }

    showStatus("ğŸ‰ å·²å®Œæˆ 28 å¤©é€±æœŸè³‡æ–™ï¼");
}

renderCalendar();
findOrCreatePatient().then(fillCal);
</script>

</body>
</html>
