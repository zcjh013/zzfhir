<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>經期觀測站 - 上傳 + 查詢 + DEBUG 版</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#f3e9dd;font-family:Arial;color:#4b3f2f;margin:0;padding:20px;}
h2{text-align:center;color:#6d4b3a;margin-bottom:10px;}
.card{background:#fffaf3;padding:18px;border-radius:12px;margin-bottom:20px;border-left:5px solid #c19a6b;}
button{width:100%;padding:14px;background:#c9a37c;color:#fff;border:none;border-radius:8px;margin-top:10px;font-size:16px;cursor:pointer;}
label{font-weight:bold;display:block;margin-top:10px;}
input,select,textarea{width:100%;padding:8px;margin-top:4px;border-radius:6px;border:1px solid #d8c3a5;background:#fff7ef;}
textarea{height:60px;}
pre{white-space:pre-wrap;background:#222;color:#0f0;padding:12px;height:300px;overflow:auto;}
</style>
</head>
<body>

<h2 id="welcome">歡迎</h2>

<div class="card">
<b>姓名：</b> <span id="debugName"></span>
</div>

<!-- 上傳資料欄位 -->
<div class="card">
<h3>上傳紀錄（手動）</h3>

<label>經期開始日（主索）</label>
<input type="date" id="startDate">

<label>經期結束日</label>
<input type="date" id="endDate">

<label>出血量</label>
<select id="flow"><option>少</option><option>中</option><option>多</option></select>

<label>疼痛程度（0~10）</label>
<input type="number" id="pain" min="0" max="10">

<label>其他症狀</label>
<textarea id="symptoms"></textarea>

<label>心情</label>
<select id="mood"><option>平靜</option><option>普通</option><option>難過</option><option>生氣</option><option>焦慮</option></select>

<label>壓力指數（0~10）</label>
<input type="number" id="stress" min="0" max="10">

<label>睡眠品質</label>
<select id="sleep"><option>好</option><option>普通</option><option>差</option></select>

<button onclick="submitAll()">送出紀錄</button>
</div>

<!-- 查詢按鈕 -->
<div class="card">
<h3>查詢伺服器資料</h3>
<button onclick="debugQuery()">查詢所有資料</button>
</div>

<!-- DEBUG 顯示 -->
<div class="card">
<h3>DEBUG 輸出</h3>
<pre id="debugBox">尚未查詢</pre>
</div>

<script>
const server="https://hapi.fhir.org/baseR4";
const userName=new URLSearchParams(location.search).get("name")||"訪客";
document.getElementById("welcome").textContent="歡迎，"+userName;
document.getElementById("debugName").textContent=userName;

let patientId=null;

// Debug 顯示
function debugLog(msg){
 document.getElementById("debugBox").textContent = msg;
}

// 找或建立 Patient
async function findOrCreatePatient(){
 let r=await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
 let d=await r.json();

 if(d.entry){
    patientId=d.entry[0].resource.id;
    return patientId;
 }

 let res=await fetch(`${server}/Patient`,{
   method:"POST",
   headers:{"Content-Type":"application/fhir+json"},
   body:JSON.stringify({
     resourceType:"Patient",
     name:[{text:userName}],
     identifier:[{system:"http://example.org/user",value:userName}]
   })
 });

 let x=await res.json();
 patientId=x.id;
 return patientId;
}

function obsCode(n){
 return {coding:[{system:"http://loinc.org",code:"TMP",display:n}],text:n};
}

// 送出紀錄
async function submitAll(){
 await findOrCreatePatient();

 let recordDate=startDate.value;
 if(!recordDate){ alert("請選擇經期開始日"); return; }

 debugLog("送出中...");

 // 刪除舊資料
 let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&date=${recordDate}`);
 let d=await r.json();
 let entries=[];

 if(d.entry){
  d.entry.forEach(e=>{
    entries.push({request:{method:"DELETE",url:`Observation/${e.resource.id}`}});
  });
 }

 let list=[
  {name:"經期開始日", val:{valueDateTime:startDate.value}},
  {name:"經期結束日", val:{valueDateTime:endDate.value}},
  {name:"出血量", val:{valueString:flow.value}},
  {name:"疼痛程度", val:{valueQuantity:{value:Number(pain.value)}}},
  {name:"其他症狀", val:{valueString:symptoms.value}},
  {name:"心情", val:{valueString:mood.value}},
  {name:"壓力指數", val:{valueQuantity:{value:Number(stress.value)}}},
  {name:"睡眠品質", val:{valueString:sleep.value}}
 ];

 list.forEach(o=>{
  entries.push({
    resource:{
      resourceType:"Observation",
      status:"final",
      code:obsCode(o.name),
      subject:{reference:`Patient/${patientId}`},
      effectiveDateTime:recordDate,
      ...o.val
    },
    request:{method:"POST",url:"Observation"}
  });
 });

 await fetch(`${server}`,{
  method:"POST",
  headers:{"Content-Type":"application/fhir+json"},
  body:JSON.stringify({resourceType:"Bundle",type:"transaction",entry:entries})
 });

 debugLog("=== 上傳完成 ===\n"+JSON.stringify(entries,null,2));
}

// 查詢資料
async function debugQuery(){
 debugLog("查詢中...");
 await findOrCreatePatient();

 let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
 let d=await r.json();

 debugLog(JSON.stringify(d,null,2));
}
</script>

</body>
</html>
