<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>經期觀測站（病人版 V4 最終版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {background:#f3e9dd;font-family:Arial;color:#4b3f2f;margin:0;padding:20px;}
h2 {text-align:center;color:#6d4b3a;margin-bottom:15px;}

.card {
    background:#fffaf3;padding:18px;border-radius:12px;
    border-left:5px solid #c19a6b;margin-bottom:20px;
}

button {
    padding:10px 20px;background:#c9a37c;color:white;
    border:none;border-radius:8px;cursor:pointer;font-size:16px;
    margin-top:10px;
}
button:hover {opacity:0.9;}

label {font-weight:bold;margin-top:6px;display:block;}

input,select,textarea {
    width:100%;padding:6px;margin-top:4px;
    border-radius:6px;border:1px solid #d8c3a5;background:#fff7ef;
}

table {width:100%;border-collapse:collapse;margin-top:10px;}
th,td {border:1px solid #bda993;padding:6px;text-align:left;}
.hidden {display:none;}

.row {display:flex;gap:10px;}
.col {flex:1;}

.summaryCard {
    background:#f7efe3;padding:12px;border-radius:10px;
    border-left:5px solid #9b59b6;margin-top:15px;
}
</style>
</head>

<body>

<h2 id="welcome"></h2>

<!-- ======================== 上傳區 ======================== -->
<div class="card">
<h3>上傳紀錄</h3>

<div class="row">
    <div class="col"><label>經期開始日</label><input type="date" id="startDate"></div>
    <div class="col"><label>經期結束日</label><input type="date" id="endDate"></div>
    <div class="col">
        <label>出血量</label>
        <select id="flow"><option>少</option><option>中</option><option>多</option></select>
    </div>
    <div class="col">
        <label>疼痛程度（0〜10）</label>
        <input type="number" id="pain" min="0" max="10">
    </div>
</div>

<div class="row">
    <div class="col"><label>症狀</label><input type="text" id="symptoms"></div>
    <div class="col">
        <label>心情</label>
        <select id="mood">
            <option>平靜</option><option>普通</option><option>難過</option>
            <option>生氣</option><option>焦慮</option>
        </select>
    </div>
    <div class="col"><label>壓力（0〜10）</label><input type="number" id="stress" min="0" max="10"></div>
    <div class="col">
        <label>睡眠</label>
        <select id="sleep"><option>好</option><option>普通</option><option>差</option></select>
    </div>
</div>

<button onclick="submitAll()">送出紀錄</button>
<button onclick="autoGenerate()">自動產生 24 個月資料（含 10 欄位）</button>

<div id="statusBox" style="margin-top:8px;font-weight:bold;">尚未送出資料</div>
</div>

<!-- ======================== 查詢區 ======================== -->
<div class="card">
<h3>資料查詢</h3>

<button onclick="queryRaw()">查詢所有資料（原始）</button>
<button onclick="queryFull()">顯示全部欄位</button>
<button onclick="showTrend()">疼痛趨勢圖（24 個月）</button>
<button onclick="showCycleTrend()">月經週期圖（24 個月）</button>

<button onclick="deleteAll()">刪除所有資料</button>

<div id="queryStatus" style="font-weight:bold;margin-top:8px;"></div>

<!-- 週期摘要 -->
<div id="cycleSummary" class="summaryCard hidden"></div>

<!-- 原始表格 -->
<div id="rawTableBox"></div>

<!-- 全欄位表格 -->
<div id="fullTableBox" class="hidden"></div>

<!-- 疼痛趨勢圖 -->
<canvas id="trendChart" class="hidden" height="120"></canvas>

<!-- 月經週期圖 -->
<canvas id="cycleChart" class="hidden" height="120"></canvas>

</div>

<!-- JS 開始 -->
<script>
const server = "https://hapi.fhir.org/baseR4";
const userName = new URLSearchParams(location.search).get("name") || "訪客";
document.getElementById("welcome").textContent = "經期觀測站（病人版 V4） - " + userName;

let patientId = null;

// -------------------- Patient 查找 --------------------
async function findOrCreatePatient(){
    let r = await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
    let d = await r.json();

    if(d.entry){
        patientId = d.entry[0].resource.id;
        return patientId;
    }

    // 建立 Patient
    let res = await fetch(`${server}/Patient`,{
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({
            resourceType:"Patient",
            name:[{text:userName}],
            identifier:[{system:"http://example.org/user", value:userName}]
        })
    });
    let x = await res.json();
    patientId = x.id;
    return patientId;
}

function obsCode(text){
    return { coding:[{system:"http://loinc.org", code:"TMP", display:text}], text:text };
}

// ======================================================
// 送出紀錄
// ======================================================
async function submitAll(){
    await findOrCreatePatient();
    let dt = startDate.value;
    if(!dt){ alert("請輸入經期開始日"); return; }

    statusBox.textContent="送出中…";

    // 刪除當天舊資料
    let old = await fetch(`${server}/Observation?subject=Patient/${patientId}&date=${dt}&_count=200`);
    let oldData = await old.json();

    if(oldData.entry){
        await Promise.all(
            oldData.entry.map(e => fetch(`${server}/Observation/${e.resource.id}`, {method:"DELETE"}))
        );
    }

    // 要送出的 10 欄位
    const list = [
        ["經期開始日",   {valueDateTime:startDate.value}],
        ["經期結束日",   {valueDateTime:endDate.value}],
        ["出血量",       {valueString:flow.value}],
        ["疼痛程度",     {valueQuantity:{value:Number(pain.value)}}],
        ["症狀",         {valueString:symptoms.value}],
        ["心情",         {valueString:mood.value}],
        ["壓力",         {valueQuantity:{value:Number(stress.value)}}],
        ["睡眠",         {valueString:sleep.value}],
        ["家屬建議",     {valueString:""}],     // 保留欄位，但由家屬頁填
        ["醫護建議",     {valueString:""}]      // 由醫護頁填
    ];

    // 一次送出 Bundle
    let bundle = {
        resourceType:"Bundle",
        type:"transaction",
        entry:[]
    };

    list.forEach(([name,val])=>{
        bundle.entry.push({
            resource:{
                resourceType:"Observation",
                status:"final",
                code:obsCode(name),
                subject:{reference:`Patient/${patientId}`},
                effectiveDateTime:dt,
                ...val
            },
            request:{method:"POST", url:"Observation"}
        });
    });

    await fetch(server,{
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify(bundle)
    });

    statusBox.textContent="送出成功！";
}

// ======================================================
// 自動產生 24 個月資料（10 欄位 + 結束日 3~6 天）
// ======================================================
async function autoGenerate(){
    await findOrCreatePatient();
    statusBox.textContent="產生中…";

    let entries=[];

    for(let i=0;i<24;i++){
        let d = new Date();
        d.setMonth(d.getMonth() + i);

        // 經期開始日：每月固定 5 號
        let start = new Date(d.getFullYear(), d.getMonth(), 5);
        let startStr = start.toISOString().substring(0,10);

        // 經期結束日：開始日 + 隨機 3~6 天
        let duration = Math.floor(Math.random()*4) + 3; // 3~6
        let end = new Date(start);
        end.setDate(end.getDate() + duration);
        let endStr = end.toISOString().substring(0,10);

        // 其他欄位（全部 10 欄）
        let flow     = ["少","中","多"][Math.floor(Math.random()*3)];
        let painVal  = Math.floor(Math.random()*10) + 1;
        let symptom  = ["腹痛","疲倦","頭痛","胃脹","痘痘"][Math.floor(Math.random()*5)];
        let moodVal  = ["平靜","普通","難過","生氣","焦慮"][Math.floor(Math.random()*5)];
        let stressV  = Math.floor(Math.random()*11);
        let sleepVal = ["好","普通","差"][Math.floor(Math.random()*3)];

        let familyNote = "（尚未填寫）";
        let doctorNote = "（尚未填寫）";

        // push 全部欄位
        const autoList = [
            ["經期開始日", {valueDateTime:startStr}],
            ["經期結束日", {valueDateTime:endStr}],
            ["出血量", {valueString:flow}],
            ["疼痛程度", {valueQuantity:{value:painVal}}],
            ["症狀", {valueString:symptom}],
            ["心情", {valueString:moodVal}],
            ["壓力", {valueQuantity:{value:stressV}}],
            ["睡眠", {valueString:sleepVal}],
            ["家屬建議", {valueString:familyNote}],
            ["醫護建議", {valueString:doctorNote}]
        ];

        autoList.forEach(([name,val])=>{
            entries.push({
                resource:{
                    resourceType:"Observation",
                    status:"final",
                    code:obsCode(name),
                    subject:{reference:`Patient/${patientId}`},
                    effectiveDateTime:startStr,
                    ...val
                },
                request:{method:"POST",url:"Observation"}
            });
        });
    }

    // 一次送出
    let bundle = {
        resourceType:"Bundle",
        type:"transaction",
        entry:entries
    };

    await fetch(server,{
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify(bundle)
    });

    statusBox.textContent="24 個月資料完成！";
}

// ======================================================
// 刪除所有資料（confirm + 只刪 TMP + 1 秒完成）
// ======================================================
async function deleteAll(){
    await findOrCreatePatient();

    if(!confirm("確定刪除所有資料？此動作無法復原！")) return;

    queryStatus.textContent = "刪除中…";

    // 只抓你建立的 TMP 資料
    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&code=TMP&_count=300`);
    let d = await r.json();

    if(d.entry){
        await Promise.all(
            d.entry.map(e => fetch(`${server}/Observation/${e.resource.id}`, { method:"DELETE" }))
        );
    }

    queryStatus.textContent = "全部刪除完成！";
}

// ======================================================
// 查詢原始資料
// ======================================================
async function queryRaw(){
    queryStatus.textContent="查詢中…";

    cycleSummary.classList.add("hidden");
    trendChart.classList.add("hidden");
    cycleChart.classList.add("hidden");
    fullTableBox.classList.add("hidden");

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let rows = (d.entry||[]).map(e=>{
        let o=e.resource;
        return `
            <tr>
                <td>${o.code.text||""}</td>
                <td>${o.effectiveDateTime||""}</td>
                <td>${o.valueString||""}</td>
                <td>${o.valueQuantity?o.valueQuantity.value:""}</td>
            </tr>`;
    }).join("");

    rawTableBox.innerHTML = `
        <table>
            <tr><th>欄位</th><th>日期</th><th>字串值</th><th>數值</th></tr>
            ${rows}
        </table>
    `;

    rawTableBox.classList.remove("hidden");
    queryStatus.textContent="查詢完成（原始）";
}

// ======================================================
// 查詢全部欄位（維持原欄位，不加週期）
// ======================================================
async function queryFull(){
    queryStatus.textContent="查詢中…";

    rawTableBox.classList.add("hidden");
    cycleSummary.classList.add("hidden");
    trendChart.classList.add("hidden");
    cycleChart.classList.add("hidden");

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let map={};

    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        let ds=o.effectiveDateTime?.substring(0,10);
        if(!ds) return;

        if(!map[ds]) map[ds]={};

        map[ds][o.code.text] = {
            s:o.valueString||"",
            n:o.valueQuantity?o.valueQuantity.value:""
        };
    });

    let rows = Object.keys(map).sort().map(date=>{
        let v=map[date];
        return `
            <tr>
                <td>${date}</td>
                <td>${v["出血量"]?.s||""}</td>
                <td>${v["疼痛程度"]?.n||""}</td>
                <td>${v["症狀"]?.s||""}</td>
                <td>${v["心情"]?.s||""}</td>
                <td>${v["壓力"]?.n||""}</td>
                <td>${v["睡眠"]?.s||""}</td>
                <td>${v["家屬建議"]?.s||""}</td>
                <td>${v["醫護建議"]?.s||""}</td>
            </tr>`;
    }).join("");

    fullTableBox.innerHTML = `
        <table>
            <tr>
                <th>日期</th><th>出血量</th><th>疼痛</th><th>症狀</th>
                <th>心情</th><th>壓力</th><th>睡眠</th>
                <th>家屬建議</th><th>醫護建議</th>
            </tr>
            ${rows}
        </table>
    `;

    fullTableBox.classList.remove("hidden");
    queryStatus.textContent="查詢完成（全部欄位）";
}

// ======================================================
// 疼痛趨勢圖（24 個月）
// ======================================================
async function showTrend(){
    rawTableBox.classList.add("hidden");
    fullTableBox.classList.add("hidden");
    cycleSummary.classList.add("hidden");
    cycleChart.classList.add("hidden");

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let painMap={};

    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        if(o.code.text==="疼痛程度" && o.valueQuantity){
            let m=o.effectiveDateTime.substring(0,7);
            painMap[m] = o.valueQuantity.value;
        }
    });

    let now = new Date();
    let labels=[];
    for(let i=0;i<24;i++){
        let m=new Date(now.getFullYear(), now.getMonth()+i, 1);
        labels.push(`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}`);
    }

    let data = labels.map(m=>painMap[m]||null);

    if(window.trendC) window.trendC.destroy();

    window.trendC = new Chart(trendChart,{
        type:"line",
        data:{
            labels:labels,
            datasets:[{
                label:"疼痛程度",
                data:data,
                borderColor:"#c94c4c",
                borderWidth:3,
                pointRadius:5,
                tension:0.3
            }]
        }
    });

    trendChart.classList.remove("hidden");
    queryStatus.textContent="已顯示疼痛趨勢圖";
}

// ======================================================
// 月經週期圖（24 個月）+ 摘要
// ======================================================
function calcCycle(startDates){
    startDates.sort();

    let cycle=[];
    for(let i=1;i<startDates.length;i++){
        let d1=new Date(startDates[i-1]);
        let d2=new Date(startDates[i]);
        cycle.push({
            month:startDates[i].substring(0,7),
            interval:Math.round((d2-d1)/86400000)
        });
    }
    return cycle;
}

function makeSummary(cycle){
    if(cycle.length===0) return "沒有足夠資料";

    let arr=cycle.map(x=>x.interval);
    let avg = (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1);
    let min = Math.min(...arr);
    let max = Math.max(...arr);
    let diff = max-min;
    let reg = diff<=3 ? "是（穩定）" : "否（波動較大）";

    return `
        <b>週期摘要</b><br>
        最近週期：${arr.join(" → ")} 天<br>
        平均週期：${avg} 天<br>
        最短週期：${min} 天<br>
        最長週期：${max} 天<br>
        是否規律：${reg}<br>
    `;
}

async function showCycleTrend(){
    rawTableBox.classList.add("hidden");
    fullTableBox.classList.add("hidden");
    trendChart.classList.add("hidden");

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let startDates=[];

    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        if(o.code.text==="經期開始日"){
            startDates.push(o.effectiveDateTime.substring(0,10));
        }
    });

    let cycle = calcCycle(startDates);

    cycleSummary.innerHTML = makeSummary(cycle);
    cycleSummary.classList.remove("hidden");

    // 固定顯示 24 個月
    let now = new Date();
    let labels=[];
    for(let i=0;i<24;i++){
        let m=new Date(now.getFullYear(), now.getMonth()+i, 1);
        labels.push(`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}`);
    }

    let data = labels.map(m=>{
        let c=cycle.find(x=>x.month===m);
        return c ? c.interval : null;
    });

    if(window.cycleC) window.cycleC.destroy();

    window.cycleC = new Chart(cycleChart,{
        type:"line",
        data:{
            labels:labels,
            datasets:[{
                label:"週期間隔（日）",
                data:data,
                borderColor:"#9b59b6",
                borderDash:[6,6],
                borderWidth:3,
                pointRadius:8,
                pointBackgroundColor:"#9b59b6",
                tension:0.15
            }]
        }
    });

    cycleChart.classList.remove("hidden");
    queryStatus.textContent="已顯示月經週期圖";
}
</script>

</body>
</html>
