<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¶“æœŸè§€æ¸¬ç«™ - HAPI æ‰‹å‹•å®Œæ•´ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{background:#f3e9dd;font-family:Arial;color:#4b3f2f;margin:0;padding:20px;}
h2{text-align:center;color:#6d4b3a;margin-bottom:10px;}
.card{background:#fffaf3;padding:18px;border-radius:12px;margin-bottom:20px;border-left:5px solid #c19a6b;}
button{width:100%;padding:14px;background:#c9a37c;color:#fff;border:none;border-radius:8px;margin-top:10px;font-size:16px;}
.row{display:flex;gap:20px;}
.col{flex:1;}
#calendarTable td{border:1px solid #e5d3c0;width:14%;height:60px;padding:3px;vertical-align:top;}
.period-day{background:#ffe5e5!important;}
</style>
</head>
<body>

<h2 id="welcome">æ­¡è¿</h2>

<div class="row">
<div class="col">
<div class="card">
<h3>ç”Ÿç†æœŸè¨˜éŒ„</h3>
<label>ç´€éŒ„æ—¥æœŸï¼ˆä¸»ç´¢å¼•ï¼‰</label>
<input type="date" id="recordDate">

<label>ç¶“æœŸé–‹å§‹æ—¥</label><input type="date" id="startDate">
<label>ç¶“æœŸçµæŸæ—¥</label><input type="date" id="endDate">

<label>å‡ºè¡€é‡</label>
<select id="flow"><option>å°‘</option><option>ä¸­</option><option>å¤š</option></select>

<label>ç–¼ç—›ç¨‹åº¦ï¼ˆ0~10ï¼‰</label>
<input type="number" id="pain" min="0" max="10">
</div>
</div>

<div class="col">
<div class="card">
<h3>ä»Šæ—¥èº«å¿ƒç—‡ç‹€</h3>
<label>å…¶ä»–ç—‡ç‹€</label><textarea id="symptoms"></textarea>

<label>å¿ƒæƒ…</label>
<select id="mood"><option>å¹³éœ</option><option>æ™®é€š</option><option>é›£é</option><option>ç”Ÿæ°£</option><option>ç„¦æ…®</option></select>

<label>å£“åŠ›æŒ‡æ•¸ï¼ˆ0~10ï¼‰</label>
<input type="number" id="stress" min="0" max="10">

<label>ç¡çœ å“è³ª</label>
<select id="sleep"><option>å¥½</option><option>æ™®é€š</option><option>å·®</option></select>
</div>
</div>
</div>

<button onclick="submitAll()">é€å‡ºç´€éŒ„</button>
<button onclick="loadAll()">è¼‰å…¥è³‡æ–™ï¼ˆæ‰‹å‹•ï¼‰</button>

<div id="statusBox" class="card">å°šæœªæ“ä½œ</div>

<div class="card">
<h3>æœˆç–¼ç—›è¶¨å‹¢</h3>
<canvas id="painChart"></canvas>
</div>

<div class="card">
<h3>æœˆæ›†</h3>
<div style="display:flex;justify-content:space-between;">
<button onclick="prevMonth()">â¬…</button>
<div id="calendarTitle"></div>
<button onclick="nextMonth()">â¡</button>
</div>
<table id="calendarTable" style="width:100%;border-collapse:collapse;"></table>
</div>

<script>
const server="https://hapi.fhir.org/baseR4";
const userName=new URLSearchParams(location.search).get("name")||"è¨ªå®¢";
document.getElementById("welcome").textContent="æ­¡è¿ï¼Œ"+userName;

// patient
let patientId=null;

async function findOrCreatePatient(){
 let r=await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
 let d=await r.json();
 if(d.entry){ patientId=d.entry[0].resource.id; return patientId; }

 let res=await fetch(`${server}/Patient`,{
  method:"POST",
  headers:{"Content-Type":"application/fhir+json"},
  body:JSON.stringify({
    resourceType:"Patient",
    name:[{text:userName}],
    identifier:[{system:"http://example.org/user",value:userName}]
  })
 });
 let x=await res.json();
 patientId=x.id; 
 return patientId;
}

function obsCode(n){ return {coding:[{system:"http://loinc.org",code:"TMP",display:n}],text:n}; }

function showStatus(t){ document.getElementById("statusBox").textContent=t; }

async function submitAll(){
 await findOrCreatePatient();

 let recordDate=document.getElementById("recordDate").value;
 if(!recordDate){ alert("è«‹é¸æ“‡ç´€éŒ„æ—¥æœŸ"); return; }

 showStatus("é€å‡ºä¸­â€¦");

 let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&date=${recordDate}`);
 let d=await r.json();
 let entries=[];

 if(d.entry){
  d.entry.forEach(e=>entries.push({request:{method:"DELETE",url:`Observation/${e.resource.id}`}}));
 }

 let list=[
  {name:"ç¶“æœŸé–‹å§‹æ—¥", val:{valueDateTime:startDate.value}},
  {name:"ç¶“æœŸçµæŸæ—¥", val:{valueDateTime:endDate.value}},
  {name:"å‡ºè¡€é‡", val:{valueString:flow.value}},
  {name:"ç–¼ç—›ç¨‹åº¦", val:{valueQuantity:{value:Number(pain.value)}}},
  {name:"å…¶ä»–ç—‡ç‹€", val:{valueString:symptoms.value}},
  {name:"å¿ƒæƒ…", val:{valueString:mood.value}},
  {name:"å£“åŠ›æŒ‡æ•¸", val:{valueQuantity:{value:Number(stress.value)}}},
  {name:"ç¡çœ å“è³ª", val:{valueString:sleep.value}}
 ];

 list.forEach(o=>{
  entries.push({
   resource:{
    resourceType:"Observation",
    status:"final",
    code:obsCode(o.name),
    subject:{reference:`Patient/${patientId}`},
    effectiveDateTime:recordDate,
    ...o.val
   },
   request:{method:"POST",url:"Observation"}
  });
 });

 await fetch(`${server}`,{
  method:"POST",
  headers:{"Content-Type":"application/fhir+json"},
  body:JSON.stringify({resourceType:"Bundle",type:"transaction",entry:entries})
 });

 showStatus("ç´€éŒ„å·²é€å‡ºï¼");
}

// æœˆæ›†
let currentMonth=new Date();

function renderCalendar(){
 const y=currentMonth.getFullYear();
 const m=currentMonth.getMonth();
 document.getElementById("calendarTitle").textContent=`${y} å¹´ ${m+1} æœˆ`;

 const first=new Date(y,m,1).getDay();
 const days=new Date(y,m+1,0).getDate();

 let html="<tr><th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr><tr>";

 for(let i=0;i<first;i++) html+="<td></td>";

 for(let d=1;d<=days;d++){
  let ds=`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
  html+=`<td id="d${ds}"><div>${d}</div></td>`;
  if((d+first)%7===0) html+="</tr><tr>";
 }
 html+="</tr>";
 document.getElementById("calendarTable").innerHTML=html;
}

function prevMonth(){ currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); }
function nextMonth(){ currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); }

async function fillCal(){
 await findOrCreatePatient();
 let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
 let d=await r.json();

 let map={};

 (d.entry||[]).forEach(e=>{
  let o=e.resource;
  let ds=o.effectiveDateTime?.substring(0,10);
  if(!ds)return;
  if(!map[ds])map[ds]={};
  if(o.code.text==="å‡ºè¡€é‡")map[ds].flow=o.valueString;
  if(o.code.text==="ç–¼ç—›ç¨‹åº¦")map[ds].pain=o.valueQuantity?.value;
 });

 for(let ds in map){
  let cell=document.getElementById("d"+ds);
  if(!cell)continue;

  if(map[ds].flow) cell.innerHTML+=`<div>ğŸ©¸${map[ds].flow}</div>`;
  let p=map[ds].pain;
  if(p>=1&&p<=3)cell.innerHTML+=`<div>ğŸ™‚å°ç—›</div>`;
  if(p>=4&&p<=6)cell.innerHTML+=`<div>ğŸ˜£ä¸­ç—›</div>`;
  if(p>=7)cell.innerHTML+=`<div>ğŸ˜«åŠ‡ç—›</div>`;
 }
}

let painChart=null;

async function loadMonthlyPain(){
 await findOrCreatePatient();
 let r1=await fetch(`${server}/Observation?subject=Patient/${patientId}&code=ç–¼ç—›ç¨‹åº¦&_count=300`);
 let d1=await r1.json();

 let dataMap={};

 (d1.entry||[]).forEach(e=>{
  let o=e.resource;
  if(!o.valueQuantity)return;
  let m=o.effectiveDateTime.substring(0,7);
  let p=o.valueQuantity.value;
  if(!dataMap[m]||p>dataMap[m])dataMap[m]=p;
 });

 let labels=Object.keys(dataMap).sort();
 let values=labels.map(m=>dataMap[m]);

 const ctx=document.getElementById("painChart");
 if(painChart)painChart.destroy();

 painChart=new Chart(ctx,{
  type:"line",
  data:{labels,datasets:[{label:"æ¯æœˆæœ€å¤§ç–¼ç—›",data:values,borderColor:"#b47f4e",borderWidth:3,tension:0.25}]}
 });
}

async function loadAll(){
 showStatus("è®€å–ä¸­â€¦");
 renderCalendar();
 await fillCal();
 await loadMonthlyPain();
 showStatus("è®€å–å®Œæˆï¼");
}
</script>

</body></html>
