<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>經期觀測站 - 趨勢析版</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    background:#f3e9dd;
    font-family:Arial;
    color:#4b3f2f;
    margin:0;
    padding:20px;
}
h2 {
    text-align:center;
    color:#6d4b3a;
    margin-bottom:10px;
}
.card {
    background:#fffaf3;
    padding:18px;
    border-radius:12px;
    margin-bottom:20px;
    border-left:5px solid #c19a6b;
}
button {
    padding:10px 20px;
    background:#c9a37c;
    color:#fff;
    border:none;
    border-radius:8px;
    margin-top:10px;
    font-size:16px;
    cursor:pointer;
}
.row { display:flex; gap:10px; }
.col { flex:1; }
label { font-weight:bold; margin-top:8px; display:block; }
input,select {
    width:100%;
    padding:6px;
    margin-top:4px;
    border-radius:6px;
    border:1px solid #d8c3a5;
    background:#fff7ef;
}
table {
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
}
th,td {
    border:1px solid #c9b8a4;
    padding:6px;
    text-align:left;
}
#cycleInfo{
    font-weight:bold;
    margin-bottom:10px;
    color:#6d4b3a;
}
</style>
</head>

<body>

<h2 id="welcome"></h2>

<!-- ====================== 上傳區 ====================== -->
<div class="card">
<h3>上傳紀錄</h3>

<div class="row">
    <div class="col">
        <label>經期開始日</label>
        <input type="date" id="startDate">
    </div>
    <div class="col">
        <label>經期結束日</label>
        <input type="date" id="endDate">
    </div>
    <div class="col">
        <label>出血量</label>
        <select id="flow">
            <option>少</option>
            <option>中</option>
            <option>多</option>
        </select>
    </div>
    <div class="col">
        <label>疼痛程度</label>
        <input type="number" id="pain" min="0" max="10">
    </div>
</div>

<div class="row">
    <div class="col">
        <label>症狀</label>
        <input type="text" id="symptoms">
    </div>
    <div class="col">
        <label>心情</label>
        <select id="mood">
            <option>平靜</option>
            <option>普通</option>
            <option>難過</option>
            <option>生氣</option>
            <option>焦慮</option>
        </select>
    </div>
    <div class="col">
        <label>壓力</label>
        <input type="number" id="stress" min="0" max="10">
    </div>
    <div class="col">
        <label>睡眠</label>
        <select id="sleep">
            <option>好</option>
            <option>普通</option>
            <option>差</option>
        </select>
    </div>
</div>

<button onclick="submitAll()">送出紀錄</button>
<div id="statusBox" style="margin-top:10px;font-weight:bold;">尚未送出</div>

<!-- ⭐ 新增按鈕（不改動原始欄位） -->
<button onclick="autoGenerate12Months()">自動產生 1~12 月資料（含家屬/醫護建議）</button>
<div id="autoGenStatus" style="margin-top:10px;font-weight:bold;color:#6d4b3a;"></div>

</div>

<!-- ====================== 查詢區 ====================== -->
<div class="card">
<h3>查詢伺服器資料</h3>
<button onclick="queryData()">查詢所有資料</button>
<div id="tableBox"></div>
</div>

<!-- ====================== 趨勢圖區 ====================== -->
<div class="card">
<h3>一年趨勢圖（出血量 + 疼痛程度）</h3>
<div id="cycleInfo">週期間隔：尚無資料</div>
<canvas id="trendChart" height="120"></canvas>
</div>

<script>
// ====================== 基本設定 ======================
const server = "https://hapi.fhir.org/baseR4";
const userName = new URLSearchParams(location.search).get("name") || "訪客";
document.getElementById("welcome").textContent = "歡迎，" + userName;

let patientId = null;

// ====================== 建立/取得 PATIENT ======================
async function findOrCreatePatient() {
    let r = await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
    let d = await r.json();

    if (d.entry) {
        patientId = d.entry[0].resource.id;
        return patientId;
    }

    let res = await fetch(`${server}/Patient`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify({
            resourceType: "Patient",
            name: [{ text: userName }],
            identifier: [{ system: "http://example.org/user", value: userName }]
        })
    });

    let x = await res.json();
    patientId = x.id;
    return patientId;
}

function encodeFlow(str) {
    return { "少": 1, "中": 2, "多": 3 }[str] || 0;
}

function obsCode(t) {
    return {
        coding: [{
            system: "http://loinc.org",
            code: "TMP",
            display: t
        }],
        text: t
    };
}

// ====================== 單筆上傳 ======================
async function submitAll() {

    await findOrCreatePatient();

    let recordDate = startDate.value;
    if (!recordDate) {
        alert("需選擇經期開始日");
        return;
    }

    document.getElementById("statusBox").textContent = "送出中…";

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&date=${recordDate}`);
    let d = await r.json();

    let entries = [];
    if (d.entry) {
        d.entry.forEach(e => {
            entries.push({
                request: { method: "DELETE", url: `Observation/${e.resource.id}` }
            });
        });
    }

    let list = [
        { name: "經期開始日", val: { valueDateTime: startDate.value } },
        { name: "經期結束日", val: { valueDateTime: endDate.value } },

        { 
            name: "出血量",
            val: { 
                valueString: flow.value,
                valueQuantity: { value: encodeFlow(flow.value) }
            }
        },

        { name: "疼痛程度", val: { valueQuantity: { value: Number(pain.value) } } },
        { name: "症狀", val: { valueString: symptoms.value } },
        { name: "心情", val: { valueString: mood.value } },
        { name: "壓力", val: { valueQuantity: { value: Number(stress.value) } } },
        { name: "睡眠", val: { valueString: sleep.value } },
    ];

    list.forEach(o => {
        entries.push({
            resource: {
                resourceType: "Observation",
                status: "final",
                code: obsCode(o.name),
                subject: { reference: `Patient/${patientId}` },
                effectiveDateTime: recordDate,
                ...o.val
            },
            request: { method: "POST", url: "Observation" }
        });
    });

    await fetch(`${server}`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify({ resourceType: "Bundle", type: "transaction", entry: entries })
    });

    document.getElementById("statusBox").textContent = "送出成功";
}

// ====================== ⭐ 自動產生 12 月資料 ======================
async function autoGenerate12Months() {

    await findOrCreatePatient();

    document.getElementById("autoGenStatus").textContent = "正在自動產生 12 個月份資料…";

    const today = new Date();
    const year = today.getFullYear();

    const template = {
        flowStr: flow.value,
        flowNum: encodeFlow(flow.value),
        painNum: Number(pain.value),
        symptomsStr: symptoms.value,
        moodStr: mood.value,
        stressNum: Number(stress.value),
        sleepStr: sleep.value,
        familyNote: "本月家屬建議：狀況良好",
        doctorNote: "本月醫護建議：持續觀察"
    };

    for (let month = 0; month < 12; month++) {

        let start = new Date(year, month, 1);
        let end = new Date(year, month, 4);

        let recordDate = start.toISOString().substring(0, 10);

        let entries = [];

        const list = [
            { name: "經期開始日", val: { valueDateTime: recordDate } },
            { name: "經期結束日", val: { valueDateTime: end.toISOString().substring(0,10) } },

            { 
                name: "出血量",
                val: { 
                    valueString: template.flowStr,
                    valueQuantity: { value: template.flowNum }
                }
            },

            { name: "疼痛程度", val: { valueQuantity: { value: template.painNum } } },
            { name: "症狀", val: { valueString: template.symptomsStr } },
            { name: "心情", val: { valueString: template.moodStr } },
            { name: "壓力", val: { valueQuantity: { value: template.stressNum } } },
            { name: "睡眠", val: { valueString: template.sleepStr } },

            // ⭐ 新增兩項（查詢顯示不受影響）
            { name: "家屬建議", val: { valueString: template.familyNote } },
            { name: "醫護建議", val: { valueString: template.doctorNote } },
        ];

        list.forEach(o => {
            entries.push({
                resource: {
                    resourceType: "Observation",
                    status: "final",
                    code: obsCode(o.name),
                    subject: { reference: `Patient/${patientId}` },
                    effectiveDateTime: recordDate,
                    ...o.val
                },
                request: { method: "POST", url: "Observation" }
            });
        });

        await fetch(`${server}`, {
            method: "POST",
            headers: { "Content-Type": "application/fhir+json" },
            body: JSON.stringify({ resourceType:"Bundle", type:"transaction", entry: entries })
        });
    }

    document.getElementById("autoGenStatus").textContent =
        "12 個月份資料已全部產生 ✔";
}


// ====================== 查詢所有資料（完全保留原始版本） ======================
async function queryData() {

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let rows = (d.entry || []).map(e => {
        let o = e.resource;
        return `
        <tr>
            <td>${o.code.text || ""}</td>
            <td>${o.effectiveDateTime || ""}</td>
            <td>${o.valueString || ""}</td>
            <td>${o.valueQuantity ? o.valueQuantity.value : ""}</td>
        </tr>`;
    }).join("");

    document.getElementById("tableBox").innerHTML = `
        <table>
            <tr><th>項目</th><th>日期</th><th>字串值</th><th>數值</th></tr>
            ${rows}
        </table>`;
}

</script>

<script>
let trendChartRef = null;

// ====================== 畫一年趨勢圖 ======================
function drawTrendChart() {

    const ctx = document.getElementById("trendChart").getContext("2d");

    if (trendChartRef) trendChartRef.destroy();

    trendChartRef = new Chart(ctx, {
        type: "line",
        data: {
            labels: window.monthLabels,
            datasets: [
                {
                    label: "出血量（1=少, 2=中, 3=多）",
                    data: window.flowData,
                    borderColor: "#d7893b",
                    backgroundColor: "rgba(215,137,59,0.2)",
                    borderWidth: 3,
                    tension: 0.3,
                    spanGaps: false
                },
                {
                    label: "疼痛程度（0~10）",
                    data: window.painData,
                    borderColor: "#c94c4c",
                    backgroundColor: "rgba(201,76,76,0.2)",
                    borderWidth: 3,
                    tension: 0.3,
                    spanGaps: false
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    ticks: { stepSize: 1 }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: "#4b3f2f",
                        font: { size: 14 }
                    }
                }
            }
        }
    });
}
</script>

</body>
</html>
