<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>ç¶“æœŸè§€æ¸¬ç«™ - ç—…äººç«¯ï¼ˆæœ€çµ‚å®Œæ•´ç‰ˆ / æ–¹æ¡ˆ Cï¼‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background: #f3e9dd;
            font-family: Arial;
            color: #4b3f2f;
            margin: 0;
            padding: 20px;
        }

        h2 {
            text-align: center;
            color: #6d4b3a;
            margin-bottom: 10px;
        }

        #welcome {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .row {
            display: flex;
            gap: 20px;
        }

        .col {
            flex: 1;
        }

        .card {
            background: #fffaf3;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #c19a6b;
            margin-bottom: 20px;
        }

        label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 9px;
            margin-top: 4px;
            margin-bottom: 12px;
            border-radius: 6px;
            border: 1px solid #d8c3a5;
            background: #fff7ef;
        }

        textarea {
            height: 60px;
        }

        .separator {
            width: 2px;
            background: #c9b8a4;
            margin: 0 10px;
            border-radius: 2px;
        }

        button {
            width: 100%;
            padding: 14px;
            margin-top: 10px;
            background: #c9a37c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }

        button:hover {
            background: #b08968;
        }

        #calendarTable td {
            border: 1px solid #e5d3c0;
            width: 14%;
            height: 60px;
            vertical-align: top;
            padding: 3px;
            position: relative;
        }

        .period-day {
            background: #ffe5e5 !important;
        }
    </style>
</head>

<body>
    <h2>ç¶“ æœŸ è§€ æ¸¬ ç«™ï¼ˆæ–¹æ¡ˆ C / æœ€çµ‚å®Œæ•´ç‰ˆï¼‰</h2>
    <div id="welcome">è³‡æ–™è®€å–ä¸­â€¦</div>

    <div class="row">
        <div class="col">
            <div class="card">
                <h3>ç”Ÿç†æœŸè¨˜éŒ„</h3>

                <label>ç¶“æœŸé–‹å§‹æ—¥</label>
                <input type="date" id="startDate">

                <label>ç¶“æœŸçµæŸæ—¥</label>
                <input type="date" id="endDate">

                <label>å‡ºè¡€é‡</label>
                <select id="flow">
                    <option>å°‘</option>
                    <option>ä¸­</option>
                    <option>å¤š</option>
                </select>

                <label>ç–¼ç—›ç¨‹åº¦ï¼ˆ0ã€œ10ï¼‰</label>
                <input type="number" id="pain" min="0" max="10">
            </div>
        </div>

        <div class="separator"></div>

        <div class="col">
            <div class="card">
                <h3>ä»Šæ—¥èº«å¿ƒç—‡ç‹€</h3>

                <label>å…¶ä»–ç—‡ç‹€</label>
                <textarea id="symptoms"></textarea>

                <label>å¿ƒæƒ…</label>
                <select id="mood">
                    <option>å¹³éœ</option>
                    <option>æ™®é€š</option>
                    <option>é›£é</option>
                    <option>ç”Ÿæ°£</option>
                    <option>ç„¦æ…®</option>
                </select>

                <label>å£“åŠ›æŒ‡æ•¸ï¼ˆ0ã€œ10ï¼‰</label>
                <input type="number" id="stress" min="0" max="10">

                <label>ç¡çœ å“è³ª</label>
                <select id="sleep">
                    <option>å¥½</option>
                    <option>æ™®é€š</option>
                    <option>å·®</option>
                </select>
            </div>
        </div>
    </div>

    <button onclick="submitAll()">é€å‡ºä»Šæ—¥ç´€éŒ„</button>
    <button onclick="generateHalfYear()">æ¸¬è©¦ç¯„ä¾‹ï¼ˆæ–¹æ¡ˆCï¼šä¸€ç­†è³‡æ–™ï¼‰</button>

    <div id="statusBox" class="card">è³‡æ–™è®€å–ä¸­â€¦</div>

    <div class="card">
        <h3>æœˆç–¼ç—›è¶¨å‹¢ï¼ˆæ¯æœˆä¸€ç­†ï¼‰</h3>
        <canvas id="painChart"></canvas>
    </div>

    <div class="card">
        <h3>ç¶“æœŸæœˆæ›†</h3>
        <div style="display:flex;justify-content:space-between;">
            <button onclick="prevMonth()">â¬… ä¸Šå€‹æœˆ</button>
            <div id="calendarTitle"></div>
            <button onclick="nextMonth()">ä¸‹å€‹æœˆ â¡</button>
        </div>
        <table id="calendarTable" style="width:100%;border-collapse:collapse;"></table>
    </div>
<!-- ============================= -->
<!--       ä¸»ç¨‹å¼ Script é–‹å§‹       -->
<!-- ============================= -->
<script>
const server = "https://hapi.fhir.org/baseR4";
const userName = new URLSearchParams(location.search).get("name") || "è¨ªå®¢";

document.getElementById("welcome").textContent =
    "æ­¡è¿ï¼Œ" + userName + "ï¼ˆè³‡æ–™è®€å–ä¸­â€¦ï¼‰";

let patientId = null;

/*==============================
  æ‰¾ç—…äºº / å»ºç«‹ç—…äºº
===============================*/
async function findOrCreatePatient() {
    let r = await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
    let d = await r.json();

    if (d.entry) {
        patientId = d.entry[0].resource.id;
        return patientId;
    }

    let res = await fetch(`${server}/Patient`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify({
            resourceType: "Patient",
            name: [{ text: userName }]
        })
    });

    let x = await res.json();
    patientId = x.id;
    return patientId;
}

function showStatus(t) {
    document.getElementById("statusBox").textContent = t;
}

/*==============================
  é€å‡ºä»Šæ—¥ç´€éŒ„ï¼ˆBundleï¼‰
===============================*/
async function submitAll() {

    document.getElementById("loadingOverlay").style.display = "flex";
    await findOrCreatePatient();
    let today = new Date().toISOString().substring(0, 10);

    showStatus("ğŸ“¤ å‚³é€ä¸­â€¦");

    // å–å¾—ä»Šæ—¥èˆŠè³‡æ–™
    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&date=${today}`);
    let d = await r.json();

    let entries = [];

    // DELETE èˆŠè³‡æ–™
    if (d.entry) {
        for (let e of d.entry) {
            entries.push({
                request: {
                    method: "DELETE",
                    url: `Observation/${e.resource.id}`
                }
            });
        }
    }

    // æ–°è³‡æ–™
    let list = [
        { code: "ç¶“æœŸé–‹å§‹æ—¥", val: { valueDateTime: startDate.value } },
        { code: "ç¶“æœŸçµæŸæ—¥", val: { valueDateTime: endDate.value } },
        { code: "å‡ºè¡€é‡", val: { valueString: flow.value } },
        { code: "ç–¼ç—›ç¨‹åº¦", val: { valueQuantity: { value: Number(pain.value) } } },
        { code: "å…¶ä»–ç—‡ç‹€", val: { valueString: symptoms.value } },
        { code: "å¿ƒæƒ…", val: { valueString: mood.value } },
        { code: "å£“åŠ›æŒ‡æ•¸", val: { valueQuantity: { value: Number(stress.value) } } },
        { code: "ç¡çœ å“è³ª", val: { valueString: sleep.value } }
    ];

    // POST æ–°è³‡æ–™ï¼ˆBundle entryï¼‰
    for (let o of list) {
        entries.push({
            resource: {
                resourceType: "Observation",
                status: "final",
                code: { text: o.code },
                subject: { reference: `Patient/${patientId}` },
                effectiveDateTime: today,
                ...o.val
            },
            request: {
                method: "POST",
                url: "Observation"
            }
        });
    }

    // Bundle ä¸€æ¬¡é€å‡º
    let bundle = {
        resourceType: "Bundle",
        type: "transaction",
        entry: entries
    };

    await fetch(`${server}`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify(bundle)
    });

    showStatus("ğŸ‰ ä»Šæ—¥è³‡æ–™å·²æ›´æ–°ï¼");
    renderCalendar();
    document.getElementById("loadingOverlay").style.display = "none";
}

/*==============================
  æœˆæ›†å‘ˆç¾
===============================*/
let currentMonth = new Date();

function renderCalendar() {
    const y = currentMonth.getFullYear();
    const m = currentMonth.getMonth();

    document.getElementById("calendarTitle").textContent =
        `${y} å¹´ ${m + 1} æœˆ`;

    const first = new Date(y, m, 1).getDay();
    const days = new Date(y, m + 1, 0).getDate();

    let html =
        "<tr><th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr><tr>";

    for (let i = 0; i < first; i++) html += "<td></td>";

    for (let d = 1; d <= days; d++) {

        let ds = `${y}-${String(m + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
        html += `<td id="d${ds}"><div>${d}</div></td>`;

        if ((d + first) % 7 === 0) html += "</tr><tr>";
    }

    html += "</tr>";

    document.getElementById("calendarTable").innerHTML = html;

    fillCal();
}

function prevMonth() {
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    renderCalendar();
}

function nextMonth() {
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    renderCalendar();
}
<!-- ============================= -->
<!--   è®€å–è³‡æ–™ â†’ å¡«å…¥æœˆæ›† fillCal()  -->
<!-- ============================= -->
async function fillCal() {

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let start = null,
        end = null,
        map = {};

    (d.entry || []).forEach(e => {

        let o = e.resource;
        let ds = o.effectiveDateTime?.substring(0, 10);
        if (!ds) return;

        if (o.code.text === "ç¶“æœŸé–‹å§‹æ—¥") start = o.valueDateTime;
        if (o.code.text === "ç¶“æœŸçµæŸæ—¥") end = o.valueDateTime;

        if (!map[ds]) map[ds] = {};

        if (o.code.text === "å‡ºè¡€é‡")
            map[ds].flow = o.valueString;

        if (o.code.text === "ç–¼ç—›ç¨‹åº¦")
            map[ds].pain = o.valueQuantity?.value;
    });

    if (start && end) {
        let sd = new Date(start),
            ed = new Date(end);

        for (let dt = new Date(sd); dt <= ed; dt.setDate(dt.getDate() + 1)) {

            let ds = dt.toISOString().substring(0, 10);
            let cell = document.getElementById("d" + ds);

            if (cell) cell.classList.add("period-day");
        }
    }

    for (let ds in map) {

        let cell = document.getElementById("d" + ds);
        if (!cell) continue;

        let f = map[ds].flow;
        let p = map[ds].pain;

        if (f)
            cell.innerHTML += `<div>ğŸ©¸${f}</div>`;

        if (p >= 1 && p <= 3)
            cell.innerHTML += `<div>ğŸ™‚å°ç—›</div>`;

        if (p >= 4 && p <= 6)
            cell.innerHTML += `<div>ğŸ˜£ä¸­ç—›</div>`;

        if (p >= 7)
            cell.innerHTML += `<div>ğŸ˜«åŠ‡ç—›</div>`;
    }
}

<!-- ============================= -->
<!--      è¶¨å‹¢åœ– loadMonthlyPain    -->
<!-- ============================= -->
let painChart = null;

async function loadMonthlyPain() {

    await findOrCreatePatient();

    let r = await fetch(
        `${server}/Observation?subject=Patient/${patientId}&code=ç–¼ç—›ç¨‹åº¦&_sort=-date`
    );

    let d = await r.json();
    let map = {};

    (d.entry || []).forEach(e => {

        let o = e.resource;
        if (!o.valueQuantity) return;

        let month = o.effectiveDateTime.substring(0, 7);

        if (!map[month]) map[month] = o.valueQuantity.value;
    });

    let labels = Object.keys(map).sort();
    let values = labels.map(m => map[m]);

    const ctx = document.getElementById("painChart");

    if (painChart) painChart.destroy();

    painChart = new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [{
                label: "æ¯æœˆç–¼ç—›ç¨‹åº¦",
                data: values,
                borderColor: "#b47f4e",
                tension: 0.3,
                borderWidth: 3
            }]
        }
    });
}

<!-- ============================= -->
<!--    æ–¹æ¡ˆ Cï¼šåŠå¹´è³‡æ–™ â†’ ä¸€ç­† Observation(JSON) -->
<!-- ============================= -->
async function generateHalfYear() {

    document.getElementById("loadingOverlay").style.display = "flex";
    await findOrCreatePatient();
    showStatus("â³ ç”¢ç”ŸåŠå¹´è³‡æ–™ä¸­â€¦");

    let today = new Date();

    let startYear = today.getFullYear();
    let startMonth = today.getMonth() - 5;
    if (startMonth < 0) { startYear -= 1; startMonth += 12; }

    let months = [];

    for (let m = 0; m < 6; m++) {

        let d = new Date(startYear, startMonth + m, 25);
        let ds = d.toISOString();

        months.push({
            date: ds,
            flow: ["å°‘","ä¸­","å¤š"][Math.floor(Math.random()*3)],
            pain: Math.floor(Math.random() * 10),
            stress: Math.floor(Math.random()*10),
            sleep: ["å¥½","æ™®é€š","å·®"][Math.floor(Math.random()*3)],
            mood: ["å¹³éœ","æ™®é€š","é›£é","ç”Ÿæ°£","ç„¦æ…®"][Math.floor(Math.random()*5)]
        });
    }

    // å„²å­˜ç‚ºä¸€ç­† Observation
    let body = {
        resourceType: "Observation",
        status: "final",
        code: { text: "åŠå¹´è³‡æ–™(JSON)" },
        subject: { reference: `Patient/${patientId}` },
        effectiveDateTime: new Date().toISOString(),
        valueString: JSON.stringify(months)
    };

    await fetch(`${server}/Observation`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify(body)
    });

    showStatus("ğŸ‰ åŠå¹´è³‡æ–™å·²å®Œæˆï¼ï¼ˆæ–¹æ¡ˆCï¼‰");
    await loadMonthlyPain();
    renderCalendar();
    document.getElementById("loadingOverlay").style.display = "none";
}

<!-- ============================= -->
<!--      è‡ªå‹•è¼‰å…¥ autoLoad()       -->
<!-- ============================= -->
async function autoLoad() {
    showStatus("è³‡æ–™è®€å–ä¸­â€¦");

    await findOrCreatePatient();
    renderCalendar();
    await fillCal();
    await loadMonthlyPain();

    showStatus("è³‡æ–™å·²æ›´æ–°ï¼");
    document.getElementById("loadingOverlay").style.display = "none";
}

autoLoad();
</script>

<!-- Loading Overlay -->
<div id="loadingOverlay"
    style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.5);color:white;font-size:32px;
    display:flex;align-items:center;justify-content:center;z-index:9999;">
    è™•ç†ä¸­â€¦
</div>

</body>
</html>
