<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ç¶“æœŸè§€æ¸¬ç«™ - ç—…äººç«¯</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        background: #f3e9dd; 
        font-family: "Arial", sans-serif;
        color: #4b3f2f;
        margin: 0;
        padding: 20px;
    }

    h2 {
        text-align: center;
        color: #6d4b3a;
        margin-bottom: 10px;
        font-size: 26px;
        letter-spacing: 2px;
    }

    #welcome {
        text-align: center;
        font-size: 18px;
        color: #5c4839;
        margin-bottom: 20px;
    }

    .card {
        background: #fffaf3;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0px 3px 6px rgba(0,0,0,0.15);
        border-left: 5px solid #c19a6b;
    }

    .card h3 {
        margin-top: 0;
        color: #6d4b3a;
        font-size: 20px;
    }

    label {
        font-weight: bold;
        color: #5c4839;
        font-size: 15px;
    }

    input, select, textarea {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #d8c3a5;
        margin-top: 6px;
        margin-bottom: 12px;
        background: #fff7ef;
        color: #4b3f2f;
    }

    textarea {
        height: 60px;
    }

    button {
        width: 100%;
        padding: 14px;
        background: #c9a37c;
        color: white;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
    }

    button:hover {
        background: #b08968;
    }

    #statusBox {
        background: #fff4e6;
        padding: 12px;
        border-radius: 8px;
        border-left: 4px solid #d39f61;
        white-space: pre-line;
        margin-top: 15px;
    }
</style>
</head>

<body>

<h2>ç¶“ æœŸ è§€ æ¸¬ ç«™</h2>
<div id="welcome">è¼‰å…¥ä¸­...</div>

<!-- ç”Ÿç†æœŸç´€éŒ„ -->
<div class="card">
    <h3>ç”Ÿç†æœŸè¨˜éŒ„</h3>

    <label>ç¶“æœŸé–‹å§‹æ—¥</label>
    <input type="date" id="startDate">

    <label>ç¶“æœŸçµæŸæ—¥</label>
    <input type="date" id="endDate">

    <label>å‡ºè¡€é‡</label>
    <select id="flow">
        <option value="å°‘">å°‘</option>
        <option value="ä¸­">ä¸­</option>
        <option value="å¤š">å¤š</option>
    </select>

    <label>ç–¼ç—›ç¨‹åº¦ï¼ˆ0 ï½ 10ï¼‰</label>
    <input type="number" id="pain" min="0" max="10">
</div>

<!-- ç—‡ç‹€ -->
<div class="card">
    <h3>å…¶ä»–ç—‡ç‹€</h3>
    <textarea id="symptoms" placeholder="ä¾‹å¦‚ï¼šè…¹ç—›ã€ç–²å€¦ã€è…¹è„¹ã€é ­ç—›ã€æƒ…ç·’ä¸ç©©â€¦"></textarea>
</div>

<!-- å¿ƒæƒ…å£“åŠ›ç¡çœ  -->
<div class="card">
    <h3>ä»Šæ—¥èº«å¿ƒç‹€æ…‹</h3>

    <label>å¿ƒæƒ…</label>
    <select id="mood">
        <option value="å¹³éœ">ğŸ™‚ å¹³éœ</option>
        <option value="æ™®é€š">ğŸ˜ æ™®é€š</option>
        <option value="é›£é">ğŸ˜ é›£é</option>
        <option value="ç”Ÿæ°£">ğŸ˜¡ ç”Ÿæ°£</option>
        <option value="ç„¦æ…®">ğŸ˜Ÿ ç„¦æ…®</option>
    </select>

    <label>å£“åŠ›æŒ‡æ•¸ï¼ˆ0 ï½ 10ï¼‰</label>
    <input type="number" id="stress" min="0" max="10">

    <label>ç¡çœ å“è³ª</label>
    <select id="sleep">
        <option value="å¥½">å¥½</option>
        <option value="æ™®é€š">æ™®é€š</option>
        <option value="å·®">å·®</option>
    </select>
</div>

<!-- é€å‡ºè³‡æ–™ -->
<button onclick="submitAll()">é€å‡ºä»Šæ—¥ç´€éŒ„</button>

<!-- éš¨æ©Ÿè³‡æ–™ -->
<button onclick="generateRandomData()">ç”¢ç”Ÿæ¸¬è©¦è³‡æ–™ï¼ˆéš¨æ©Ÿï¼‰</button>

<div id="statusBox">å°šæœªé€£ç·š</div>

<!-- åœ–è¡¨ -->
<div class="card">
    <h3>æˆ‘çš„ç¶“æœŸè¶¨å‹¢ï¼ˆæœ€è¿‘ä¸‰å€‹æœˆï¼‰</h3>
    <button onclick="loadHistory()">è¼‰å…¥æˆ‘çš„æ­·å²ç´€éŒ„</button>
    <canvas id="cycleChart" height="200"></canvas>
</div>

<script>
/* === å–å¾—ç™»å…¥å§“å === */
const urlParams = new URLSearchParams(window.location.search);
const userName = urlParams.get("name");
document.getElementById("welcome").textContent = "æ­¡è¿ï¼Œ" + userName;

/* === FHIR Server === */
const server = "https://hapi.fhir.org/baseR4";
let patientId = null;

/* é¡¯ç¤ºç‹€æ…‹ */
function showStatus(msg) {
    document.getElementById("statusBox").textContent = msg;
}

/* æŸ¥æ‰¾æˆ–å»ºç«‹ç—…äºº */
function findOrCreatePatient() {
    return fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`)
        .then(r => r.json())
        .then(data => {
            if (data.entry && data.entry.length > 0) {
                patientId = data.entry[0].resource.id;
                return patientId;
            } else {
                return createPatient();
            }
        });
}

/* å»ºç«‹ç—…äºº */
function createPatient() {
    const body = {
        resourceType: "Patient",
        name: [{ text: userName }],
        gender: "female"
    };

    return fetch(`${server}/Patient`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify(body)
    })
    .then(r => r.json())
    .then(data => data.id);
}

/* ä¸Šå‚³ä»Šæ—¥ç´€éŒ„ */
function submitAll() {
    showStatus("ğŸ”„ æ­£åœ¨è™•ç†â€¦");

    findOrCreatePatient().then(id => {
        patientId = id;

        const obsList = [];

        const add = (name, obj) => {
            obsList.push({
                resourceType: "Observation",
                status: "final",
                code: { text: name },
                subject: { reference: `Patient/${id}` },
                ...obj
            });
        };

        add("ç¶“æœŸé–‹å§‹æ—¥", { valueDateTime: startDate.value });
        add("ç¶“æœŸçµæŸæ—¥", { valueDateTime: endDate.value });
        add("å‡ºè¡€é‡", { valueString: flow.value });
        add("ç–¼ç—›ç¨‹åº¦", { valueQuantity: { value: Number(pain.value) } });
        add("å…¶ä»–ç—‡ç‹€", { valueString: symptoms.value });
        add("å¿ƒæƒ…", { valueString: mood.value });
        add("å£“åŠ›æŒ‡æ•¸", { valueQuantity: { value: Number(stress.value) } });
        add("ç¡çœ å“è³ª", { valueString: sleep.value });

        Promise.all(obsList.map(o =>
            fetch(`${server}/Observation`, {
                method: "POST",
                headers: { "Content-Type": "application/fhir+json" },
                body: JSON.stringify(o)
            })
        )).then(() => {
            showStatus("ğŸ‰ ä»Šæ—¥ç´€éŒ„å·²æˆåŠŸé€å‡ºï¼");
        });
    });
}

/* éš¨æ©Ÿè³‡æ–™ */
function generateRandomData() {
    showStatus("ğŸ› ï¸ æ­£åœ¨ç”¢ç”Ÿæ¸¬è©¦è³‡æ–™â€¦");

    findOrCreatePatient().then(id => {
        patientId = id;

        const days = Math.floor(Math.random() * 61) + 30; 
        const today = new Date();
        const tasks = [];

        for (let i = 0; i < days; i++) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const iso = d.toISOString();

            const painVal = Math.floor(Math.random() * 10);
            const flowVal = ["å°‘","ä¸­","å¤š"][Math.floor(Math.random() * 3)];
            const stressVal = Math.floor(Math.random() * 10);
            const moodVal = ["å¹³éœ","æ™®é€š","é›£é","ç”Ÿæ°£","ç„¦æ…®"][Math.floor(Math.random()*5)];

            const items = [
                { text: "ç–¼ç—›ç¨‹åº¦", obj: { valueQuantity: { value: painVal } } },
                { text: "å‡ºè¡€é‡",    obj: { valueString: flowVal } },
                { text: "å£“åŠ›æŒ‡æ•¸",  obj: { valueQuantity: { value: stressVal } } },
                { text: "å¿ƒæƒ…",      obj: { valueString: moodVal } }
            ];

            items.forEach(item => {
                tasks.push(
                    fetch(`${server}/Observation`, {
                        method: "POST",
                        headers: { "Content-Type": "application/fhir+json" },
                        body: JSON.stringify({
                            resourceType: "Observation",
                            status: "final",
                            code: { text: item.text },
                            subject: { reference: `Patient/${id}` },
                            effectiveDateTime: iso,
                            ...item.obj
                        })
                    })
                );
            });
        }

        Promise.all(tasks).then(() => {
            showStatus(`ğŸ‰ å·²æˆåŠŸç”¢ç”Ÿ ${days} å¤©çš„æ¸¬è©¦è³‡æ–™ï¼`);
        });
    });
}

/* è®€å–è³‡æ–™ â†’ ç•«åœ– */
function loadHistory() {
    if (!patientId) {
        return findOrCreatePatient().then(loadHistory);
    }

    showStatus("ğŸ“Š æ­£åœ¨è®€å–è³‡æ–™â€¦");

    fetch(`${server}/Observation?subject=Patient/${patientId}&_count=200&_sort=-date`)
        .then(r => r.json())
        .then(data => {
            const pain = [];
            const labels = [];

            (data.entry || []).forEach(e => {
                const o = e.resource;
                if (o.code.text === "ç–¼ç—›ç¨‹åº¦" && o.valueQuantity) {
                    pain.push(o.valueQuantity.value);
                    labels.push(o.effectiveDateTime || "");
                }
            });

            drawChart(labels.reverse(), pain.reverse());
            showStatus("ğŸ“ˆ è¶¨å‹¢åœ–å·²æ›´æ–°ï¼");
        });
}

let chart;
function drawChart(labels, pain) {
    const ctx = document.getElementById("cycleChart");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [{
                label: "ç–¼ç—›è¶¨å‹¢",
                data: pain,
                borderColor: "#b47f4e",
                backgroundColor: "rgba(180,127,78,0.2)",
                borderWidth: 3
            }]
        }
    });
}
</script>

</body>
</html>
