<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>經期觀測站（病人版 V2）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {background:#f3e9dd;font-family:Arial;color:#4b3f2f;margin:0;padding:20px;}
h2 {text-align:center;color:#6d4b3a;margin-bottom:15px;}
.card {
    background:#fffaf3;padding:18px;border-radius:12px;
    border-left:5px solid #c19a6b;margin-bottom:20px;
}
button {
    padding:10px 20px;background:#c9a37c;color:white;
    border:none;border-radius:8px;cursor:pointer;font-size:16px;
    margin-top:10px;
}
button:hover {opacity:0.9;}
label {font-weight:bold;margin-top:6px;display:block;}
input,select,textarea {
    width:100%;padding:6px;margin-top:4px;
    border-radius:6px;border:1px solid #d8c3a5;background:#fff7ef;
}
table {width:100%;border-collapse:collapse;margin-top:10px;}
th,td {border:1px solid #bda993;padding:6px;text-align:left;}
.hidden {display:none;}
.row {display:flex;gap:10px;}
.col {flex:1;}

.summaryCard {
    background:#f7efe3;padding:12px;border-radius:10px;
    border-left:5px solid #9b59b6;margin-top:15px;
}
</style>
</head>

<body>

<h2 id="welcome"></h2>

<!-- ======================== 上傳區 ======================== -->
<div class="card">
<h3>上傳紀錄</h3>

<div class="row">
    <div class="col"><label>經期開始日</label><input type="date" id="startDate"></div>
    <div class="col"><label>經期結束日</label><input type="date" id="endDate"></div>
    <div class="col"><label>出血量</label>
        <select id="flow"><option>少</option><option>中</option><option>多</option></select>
    </div>
    <div class="col"><label>疼痛程度（0〜10）</label>
        <input type="number" id="pain" min="0" max="10">
    </div>
</div>

<div class="row">
    <div class="col"><label>症狀</label><input type="text" id="symptoms"></div>
    <div class="col"><label>心情</label>
        <select id="mood"><option>平靜</option><option>普通</option><option>難過</option>
        <option>生氣</option><option>焦慮</option></select>
    </div>
    <div class="col"><label>壓力（0〜10）</label><input type="number" id="stress" min="0" max="10"></div>
    <div class="col"><label>睡眠</label>
        <select id="sleep"><option>好</option><option>普通</option><option>差</option></select>
    </div>
</div>

<button onclick="submitAll()">送出紀錄</button>
<button onclick="autoGenerate()">自動產生 24 個月資料</button>

<div id="statusBox" style="margin-top:8px;font-weight:bold;">尚未送出資料</div>
</div>

<!-- ======================== 查詢區 ======================== -->
<div class="card">
<h3>資料查詢</h3>

<button onclick="queryRaw()">查詢所有資料（原始表格）</button>
<button onclick="queryFull()">顯示全部欄位（合併資料）</button>
<button onclick="showTrend()">顯示疼痛趨勢圖（24 個月）</button>

<button onclick="showCycleTrend()">顯示月經週期圖（24 個月）</button>

<button onclick="deleteAll()">刪除所有資料</button>

<div id="queryStatus" style="font-weight:bold;margin-top:8px;"></div>

<div id="cycleSummary" class="summaryCard hidden"></div>

<div id="rawTableBox"></div>
<div id="fullTableBox" class="hidden"></div>

<canvas id="trendChart" class="hidden" height="120"></canvas>
<canvas id="cycleChart" class="hidden" height="120"></canvas>

</div>

<script>
const server = "https://hapi.fhir.org/baseR4";
const userName = new URLSearchParams(location.search).get("name") || "訪客";
document.getElementById("welcome").textContent = "經期觀測站（病人版） - " + userName;
let patientId = null;

async function findOrCreatePatient(){
    let r = await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
    let d = await r.json();
    if(d.entry){
        patientId = d.entry[0].resource.id;
        return patientId;
    }
    let res = await fetch(`${server}/Patient`,{
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({
            resourceType:"Patient",
            name:[{text:userName}],
            identifier:[{system:"http://example.org/user", value:userName}]
        })
    });
    let x = await res.json();
    patientId = x.id;
    return patientId;
}

function obsCode(x){
    return { coding:[{system:"http://loinc.org",code:"TMP",display:x}], text:x };
}

async function submitAll(){
    await findOrCreatePatient();
    let dt = startDate.value;
    if(!dt){ alert("請選擇經期開始日"); return; }

    statusBox.textContent="送出中…";

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&date=${dt}`);
    let d = await r.json();
    let entries=[];
    if(d.entry){
        d.entry.forEach(e=>{
            entries.push({request:{method:"DELETE",url:`Observation/${e.resource.id}`}});
        });
    }

    const list=[
        ["經期開始日",{valueDateTime:startDate.value}],
        ["經期結束日",{valueDateTime:endDate.value}],
        ["出血量",{valueString:flow.value}],
        ["疼痛程度",{valueQuantity:{value:Number(pain.value)}}],
        ["症狀",{valueString:symptoms.value}],
        ["心情",{valueString:mood.value}],
        ["壓力",{valueQuantity:{value:Number(stress.value)}}],
        ["睡眠",{valueString:sleep.value}]
    ];

    list.forEach(([name,val])=>{
        entries.push({
            resource:{
                resourceType:"Observation",status:"final",
                code:obsCode(name),subject:{reference:`Patient/${patientId}`},
                effectiveDateTime:dt,...val
            },
            request:{method:"POST",url:"Observation"}
        });
    });

    await fetch(server,{
        method:"POST",headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({resourceType:"Bundle",type:"transaction",entry:entries})
    });

    statusBox.textContent="送出成功！";
}

async function autoGenerate(){
    await findOrCreatePatient();
    statusBox.textContent = "產生中…";

    let base = new Date();
    let entries=[];

    for(let i=0;i<24;i++){
        let d = new Date(base.getFullYear(), base.getMonth()+i, 5);
        let ds = d.toISOString().substring(0,10);
        let flow = ["少","中","多"][Math.floor(Math.random()*3)];
        let pain = Math.floor(Math.random()*8)+1;

        entries.push({
            resource:{
                resourceType:"Observation",status:"final",
                code:obsCode("經期開始日"),
                subject:{reference:`Patient/${patientId}`},
                effectiveDateTime:ds,valueDateTime:ds
            },
            request:{method:"POST",url:"Observation"}
        });

        entries.push({
            resource:{
                resourceType:"Observation",status:"final",
                code:obsCode("出血量"),
                subject:{reference:`Patient/${patientId}`},
                effectiveDateTime:ds,valueString:flow
            },
            request:{method:"POST",url:"Observation"}
        });

        entries.push({
            resource:{
                resourceType:"Observation",status:"final",
                code:obsCode("疼痛程度"),
                subject:{reference:`Patient/${patientId}`},
                effectiveDateTime:ds,valueQuantity:{value:pain}
            },
            request:{method:"POST",url:"Observation"}
        });
    }

    await fetch(server,{
        method:"POST",headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({resourceType:"Bundle",type:"transaction",entry:entries})
    });

    statusBox.textContent="24 個月資料完成！";
}

async function deleteAll(){
    await findOrCreatePatient();

    if(!confirm("確定要刪除所有資料？此動作無法恢復！")) return;

    queryStatus.textContent = "刪除中…（請稍候）";

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&code=TMP&_count=200`);
    let d = await r.json();

    if(d.entry){
        await Promise.all(
            d.entry.map(e => fetch(`${server}/Observation/${e.resource.id}`, { method:"DELETE" }))
        );
    }

    queryStatus.textContent = "全部刪除完成！";
}

function calcCycle(startDates){
    startDates.sort();
    let cycle=[];
    for(let i=1;i<startDates.length;i++){
        let d1=new Date(startDates[i-1]);
        let d2=new Date(startDates[i]);
        cycle.push({
            month:startDates[i].substring(0,7),
            interval:Math.round((d2-d1)/86400000)
        });
    }
    return cycle;
}

function makeSummary(cycle){
    if(cycle.length === 0){
        return "<b>週期摘要：</b> 無經期開始日資料";
    }
    let list = cycle.map(x=>x.interval);
    let avg = (list.reduce((a,b)=>a+b,0)/list.length).toFixed(1);
    let min = Math.min(...list);
    let max = Math.max(...list);
    let diff = max-min;
    let reg = diff<=3?"是（穩定）":"否（波動較大）";

    return `
        <b>週期摘要</b><br>
        最近週期：${list.join(" → ")} 天<br>
        平均週期：${avg} 天<br>
        最短週期：${min} 天<br>
        最長週期：${max} 天<br>
        波動：±${(diff/2).toFixed(1)} 天<br>
        是否規律：${reg}
    `;
}

async function queryRaw(){
    queryStatus.textContent="查詢中…";
    cycleSummary.classList.add("hidden");
    fullTableBox.classList.add("hidden");
    trendChart.classList.add("hidden");
    cycleChart.classList.add("hidden");

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let rows = (d.entry||[]).map(e=>{
        let o=e.resource;
        return `
            <tr>
                <td>${o.code.text||""}</td>
                <td>${o.effectiveDateTime||""}</td>
                <td>${o.valueString||""}</td>
                <td>${o.valueQuantity?o.valueQuantity.value:""}</td>
            </tr>`;
    }).join("");

    rawTableBox.innerHTML =
    `<table>
        <tr><th>欄位</th><th>日期</th><th>字串值</th><th>數值</th></tr>
        ${rows}
    </table>`;

    rawTableBox.classList.remove("hidden");
    queryStatus.textContent="查詢完成（原始資料）";
}

async function queryFull(){
    queryStatus.textContent="查詢中…";
    rawTableBox.classList.add("hidden");
    trendChart.classList.add("hidden");
    cycleChart.classList.add("hidden");

    cycleSummary.classList.add("hidden");

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let map={};

    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        let date=o.effectiveDateTime?.substring(0,10);
        if(!date) return;

        if(!map[date]) map[date]={};

        map[date][o.code.text] = {
            s:o.valueString || "",
            n:o.valueQuantity?o.valueQuantity.value:""
        };
    });

    let rows =
        Object.keys(map).sort().map(date=>{
            let v = map[date];
            return `
            <tr>
                <td>${date}</td>
                <td>${v["出血量"]?.s||""}</td>
                <td>${v["疼痛程度"]?.n||""}</td>
                <td>${v["症狀"]?.s||""}</td>
                <td>${v["心情"]?.s||""}</td>
                <td>${v["壓力"]?.n||""}</td>
                <td>${v["睡眠"]?.s||""}</td>
                <td>${v["家屬建議"]?.s||""}</td>
                <td>${v["醫護建議"]?.s||""}</td>
            </tr>`;
        }).join("");

    fullTableBox.innerHTML =
    `<table>
        <tr>
            <th>日期</th><th>出血量</th><th>疼痛</th><th>症狀</th>
            <th>心情</th><th>壓力</th><th>睡眠</th>
            <th>家屬建議</th><th>醫護建議</th>
        </tr>
        ${rows}
    </table>`;

    fullTableBox.classList.remove("hidden");
    queryStatus.textContent="查詢完成（合併資料）";
}

async function showTrend(){
    rawTableBox.classList.add("hidden");
    fullTableBox.classList.add("hidden");
    cycleSummary.classList.add("hidden");
    cycleChart.classList.add("hidden");

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let painMap={};

    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        if(o.code.text==="疼痛程度" && o.valueQuantity){
            let m = o.effectiveDateTime.substring(0,7);
            painMap[m] = o.valueQuantity.value;
        }
    });

    let now = new Date();
    let labels=[];
    for(let i=0;i<24;i++){
        let m=new Date(now.getFullYear(), now.getMonth()+i, 1);
        labels.push(`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}`);
    }

    let data = labels.map(m=>painMap[m]||null);

    const ctx = trendChart;
    if(window.trendC) window.trendC.destroy();

    window.trendC = new Chart(ctx,{
        type:"line",
        data:{
            labels:labels,
            datasets:[{
                label:"疼痛程度",
                data:data,
                borderColor:"#c94c4c",
                borderWidth:3,
                pointRadius:5,
                tension:0.3
            }]
        }
    });

    trendChart.classList.remove("hidden");
    queryStatus.textContent="已顯示疼痛趨勢圖（24 個月）";
}

async function showCycleTrend(){
    rawTableBox.classList.add("hidden");
    fullTableBox.classList.add("hidden");
    trendChart.classList.add("hidden");

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let startDates=[];

    (d.entry||[]).forEach(e=>{
        let o=e.resource;
        if(o.code.text==="經期開始日"){
            startDates.push(o.effectiveDateTime.substring(0,10));
        }
    });

    let cycle = calcCycle(startDates);

    cycleSummary.innerHTML = makeSummary(cycle);
    cycleSummary.classList.remove("hidden");

    let now = new Date();
    let labels=[];
    for(let i=0;i<24;i++){
        let m=new Date(now.getFullYear(), now.getMonth()+i, 1);
        labels.push(`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}`);
    }

    let data = labels.map(m=>{
        let obj = cycle.find(x=>x.month===m);
        return obj ? obj.interval : null;
    });

    const ctx = cycleChart;
    if(window.cycleC) window.cycleC.destroy();

    window.cycleC = new Chart(ctx,{
        type:"line",
        data:{
            labels:labels,
            datasets:[{
                label:"週期間隔（日）",
                data:data,
                borderColor:"#9b59b6",
                borderDash:[6,6],
                borderWidth:3,
                pointRadius:8,
                pointBackgroundColor:"#9b59b6",
                tension:0.1
            }]
        }
    });

    cycleChart.classList.remove("hidden");
    queryStatus.textContent="已顯示月經週期圖（24 個月）";
}
</script>

</body>
</html>
