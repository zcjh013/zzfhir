<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¶“æœŸè§€æ¸¬ç«™ï¼ˆç—…äººç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* â­ èƒŒæ™¯è‰² */
body {
    background:#FAF7F2;
    font-family:Arial;
    color:#4b3f2f;
    margin:0;
    padding:20px;
}

/* â­ Header */
.top-header {
    width:100%;
    background:#5A6F68;
    color:white;
    padding:18px 28px;
    box-sizing:border-box;
}
.top-header-title {
    font-size:22px;
    font-weight:bold;
    line-height:1.3;
    white-space:pre-line;
}

/* â­ å³ä¸Šè§’ç™»å‡º */
.logout-btn {
    position:fixed;
    top:15px;
    right:15px;
    background:#888;
    padding:8px 14px;
    border-radius:8px;
    font-size:14px;
    color:white;
    cursor:pointer;
    z-index:9999;
}

h2 {
    text-align:center;
    color:#6d4b3a;
    margin-bottom:15px;
}

.card {
    background:#fffaf3;
    padding:18px;
    border-radius:12px;
    border-left:5px solid #c19a6b;
    margin-bottom:20px;
}

/* â­ é€šç”¨æŒ‰éˆ• */
button {
    padding:10px 20px;
    background:#c9a37c;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-size:16px;
    margin-top:10px;
}

label {font-weight:bold;margin-top:6px;display:block;}

input,select,textarea {
    width:100%;
    padding:6px;
    margin-top:4px;
    border-radius:6px;
    border:1px solid #d8c3a5;
    background:#fff7ef;
}

table {width:100%;border-collapse:collapse;margin-top:10px;}
th,td {border:1px solid #bda993;padding:6px;text-align:left;}
.hidden {display:none;}

/* â­â­â­ RWD æ–°æ’ç‰ˆï¼šå››æ¬„ â†’ äºŒæ¬„ â†’ å–®æ¬„ â­â­â­ */
.row {
    display:flex;
    flex-wrap:wrap;
    gap:12px;
}

.col {
    flex:1 1 calc(25% - 12px);  /* â­ å¤§è¢å¹•å››æ¬„ */
    min-width:180px;
}

/* â­ ä¸­è¢å¹•ï¼ˆå¹³æ¿ï¼‰è®ŠäºŒæ¬„ */
@media (max-width: 1000px) {
    .col {
        flex:1 1 calc(50% - 12px);
    }
}

/* â­ å°è¢å¹•ï¼ˆæ‰‹æ©Ÿï¼‰è®Šå–®æ¬„ */
@media (max-width: 600px) {
    .col {
        flex:1 1 100%;
    }
}
</style>
</head>
<body>

<!-- â­â­â­ æ·±å¢¨ç¶  Header â­â­â­ -->
<div class="top-header">
    <div class="top-header-title">
å¤§å¥åº·
FHIR
ç¶“æœŸè§€æ¸¬ç«™
    </div>
</div>

<!-- â­â­â­ å›ºå®šå³ä¸Šè§’ç™»å‡ºæŒ‰éˆ• â­â­â­ -->
<button class="logout-btn" onclick="window.location.href='index.html'">
    ç™»å‡º
</button>

<h2 id="welcome"></h2>

<h2 id="welcome"></h2>
<div id="patientIdBox" 
     style="text-align:center; margin-bottom:18px; color:#555; font-size:15px;">
</div>






<!-- ======================== ä¸Šå‚³å€ ======================== -->
<div class="card">
<h3>ä¸Šå‚³ç´€éŒ„</h3>

<!-- â­ å››æ¬„ â†’ äºŒæ¬„ â†’ ä¸€æ¬„ RWD -->
<div class="row">

    <div class="col">
        <label>ç¶“æœŸé–‹å§‹æ—¥</label>
        <input type="date" id="startDate">
    </div>

    <div class="col">
        <label>ç¶“æœŸçµæŸæ—¥</label>
        <input type="date" id="endDate">
    </div>

    <div class="col">
        <label>å‡ºè¡€é‡</label>
        <select id="flow">
            <option>å°‘</option><option>ä¸­</option><option>å¤š</option>
        </select>
    </div>

    <div class="col">
        <label>ç–¼ç—›ç¨‹åº¦ï¼ˆ0ã€œ10ï¼‰</label>
        <input type="number" id="pain" min="0" max="10">
    </div>

</div>

<!-- â­ ç¬¬äºŒåˆ—ï¼šåŒæ¨£å››æ¬„ RWD -->
<div class="row">

    <div class="col">
        <label>ç—‡ç‹€</label>
        <input type="text" id="symptoms">
    </div>

    <div class="col">
        <label>å¿ƒæƒ…</label>
        <select id="mood">
            <option>å¹³éœ</option><option>æ™®é€š</option>
            <option>é›£é</option><option>ç”Ÿæ°£</option><option>ç„¦æ…®</option>
        </select>
    </div>

    <div class="col">
        <label>å£“åŠ›ï¼ˆ0ã€œ10ï¼‰</label>
        <input type="number" id="stress" min="0" max="10">
    </div>

    <div class="col">
        <label>ç¡çœ </label>
        <select id="sleep">
            <option>å¥½</option><option>æ™®é€š</option><option>å·®</option>
        </select>
    </div>

</div>

<button onclick="submitAll()">é€å‡ºç´€éŒ„</button>
<div id="statusBox" style="margin-top:8px;font-weight:bold;">å°šæœªé€å‡ºè³‡æ–™</div>

<!-- â­ è‡ªå‹•ç”¢ç”Ÿè³‡æ–™ -->
<button onclick="autoGenerate24Months()">è‡ªå‹•ç”¢ç”Ÿ 24 å€‹æœˆä»½è³‡æ–™ï¼ˆå«é€±æœŸæ€§ç–¼ç—›ï¼‰</button>
<div id="autoGenStatus" style="margin-top:8px;font-weight:bold;color:#6d4b3a;"></div>

</div>
<!-- ======================== è³‡æ–™æŸ¥è©¢ ======================== -->
<div class="card">
<h3>è³‡æ–™æŸ¥è©¢</h3>

<!-- â­ æŸ¥è©¢æŒ‰éˆ•åˆ—ï¼šRWD è‡ªå‹•æ›è¡Œ -->
<div style="display:flex; flex-wrap:wrap; gap:10px;">

    <button onclick="queryRaw()">æŸ¥è©¢æ‰€æœ‰è³‡æ–™ï¼ˆåŸå§‹è¡¨æ ¼ï¼‰</button>

    <button onclick="queryFull()">é¡¯ç¤ºå…¨éƒ¨æ¬„ä½ï¼ˆåˆä½µç‰ˆæœ¬ï¼‰</button>

    <button onclick="showTrend()">é¡¯ç¤ºç–¼ç—›è¶¨å‹¢åœ–ï¼ˆ24 å€‹æœˆï¼‰</button>

    <button onclick="deleteAll()">åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼ˆé‡è¨­æ¸¬è©¦ï¼‰</button>

    <button onclick="showCycleSummary()">é¡¯ç¤ºæœˆç¶“é€±æœŸæ‘˜è¦</button>

</div>

<div id="queryStatus" style="font-weight:bold;margin-top:8px;"></div>

<!-- â­ é€±æœŸæ‘˜è¦é¡¯ç¤ºå€ -->
<div id="cycleSummaryBox" class="hidden"
     style="margin-top:15px;padding:15px;background:#fff7ef;border-radius:8px;border:2px solid #c19a6b;">
     
    <h4 style="color:#6d4b3a;margin-top:0;">æœˆç¶“é€±æœŸæ‘˜è¦</h4>
    <div id="cycleStats" style="margin-bottom:15px;"></div>
    <canvas id="cycleChart" height="150"></canvas>
</div>

<div id="rawTableBox"></div>
<div id="fullTableBox" class="hidden"></div>
<canvas id="trendChart" class="hidden" height="120"></canvas>

</div>
<script>
/* ======================== åŸºæœ¬è¨­å®š ======================== */
const server = "https://hapi.fhir.org/baseR4";  /* â­ ä¼ºæœå™¨ä¸å‹• */
const userName = new URLSearchParams(location.search).get("name") || "è¨ªå®¢";

document.getElementById("welcome").textContent =
    "ç¶“æœŸè§€æ¸¬ç«™ï¼ˆç—…äººç‰ˆï¼‰ - " + userName;

let patientId = null;

/* â­ åœ¨æ¨™é¡Œä¸‹é¢é¡¯ç¤º Patient ID */
function showPatientId(id){
    const box = document.getElementById("patientIdBox");
    if (box) box.textContent = "FHIR ç—…æ‚£ IDï¼š" + id;
}

/* â­ findOrCreatePatientï¼ˆåŸåŠŸèƒ½ä¿ç•™ï¼ŒåªåŠ ä¸Šé¡¯ç¤º IDï¼‰ */
async function findOrCreatePatient(){
    let r = await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
    let d = await r.json();

    /* è‹¥å­˜åœ¨ â†’ å–å› ID */
    if (d.entry){
        patientId = d.entry[0].resource.id;
        showPatientId(patientId);
        return patientId;
    }

    /* è‹¥ä¸å­˜åœ¨ â†’ å»ºç«‹æ–° Patient */
    let res = await fetch(`${server}/Patient`,{
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({
            resourceType:"Patient",
            name:[{text:userName}],
            identifier:[{system:"http://example.org/user", value:userName}]
        })
    });

    let x = await res.json();
    patientId = x.id;

    showPatientId(patientId);
    return patientId;
}

/* â­ observation code åŒ…è£å‡½å¼ï¼ˆä¿æŒä¸è®Šï¼‰ */
function obsCode(txt){ 
    return {
        coding:[{
            system:"http://loinc.org",
            code:"TMP",
            display:txt
        }],
        text:txt
    };
}

</script>
<script>
/* ======================== é€±æœŸæ€§ç–¼ç—›é¿å… 0 ======================== */
function generateCyclicPain(monthIndex){
    const m = monthIndex % 3;
    if (m === 0) return Math.floor(Math.random() * 5) + 6;
    if (m === 1) return Math.floor(Math.random() * 5) + 3;
    return Math.floor(Math.random() * 4) + 1;
}

/* ======================== è‡ªå‹•ç”¢ç”Ÿ 24 å€‹æœˆ ======================== */
async function autoGenerate24Months(){
    await findOrCreatePatient();

    const status = document.getElementById("autoGenStatus");
    status.textContent = "ç”¢ç”Ÿ 24 å€‹æœˆä»½è³‡æ–™ä¸­â€¦";

    const current = new Date();
    const startYear = current.getFullYear();
    const startMonth = current.getMonth();

    /* ä½¿ç”¨è€…æœ€è¿‘ä¸€æ¬¡è¼¸å…¥ä½œç‚ºæ¨¡æ¿ */
    const tpl = {
        flow: flow.value,
        sym: symptoms.value,
        mood: mood.value,
        stress: Number(stress.value),
        sleep: sleep.value,
        family: "å®¶å±¬å»ºè­°ï¼šç‹€æ³è‰¯å¥½",
        doctor: "é†«è­·å»ºè­°ï¼šè«‹æŒçºŒè§€å¯Ÿ"
    };

    /* ä¸€æ¬¡è·‘ 24 å€‹æœˆä»½ */
    for (let i = 0; i < 24; i++){
        let d = new Date(startYear, startMonth + i, 1);
        let end = new Date(startYear, startMonth + i, 4);

        let dateStr = d.toISOString().substring(0, 10);
        let endStr  = end.toISOString().substring(0, 10);

        /* å…ˆæŸ¥è©¢ç•¶æœˆæ—¢æœ‰è³‡æ–™ â†’ è‹¥æœ‰ï¼Œæ¸…é™¤ */
        let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&date=${dateStr}`);
        let prev = await r.json();

        let entries = [];

        if (prev.entry){
            prev.entry.forEach(e => {
                entries.push({
                    request:{ method:"DELETE", url:`Observation/${e.resource.id}` }
                });
            });
        }

        /* æ–°å¢ 10 ç­† Observation */
        let list = [
            { name:"ç¶“æœŸé–‹å§‹æ—¥", v:{ valueDateTime:dateStr }},
            { name:"ç¶“æœŸçµæŸæ—¥", v:{ valueDateTime:endStr }},
            { name:"å‡ºè¡€é‡", v:{ valueString:tpl.flow }},
            { name:"ç–¼ç—›ç¨‹åº¦", v:{ valueQuantity:{ value:generateCyclicPain(i) }}},
            { name:"ç—‡ç‹€", v:{ valueString:tpl.sym }},
            { name:"å¿ƒæƒ…", v:{ valueString:tpl.mood }},
            { name:"å£“åŠ›", v:{ valueQuantity:{ value:tpl.stress }}},
            { name:"ç¡çœ ", v:{ valueString:tpl.sleep }},
            { name:"å®¶å±¬å»ºè­°", v:{ valueString:tpl.family }},
            { name:"é†«è­·å»ºè­°", v:{ valueString:tpl.doctor }}
        ];

        list.forEach(o => {
            entries.push({
                resource:{
                    resourceType:"Observation",
                    status:"final",
                    code: obsCode(o.name),
                    subject:{ reference:`Patient/${patientId}` },
                    effectiveDateTime: dateStr,
                    ...o.v
                },
                request:{ method:"POST", url:"Observation" }
            });
        });

        /* Transaction Bundle å¯«å…¥ FHIR */
        await fetch(server, {
            method:"POST",
            headers:{ "Content-Type":"application/fhir+json" },
            body:JSON.stringify({
                resourceType:"Bundle",
                type:"transaction",
                entry: entries
            })
        });
    }

    status.textContent = "24 å€‹æœˆä»½è³‡æ–™å·²å…¨éƒ¨å»ºç«‹ âœ”";
}
</script>
<script>
/* ======================== åˆªé™¤è³‡æ–™ ======================== */
async function deleteAll(){
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) return;

    await findOrCreatePatient();

    /* æŸ¥è©¢æ‰€æœ‰è©²ç—…äºº Observation */
    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=1000`);
    let d = await r.json();

    if (!d.entry || d.entry.length === 0){
        alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯åˆªé™¤ã€‚");
        return;
    }

    /* è½‰ç‚º DELETE Transaction */
    let entries = d.entry.map(e => ({
        request:{
            method:"DELETE",
            url:`Observation/${e.resource.id}`
        }
    }));

    /* é€å‡º Transaction Bundle */
    await fetch(server, {
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({
            resourceType:"Bundle",
            type:"transaction",
            entry: entries
        })
    });

    alert("æ‰€æœ‰è³‡æ–™å·²åˆªé™¤ï¼");
}
</script>
<script>
/* ======================== é€å‡ºç´€éŒ„ ======================== */
async function submitAll(){

    await findOrCreatePatient();

    let recordDate = startDate.value;
    if (!recordDate){
        alert("è«‹é¸æ“‡ç¶“æœŸé–‹å§‹æ—¥");
        return;
    }

    document.getElementById("statusBox").textContent = "é€å‡ºä¸­â€¦";

    /* æŸ¥è©¢åŒæ—¥æœŸæ˜¯å¦å·²æœ‰è³‡æ–™ â†’ è‹¥æœ‰å‰‡åˆªé™¤ */
    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&date=${recordDate}`);
    let d = await r.json();

    let entries = [];

    /* åˆªé™¤èˆŠè³‡æ–™ */
    if (d.entry){
        d.entry.forEach(e=>{
            entries.push({
                request:{
                    method:"DELETE",
                    url:`Observation/${e.resource.id}`
                }
            });
        });
    }

    /* è¦ä¸Šå‚³çš„ Observation è³‡æ–™ */
    let list = [
        { name:"ç¶“æœŸé–‹å§‹æ—¥", v:{ valueDateTime:startDate.value }},
        { name:"ç¶“æœŸçµæŸæ—¥", v:{ valueDateTime:endDate.value }},
        { name:"å‡ºè¡€é‡",     v:{ valueString:flow.value }},
        { name:"ç–¼ç—›ç¨‹åº¦",   v:{ valueQuantity:{ value:Number(pain.value) }}},
        { name:"ç—‡ç‹€",       v:{ valueString:symptoms.value }},
        { name:"å¿ƒæƒ…",       v:{ valueString:mood.value }},
        { name:"å£“åŠ›",       v:{ valueQuantity:{ value:Number(stress.value) }}},
        { name:"ç¡çœ ",       v:{ valueString:sleep.value }}
    ];

    /* POST æ–°ç´€éŒ„ */
    list.forEach(o=>{
        entries.push({
            resource:{
                resourceType:"Observation",
                status:"final",
                code: obsCode(o.name),
                subject:{ reference:`Patient/${patientId}` },
                effectiveDateTime: recordDate,
                ...o.v
            },
            request:{
                method:"POST",
                url:"Observation"
            }
        });
    });

    /* Transaction Bundle ä¸Šå‚³ */
    await fetch(server, {
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({
            resourceType:"Bundle",
            type:"transaction",
            entry: entries
        })
    });

    document.getElementById("statusBox").textContent = "é€å‡ºæˆåŠŸï¼";
}
</script>
<script>
/* ======================== æŸ¥è©¢åŸå§‹ç‰ˆ ======================== */
async function queryRaw(){

    document.getElementById("queryStatus").textContent = "æŸ¥è©¢ä¸­â€¦";

    /* éš±è—å…¶ä»–å€å¡Š */
    trendChart.classList.add("hidden");
    fullTableBox.classList.add("hidden");

    await findOrCreatePatient();

    /* æŸ¥è©¢æ‰€æœ‰ Observation */
    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    /* çµ„ HTML è¡¨æ ¼åˆ— */
    let rows = (d.entry || []).map(e=>{
        let o = e.resource;
        return `
            <tr>
                <td>${o.code.text || ""}</td>
                <td>${o.effectiveDateTime || ""}</td>
                <td>${o.valueString || ""}</td>
                <td>${o.valueQuantity ? o.valueQuantity.value : ""}</td>
            </tr>
        `;
    }).join("");

    /* è¼¸å‡ºè¡¨æ ¼ */
    rawTableBox.innerHTML = `
        <table>
            <tr>
                <th>æ¬„ä½</th>
                <th>æ—¥æœŸ</th>
                <th>å­—ä¸²å€¼</th>
                <th>æ•¸å€¼</th>
            </tr>
            ${rows}
        </table>
    `;

    rawTableBox.classList.remove("hidden");
    document.getElementById("queryStatus").textContent = "æŸ¥è©¢å®Œæˆï¼ˆåŸå§‹ç‰ˆï¼‰";
}
</script>
<script>
/* ======================== æŸ¥è©¢å…¨éƒ¨æ¬„ä½ ======================== */
async function queryFull(){

    document.getElementById("queryStatus").textContent = "æŸ¥è©¢ä¸­â€¦";

    /* éš±è—å…¶ä»–é¡¯ç¤ºå€åŸŸ */
    rawTableBox.classList.add("hidden");
    trendChart.classList.add("hidden");

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let d = await r.json();

    let map = {};   // { "2025-01-03": { "å‡ºè¡€é‡":{s:"ä¸­"}, "ç–¼ç—›ç¨‹åº¦":{n:5}, ... } }

    /* ä¾æ—¥æœŸå½™æ•´æ‰€æœ‰æ¬„ä½ */
    (d.entry || []).forEach(e => {
        let o = e.resource;
        let date = o.effectiveDateTime?.substring(0,10);
        if (!date) return;

        if (!map[date]) map[date] = {};

        map[date][o.code.text] = {
            s: o.valueString || "",
            n: o.valueQuantity ? o.valueQuantity.value : ""
        };
    });

    /* çµ„åˆ HTML è¡¨æ ¼åˆ— */
    let rows = Object.keys(map).sort().map(date => {
        let v = map[date];
        return `
            <tr>
                <td>${date}</td>
                <td>${v["å‡ºè¡€é‡"]?.s || ""}</td>
                <td>${v["ç–¼ç—›ç¨‹åº¦"]?.n || ""}</td>
                <td>${v["ç—‡ç‹€"]?.s || ""}</td>
                <td>${v["å¿ƒæƒ…"]?.s || ""}</td>
                <td>${v["å£“åŠ›"]?.n || ""}</td>
                <td>${v["ç¡çœ "]?.s || ""}</td>
                <td>${v["å®¶å±¬å»ºè­°"]?.s || ""}</td>
                <td>${v["é†«è­·å»ºè­°"]?.s || ""}</td>
            </tr>
        `;
    }).join("");

    /* è¼¸å‡ºè¡¨æ ¼ */
    fullTableBox.innerHTML = `
        <table>
            <tr>
                <th>æ—¥æœŸ</th>
                <th>å‡ºè¡€é‡</th>
                <th>ç–¼ç—›</th>
                <th>ç—‡ç‹€</th>
                <th>å¿ƒæƒ…</th>
                <th>å£“åŠ›</th>
                <th>ç¡çœ </th>
                <th>å®¶å±¬å»ºè­°</th>
                <th>é†«è­·å»ºè­°</th>
            </tr>
            ${rows}
        </table>
    `;

    fullTableBox.classList.remove("hidden");
    document.getElementById("queryStatus").textContent = "å®Œæˆï¼ˆå…¨éƒ¨æ¬„ä½ï¼‰";
}
</script>
<script>
/* ======================== è¶¨å‹¢åœ– ======================== */
async function showTrend(){

    /* éš±è—å…¶ä»–å€å¡Š */
    rawTableBox.classList.add("hidden");
    fullTableBox.classList.add("hidden");

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=1000`);
    let d = await r.json();

    let painMap = {};  
    // painMap["2025-01"] = 5

    /* æ•´ç†ç–¼ç—›ç¨‹åº¦è³‡æ–™ï¼ˆæŒ‰æœˆä»½ï¼‰ */
    (d.entry || []).forEach(e => {
        let o = e.resource;
        let ds = o.effectiveDateTime;
        if (!ds) return;

        let month = ds.substring(0, 7); // "YYYY-MM"

        if (o.code.text === "ç–¼ç—›ç¨‹åº¦" && o.valueQuantity)
            painMap[month] = o.valueQuantity.value;
    });

    /* ç”Ÿæˆæœªä¾† 24 å€‹æœˆæ¨™ç±¤ */
    let current = new Date();
    let startYear = current.getFullYear();
    let startMonth = current.getMonth();

    let labels = [];  
    for (let i = 0; i < 24; i++){
        let d = new Date(startYear, startMonth + i, 1);
        labels.push(d.toISOString().substring(0, 7));
    }

    /* å°‡æœˆä»½å°æ‡‰ç–¼ç—›ç¨‹åº¦ */
    let painData = labels.map(m => painMap[m] || null);

    const ctx = document.getElementById("trendChart");

    if (window.trc) window.trc.destroy();  // é¿å…é‡ç–Š

    /* ç¹ªè£½æŠ˜ç·šåœ– */
    window.trc = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "ç–¼ç—›ç¨‹åº¦ï¼ˆ24 å€‹æœˆï¼‰",
                data: painData,
                borderColor: "#c94c4c",
                borderWidth: 3,
                tension: 0.3,
                pointRadius: 5
            }]
        }
    });

    trendChart.classList.remove("hidden");
    document.getElementById("queryStatus").textContent = "å·²é¡¯ç¤º 24 å€‹æœˆè¶¨å‹¢åœ–";
}
</script>
<script>
/* ======================== æœˆç¶“é€±æœŸæ‘˜è¦ ======================== */
async function showCycleSummary(){

    document.getElementById("queryStatus").textContent = "è¨ˆç®—é€±æœŸæ‘˜è¦ä¸­â€¦";

    /* éš±è—å…¶ä»–å€å¡Š */
    rawTableBox.classList.add("hidden");
    fullTableBox.classList.add("hidden");
    trendChart.classList.add("hidden");

    await findOrCreatePatient();

    let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=1000`);
    let d = await r.json();

    let startDates = [];

    /* æ”¶é›†ã€Œç¶“æœŸé–‹å§‹æ—¥ã€ */
    (d.entry || []).forEach(e => {
        let o = e.resource;
        if (o.code.text === "ç¶“æœŸé–‹å§‹æ—¥" && o.valueDateTime) {
            startDates.push(o.valueDateTime.substring(0, 10)); // YYYY-MM-DD
        }
    });

    if (startDates.length < 2){
        alert("è³‡æ–™ä¸è¶³ï¼Œè‡³å°‘éœ€è¦å…©ç­†ç¶“æœŸè¨˜éŒ„æ‰èƒ½è¨ˆç®—é€±æœŸï¼");
        return;
    }

    /* æ’åºæ—¥æœŸ */
    startDates.sort();

    /* è¨ˆç®—å‘¨æœŸé–“éš”ï¼ˆå¤©æ•¸ï¼‰*/
    let intervals = [];
    for (let i = 1; i < startDates.length; i++){
        let d1 = new Date(startDates[i - 1]);
        let d2 = new Date(startDates[i]);
        intervals.push(Math.round((d2 - d1) / (24 * 60 * 60 * 1000)));
    }

    /* çµ±è¨ˆè³‡æ–™ */
    let avgCycle = Math.round(intervals.reduce((a, b) => a + b, 0) / intervals.length);
    let minCycle = Math.min(...intervals);
    let maxCycle = Math.max(...intervals);
    let isNormal = avgCycle >= 21 && avgCycle <= 35;

    /* ç‹€æ…‹é¡¯ç¤º */
    let normalText = isNormal ? "âœ” æ­£å¸¸" : "âš  å»ºè­°è«®è©¢é†«ç”Ÿ";
    let normalColor = isNormal ? "#4a7c59" : "#c94c4c";

    /* é¡¯ç¤ºé€±æœŸæ‘˜è¦ HTML */
    document.getElementById("cycleStats").innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div style="padding:10px;background:#fffbf5;border-radius:6px;">
                <strong>å¹³å‡é€±æœŸï¼š</strong>${avgCycle} å¤©
            </div>
            <div style="padding:10px;background:#fffbf5;border-radius:6px;">
                <strong>è¨˜éŒ„æ¬¡æ•¸ï¼š</strong>${startDates.length} æ¬¡
            </div>
            <div style="padding:10px;background:#fffbf5;border-radius:6px;">
                <strong>é€±æœŸç¯„åœï¼š</strong>${minCycle} - ${maxCycle} å¤©
            </div>
            <div style="padding:10px;background:#fffbf5;border-radius:6px;color:${normalColor};">
                <strong>ç‹€æ…‹ï¼š</strong>${normalText}
            </div>
        </div>

        <div style="margin-top:10px;padding:8px;background:#f5f1e8;border-radius:6px;font-size:14px;">
            ğŸ’¡ æ­£å¸¸æœˆç¶“é€±æœŸç¯„åœç‚º 21-35 å¤©ï¼Œå¹³å‡ç´„ 28 å¤©
        </div>
    `;

    /* ç”Ÿæˆåœ–è¡¨æ¨™ç±¤ */
    let labels = intervals.map((_, i) => `é€±æœŸ ${i + 1}`);

    const ctx = document.getElementById("cycleChart");
    if (window.cycleChartInstance) window.cycleChartInstance.destroy();

    /* ç¹ªè£½é€±æœŸé•·åº¦æŸ±ç‹€åœ– */
    window.cycleChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "é€±æœŸé–“éš”ï¼ˆå¤©æ•¸ï¼‰",
                data: intervals,
                backgroundColor: intervals.map(v =>
                    (v >= 21 && v <= 35) ? "rgba(74,124,89,0.7)" : "rgba(201,76,76,0.7)"
                ),
                borderColor: intervals.map(v =>
                    (v >= 21 && v <= 35) ? "#4a7c59" : "#c94c4c"
                ),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: true }},
            scales: {
                y: { beginAtZero: true, title: { display: true, text: "å¤©æ•¸" }}
            }
        }
    });

    /* é¡¯ç¤ºæ‘˜è¦å€å¡Š */
    document.getElementById("cycleSummaryBox").classList.remove("hidden");
    document.getElementById("queryStatus").textContent = "æœˆç¶“é€±æœŸæ‘˜è¦å·²é¡¯ç¤º";
}
</script>
