<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>經期觀測站 - Firely 最終完整版（含 category）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h2>Firely 最終完整版（含 Observation.category）</h2>

<script>
const server = "https://server.fire.ly/r4";
const userName = new URLSearchParams(location.search).get("name") || "訪客";
let patientId = null;

function obsCode(name){
 return {
   coding:[{system:"http://loinc.org",code:"TMP",display:name}],
   text:name
 };
}

function obsCategory(){
 return [{
   coding:[{
     system:"http://terminology.hl7.org/CodeSystem/observation-category",
     code:"vital-signs",
     display:"Vital Signs"
   }]
 }];
}

async function findOrCreatePatient(){
 let r=await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
 let d=await r.json();
 if(d.entry){patientId=d.entry[0].resource.id;return;}
 let res=await fetch(`${server}/Patient`,{
  method:"POST",
  headers:{"Content-Type":"application/fhir+json"},
  body:JSON.stringify({
    resourceType:"Patient",
    name:[{text:userName}],
    identifier:[{system:"http://example.org/pid",value:userName}]
  })
 });
 let x=await res.json();
 patientId=x.id;
}

async function generateHalfYear(){
 await findOrCreatePatient();
 let arr=[];
 for(let m=0;m<6;m++){
   let d=new Date(); d.setMonth(d.getMonth()-m);
   arr.push({date:d.toISOString(),pain:5});
 }
 await fetch(`${server}/Observation`,{
   method:"POST",
   headers:{"Content-Type":"application/fhir+json"},
   body:JSON.stringify({
     resourceType:"Observation",
     status:"final",
     category:obsCategory(),
     code:obsCode("半年資料(JSON)"),
     subject:{reference:`Patient/${patientId}`},
     effectiveDateTime:new Date().toISOString(),
     valueString:JSON.stringify(arr)
   })
 });
 alert("半年資料已送出（Firely 應可接受）");
}
</script>

<button onclick="generateHalfYear()">測試半年資料（Firely OK）</button>

</body>
</html>
