<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¶“æœŸè§€æ¸¬ç«™ - HAPI æœ€çµ‚å®Œæ•´ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h2>ç¶“æœŸè§€æ¸¬ç«™ï¼ˆHAPI ç°¡åŒ–ç‰ˆæœ¬ï¼‰</h2>
<p>æ­¤ç‚ºæœ€çµ‚å¯é‹ä½œä¹‹ HAPI ç‰ˆæœ¬ï¼ˆç°¡åŒ–å¯ç”¨ï¼‰ã€‚</p>
<script>
const server="https://hapi.fhir.org/baseR4";
const userName="æ¸¬è©¦ç”¨";
console.log("HAPI Ready");
</script>
</body>
</html>

<!-- SEGMENT 1 START -->
<style>
body {background:#f3e9dd;font-family:Arial;color:#4b3f2f;margin:0;padding:20px;}
h2{text-align:center;color:#6d4b3a;margin-bottom:10px;}
.row{display:flex;gap:20px;}
.col{flex:1;}
.card{background:#fffaf3;padding:18px;border-radius:12px;
box-shadow:0 3px 6px rgba(0,0,0,0.1);border-left:5px solid #c19a6b;margin-bottom:20px;}
button{width:100%;padding:14px;margin-top:10px;background:#c9a37c;color:white;
border:none;border-radius:8px;font-size:16px;}
</style>

<div class="row">
<div class="col">
<div class="card">
<h3>ç”Ÿç†æœŸè¨˜éŒ„</h3>
<label>ç¶“æœŸé–‹å§‹æ—¥</label><input type="date" id="startDate">
<label>ç¶“æœŸçµæŸæ—¥</label><input type="date" id="endDate">
<label>å‡ºè¡€é‡</label>
<select id="flow"><option>å°‘</option><option>ä¸­</option><option>å¤š</option></select>
<label>ç–¼ç—›ç¨‹åº¦ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="pain" min="0" max="10">
</div></div>

<div class="col">
<div class="card">
<h3>ä»Šæ—¥èº«å¿ƒç—‡ç‹€</h3>
<label>å…¶ä»–ç—‡ç‹€</label><textarea id="symptoms"></textarea>
<label>å¿ƒæƒ…</label>
<select id="mood"><option>å¹³éœ</option><option>æ™®é€š</option><option>é›£é</option><option>ç”Ÿæ°£</option><option>ç„¦æ…®</option></select>
<label>å£“åŠ›æŒ‡æ•¸ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="stress" min="0" max="10">
<label>ç¡çœ å“è³ª</label>
<select id="sleep"><option>å¥½</option><option>æ™®é€š</option><option>å·®</option></select>
</div></div>
</div>

<button onclick="submitAll()">é€å‡ºç´€éŒ„</button>
<!-- SEGMENT 1 END -->

<!-- SEGMENT 2 START -->
<div class="card">
<h3>æœˆç–¼ç—›è¶¨å‹¢ï¼ˆæœ€å¤§ç–¼ç—›å€¼ï¼‰</h3>
<canvas id="painChart"></canvas>
</div>

<div class="card">
<h3>ç¶“æœŸæœˆæ›†</h3>
<div style="display:flex;justify-content:space-between;">
<button onclick="prevMonth()">â¬… ä¸Šå€‹æœˆ</button>
<div id="calendarTitle"></div>
<button onclick="nextMonth()">ä¸‹å€‹æœˆ â¡</button>
</div>
<table id="calendarTable" style="width:100%;border-collapse:collapse;"></table>
</div>

<style>
#calendarTable td{border:1px solid #e5d3c0;width:14%;height:60px;vertical-align:top;padding:3px;}
.period-day{background:#ffe5e5 !important;}
</style>
<!-- SEGMENT 2 END -->

<!-- SEGMENT 3 START: Core JS (HAPI version) -->
<script>
// === HAPI FHIR ä¼ºæœå™¨ (ç„¡ CORS é™åˆ¶) ===
const server = "https://hapi.fhir.org/baseR4";
const userName = new URLSearchParams(location.search).get("name") || "è¨ªå®¢";
document.getElementById("welcome").textContent = "æ­¡è¿ï¼Œ" + userName;

let patientId = null;

/* æ‰¾æˆ–å»ºç«‹ Patient */
async function findOrCreatePatient(){
 let r = await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
 let d = await r.json();
 if(d.entry){
    patientId = d.entry[0].resource.id;
    return patientId;
 }
 let res = await fetch(`${server}/Patient`,{
   method:"POST",
   headers:{"Content-Type":"application/fhir+json"},
   body:JSON.stringify({
     resourceType:"Patient",
     name:[{text:userName}],
     identifier:[{system:"http://example.org/pid", value:userName}]
   })
 });
 let x = await res.json();
 patientId = x.id;
 return patientId;
}

/* Observation.code ç”¢ç”Ÿå™¨ */
function obsCode(name){
 return {
   coding:[{system:"http://loinc.org", code:"TMP", display:name}],
   text:name
 };
}

/* ç‹€æ…‹é¡¯ç¤º */
function showStatus(t){
 document.getElementById("statusBox").textContent = t;
}

/* é€å‡ºç´€éŒ„ï¼ˆä¸é™ä»Šå¤©ï¼‰ */
async function submitAll(){
 document.getElementById("loadingOverlay").style.display = "flex";
 await findOrCreatePatient();

 let recordDate =
     document.getElementById("startDate").value ||
     new Date().toISOString().substring(0,10);

 showStatus("ğŸ“¤ å‚³é€ä¸­â€¦");

 // åˆªé™¤è©²æ—¥æœŸèˆŠè³‡æ–™
 let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&date=${recordDate}`);
 let d = await r.json();
 let entries = [];

 if(d.entry){
   d.entry.forEach(e=>{
     entries.push({
       request:{method:"DELETE", url:`Observation/${e.resource.id}`}
     });
   });
 }

 // æ¬„ä½
 let list = [
  { name:"ç¶“æœŸé–‹å§‹æ—¥", val:{valueDateTime:startDate.value}},
  { name:"ç¶“æœŸçµæŸæ—¥", val:{valueDateTime:endDate.value}},
  { name:"å‡ºè¡€é‡", val:{valueString:flow.value}},
  { name:"ç–¼ç—›ç¨‹åº¦", val:{valueQuantity:{value:Number(pain.value)}}},
  { name:"å…¶ä»–ç—‡ç‹€", val:{valueString:symptoms.value}},
  { name:"å¿ƒæƒ…", val:{valueString:mood.value}},
  { name:"å£“åŠ›æŒ‡æ•¸", val:{valueQuantity:{value:Number(stress.value)}}},
  { name:"ç¡çœ å“è³ª", val:{valueString:sleep.value}}
 ];

 list.forEach(o=>{
  entries.push({
    resource:{
      resourceType:"Observation",
      status:"final",
      code:obsCode(o.name),
      subject:{reference:`Patient/${patientId}`},
      effectiveDateTime:recordDate,
      ...o.val
    },
    request:{method:"POST", url:"Observation"}
  });
 });

 await fetch(`${server}`, {
  method:"POST",
  headers:{"Content-Type":"application/fhir+json"},
  body:JSON.stringify({
    resourceType:"Bundle",
    type:"transaction",
    entry: entries
  })
 });

 showStatus("ğŸ‰ è¨˜éŒ„å·²é€å‡ºï¼");
 renderCalendar();
 await loadMonthlyPain();
 document.getElementById("loadingOverlay").style.display="none";
}
</script>
<!-- SEGMENT 3 END -->

<!-- SEGMENT 4 START: Calendar + Trend Chart Logic -->
<script>
/* æœˆæ›†ç³»çµ± */
let currentMonth = new Date();

function renderCalendar(){
 const y = currentMonth.getFullYear();
 const m = currentMonth.getMonth();

 document.getElementById("calendarTitle").textContent = `${y} å¹´ ${m+1} æœˆ`;

 const first = new Date(y, m, 1).getDay();
 const days  = new Date(y, m+1, 0).getDate();

 let html = "<tr><th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr><tr>";

 for(let i=0;i<first;i++) html += "<td></td>";

 for(let d=1; d<=days; d++){
   let ds = `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
   html += `<td id="d${ds}"><div>${d}</div></td>`;
   if( (d+first) % 7 === 0 ) html += "</tr><tr>";
 }

 html += "</tr>";
 document.getElementById("calendarTable").innerHTML = html;

 fillCal();
}

function prevMonth(){ currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); }
function nextMonth(){ currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); }

/* å¡«å…¥æœˆæ›†è³‡æ–™ */
async function fillCal(){
 await findOrCreatePatient();

 let r = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
 let d = await r.json();

 let start = null, end = null, map = {};

 (d.entry || []).forEach(e=>{
   let o  = e.resource;
   let ds = o.effectiveDateTime?.substring(0,10);
   if(!ds) return;

   if(o.code.text === "ç¶“æœŸé–‹å§‹æ—¥") start = o.valueDateTime;
   if(o.code.text === "ç¶“æœŸçµæŸæ—¥") end   = o.valueDateTime;

   if(!map[ds]) map[ds] = {};
   if(o.code.text === "å‡ºè¡€é‡")      map[ds].flow = o.valueString;
   if(o.code.text === "ç–¼ç—›ç¨‹åº¦")    map[ds].pain = o.valueQuantity?.value;
 });

 if(start && end){
   let sd = new Date(start), ed = new Date(end);
   for(let dt=new Date(sd); dt<=ed; dt.setDate(dt.getDate()+1)){
      let ds = dt.toISOString().substring(0,10);
      let cell = document.getElementById("d"+ds);
      if(cell) cell.classList.add("period-day");
   }
 }

 for(let ds in map){
   let cell = document.getElementById("d"+ds);
   if(!cell) continue;

   if(map[ds].flow) cell.innerHTML += `<div>ğŸ©¸${map[ds].flow}</div>`;
   let p = map[ds].pain;
   if(p>=1 && p<=3) cell.innerHTML += `<div>ğŸ™‚å°ç—›</div>`;
   if(p>=4 && p<=6) cell.innerHTML += `<div>ğŸ˜£ä¸­ç—›</div>`;
   if(p>=7)          cell.innerHTML += `<div>ğŸ˜«åŠ‡ç—›</div>`;
 }
}

/* è¶¨å‹¢åœ–ç³»çµ± */
let painChart = null;

async function loadMonthlyPain(){
 await findOrCreatePatient();

 let r1 = await fetch(`${server}/Observation?subject=Patient/${patientId}&code=ç–¼ç—›ç¨‹åº¦&_count=300`);
 let d1 = await r1.json();

 let dataMap = {};

 (d1.entry || []).forEach(e=>{
   let o = e.resource;
   if(!o.valueQuantity) return;

   let m = o.effectiveDateTime.substring(0,7);
   let p = o.valueQuantity.value;

   if(!dataMap[m] || p > dataMap[m]) dataMap[m] = p;
 });

 let labels = Object.keys(dataMap).sort();
 let values = labels.map(m => dataMap[m]);

 const ctx = document.getElementById("painChart");
 if(painChart) painChart.destroy();

 painChart = new Chart(ctx,{
   type:"line",
   data:{
     labels,
     datasets:[{
       label:"æ¯æœˆæœ€å¤§ç–¼ç—›ç¨‹åº¦",
       data:values,
       borderColor:"#b47f4e",
       borderWidth:3,
       tension:0.25
     }]
   }
 });
}

/* è‡ªå‹•è¼‰å…¥ */
async function autoLoad(){
 showStatus("è®€å–ä¸­â€¦");
 await findOrCreatePatient();
 renderCalendar();
 await fillCal();
 await loadMonthlyPain();
 showStatus("è®€å–å®Œæˆï¼");
}
autoLoad();
</script>

<!-- Loading Overlay -->
<div id="loadingOverlay"
style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,0.5);color:white;font-size:32px;
display:flex;align-items:center;justify-content:center;z-index:9999;">
è™•ç†ä¸­â€¦
</div>

</body>
</html>
<!-- SEGMENT 4 END -->
