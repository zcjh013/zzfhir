<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>ç¶“æœŸè§€æ¸¬ç«™ - ç—…äººç«¯</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        background: #f3e9dd;
        font-family: "Arial", sans-serif;
        color: #4b3f2f;
        margin: 0;
        padding: 20px;
    }

    h2 {
        text-align: center;
        color: #6d4b3a;
        margin-bottom: 10px;
        font-size: 26px;
        letter-spacing: 2px;
    }

    #welcome {
        text-align: center;
        font-size: 18px;
        color: #5c4839;
        margin-bottom: 20px;
    }

    .card {
        background: #fffaf3;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0px 3px 6px rgba(0,0,0,0.15);
        border-left: 5px solid #c19a6b;
    }

    .card h3 {
        margin-top: 0;
        color: #6d4b3a;
        font-size: 20px;
    }

    label {
        font-weight: bold;
        color: #5c4839;
        font-size: 15px;
    }

    input, select, textarea {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #d8c3a5;
        margin-top: 6px;
        margin-bottom: 12px;
        background: #fff7ef;
        color: #4b3f2f;
    }

    textarea {
        height: 60px;
    }

    button {
        width: 100%;
        padding: 14px;
        background: #c9a37c;
        color: white;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
    }

    button:hover {
        background: #b08968;
    }

    #statusBox {
        background: #fff4e6;
        padding: 12px;
        border-radius: 8px;
        border-left: 4px solid #d39f61;
        white-space: pre-line;
        margin-top: 15px;
    }

    /* æ—¥æ›†æ¨£å¼ */
    #calendarTable td {
        border: 1px solid #e5d3c0;
        height: 60px;
        vertical-align: top;
        background: #ffffff;
        position: relative;
        padding: 3px;
    }

    .period-day {
        background: #ffe5e5 !important;
    }

    .flow-low { color:#8a6f5a; }
    .flow-mid { color:#b05b3c; font-weight:bold; }
    .flow-high { color:#d62828; font-weight:bold; }

    .pain-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background:#b47f4e;
        position:absolute;
        bottom:4px;
        right:4px;
    }
</style>
</head>

<body>

<h2>ç¶“ æœŸ è§€ æ¸¬ ç«™</h2>
<div id="welcome">è¼‰å…¥ä¸­...</div>

<!-- ç”Ÿç†æœŸç´€éŒ„ -->
<div class="card">
    <h3>ç”Ÿç†æœŸè¨˜éŒ„</h3>

    <label>ç¶“æœŸé–‹å§‹æ—¥</label>
    <input type="date" id="startDate">

    <label>ç¶“æœŸçµæŸæ—¥</label>
    <input type="date" id="endDate">

    <label>å‡ºè¡€é‡</label>
    <select id="flow">
        <option value="å°‘">å°‘</option>
        <option value="ä¸­">ä¸­</option>
        <option value="å¤š">å¤š</option>
    </select>

    <label>ç–¼ç—›ç¨‹åº¦ï¼ˆ0 ï½ 10ï¼‰</label>
    <input type="number" id="pain" min="0" max="10">
</div>

<!-- ç—‡ç‹€ -->
<div class="card">
    <h3>å…¶ä»–ç—‡ç‹€</h3>
    <textarea id="symptoms" placeholder="ä¾‹å¦‚ï¼šè…¹ç—›ã€ç–²å€¦ã€è…¹è„¹ã€é ­ç—›ã€æƒ…ç·’ä¸ç©©â€¦"></textarea>
</div>

<!-- å¿ƒæƒ…ã€å£“åŠ›ã€ç¡çœ  -->
<div class="card">
    <h3>ä»Šæ—¥èº«å¿ƒç‹€æ…‹</h3>

    <label>å¿ƒæƒ…</label>
    <select id="mood">
        <option value="å¹³éœ">ğŸ™‚ å¹³éœ</option>
        <option value="æ™®é€š">ğŸ˜ æ™®é€š</option>
        <option value="é›£é">ğŸ˜ é›£é</option>
        <option value="ç”Ÿæ°£">ğŸ˜¡ ç”Ÿæ°£</option>
        <option value="ç„¦æ…®">ğŸ˜Ÿ ç„¦æ…®</option>
    </select>

    <label>å£“åŠ›æŒ‡æ•¸ï¼ˆ0 ï½ 10ï¼‰</label>
    <input type="number" id="stress" min="0" max="10">

    <label>ç¡çœ å“è³ª</label>
    <select id="sleep">
        <option value="å¥½">å¥½</option>
        <option value="æ™®é€š">æ™®é€š</option>
        <option value="å·®">å·®</option>
    </select>
</div>

<!-- ä¸Šå‚³ä»Šæ—¥ç´€éŒ„ -->
<button onclick="submitAll()">é€å‡ºä»Šæ—¥ç´€éŒ„</button>

<!-- éš¨æ©Ÿæ¸¬è©¦è³‡æ–™ -->
<button onclick="generateRandomData()">ç”¢ç”Ÿæ¸¬è©¦è³‡æ–™ï¼ˆéš¨æ©Ÿï¼‰</button>

<div id="statusBox">å°šæœªé€£ç·š</div>

<!-- è¶¨å‹¢åœ– -->
<div class="card">
    <h3>æˆ‘çš„ç¶“æœŸè¶¨å‹¢ï¼ˆæœ€è¿‘ä¸‰å€‹æœˆï¼‰</h3>
    <button onclick="loadHistory()">è¼‰å…¥æˆ‘çš„æ­·å²ç´€éŒ„</button>
    <canvas id="cycleChart" height="200"></canvas>
</div>

<!-- ç¶“æœŸæœˆæ›† -->
<div class="card">
    <h3>ç¶“æœŸæœˆæ›†</h3>

    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <button onclick="prevMonth()">â¬… ä¸Šå€‹æœˆ</button>
        <div id="calendarTitle" style="font-size:18px; font-weight:bold; color:#6d4b3a;"></div>
        <button onclick="nextMonth()">ä¸‹å€‹æœˆ â¡</button>
    </div>

    <table id="calendarTable" style="width:100%; text-align:center; border-collapse:collapse;"></table>
</div>
<script>
/* ================================
   ğŸ”¸ å–å¾—ç™»å…¥å§“å
================================ */
const urlParams = new URLSearchParams(window.location.search);
const userName = urlParams.get("name") || "è¨ªå®¢";
document.getElementById("welcome").textContent = "æ­¡è¿ï¼Œ" + userName;

/* ================================
   ğŸ”¸ FHIR ä¼ºæœå™¨
================================ */
const server = "https://hapi.fhir.org/baseR4";
let patientId = null;

function showStatus(msg) {
    document.getElementById("statusBox").textContent = msg;
}

/* ================================
   ğŸ”¸ æŸ¥æ‰¾ / å»ºç«‹ Patient
================================ */
async function findOrCreatePatient() {
    let res = await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
    let data = await res.json();

    if (data.entry && data.entry.length > 0) {
        patientId = data.entry[0].resource.id;
        return patientId;
    }

    let body = {
        resourceType: "Patient",
        name: [{ text: userName }],
        gender: "female"
    };

    let createRes = await fetch(`${server}/Patient`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify(body)
    });

    let created = await createRes.json();
    patientId = created.id;
    return patientId;
}

/* ================================
   ğŸ”¸ ä¸Šå‚³ä»Šæ—¥ç´€éŒ„
================================ */
async function submitAll() {
    showStatus("ğŸ”„ æ­£åœ¨ä¸Šå‚³è³‡æ–™â€¦");
    await findOrCreatePatient();

    const today = new Date().toISOString();

    const obs = [
        { name: "ç¶“æœŸé–‹å§‹æ—¥", obj: { valueDateTime: startDate.value }},
        { name: "ç¶“æœŸçµæŸæ—¥", obj: { valueDateTime: endDate.value }},
        { name: "å‡ºè¡€é‡", obj: { valueString: flow.value }},
        { name: "ç–¼ç—›ç¨‹åº¦", obj: { valueQuantity: { value: Number(pain.value) }}},
        { name: "å…¶ä»–ç—‡ç‹€", obj: { valueString: symptoms.value }},
        { name: "å¿ƒæƒ…", obj: { valueString: mood.value }},
        { name: "å£“åŠ›æŒ‡æ•¸", obj: { valueQuantity: { value: Number(stress.value) }}},
        { name: "ç¡çœ å“è³ª", obj: { valueString: sleep.value }},
    ];

    for (let item of obs) {
        await fetch(`${server}/Observation`, {
            method: "POST",
            headers: { "Content-Type": "application/fhir+json" },
            body: JSON.stringify({
                resourceType: "Observation",
                status: "final",
                code: { text: item.name },
                subject: { reference: `Patient/${patientId}` },
                effectiveDateTime: today,
                ...item.obj
            })
        });
    }

    showStatus("ğŸ‰ ä»Šæ—¥ç´€éŒ„å·²æˆåŠŸé€å‡ºï¼");
}

/* ================================
   ğŸ”¸ éš¨æ©Ÿç”¢ç”Ÿ 30~90 å¤©è³‡æ–™
================================ */
async function generateRandomData() {
    showStatus("ğŸ› ï¸ æ­£åœ¨ç”¢ç”Ÿæ¸¬è©¦è³‡æ–™â€¦");
    await findOrCreatePatient();

    const days = Math.floor(Math.random() * 61) + 30;  
    const today = new Date();

    for (let i = 0; i < days; i++) {
        let d = new Date(today);
        d.setDate(d.getDate() - i);
        let iso = d.toISOString();

        const painVal = Math.floor(Math.random() * 10);
        const flowVal = ["å°‘", "ä¸­", "å¤š"][Math.floor(Math.random() * 3)];
        const stressVal = Math.floor(Math.random() * 10);
        const moodVal = ["å¹³éœ","æ™®é€š","é›£é","ç”Ÿæ°£","ç„¦æ…®"][Math.floor(Math.random()*5)];

        const items = [
            { name:"ç–¼ç—›ç¨‹åº¦", obj:{ valueQuantity:{ value:painVal } }},
            { name:"å‡ºè¡€é‡", obj:{ valueString:flowVal }},
            { name:"å£“åŠ›æŒ‡æ•¸", obj:{ valueQuantity:{ value:stressVal } }},
            { name:"å¿ƒæƒ…", obj:{ valueString:moodVal }},
        ];

        for (let item of items) {
            await fetch(`${server}/Observation`, {
                method: "POST",
                headers: { "Content-Type": "application/fhir+json" },
                body: JSON.stringify({
                    resourceType:"Observation",
                    status:"final",
                    code:{ text:item.name },
                    subject:{ reference:`Patient/${patientId}` },
                    effectiveDateTime:iso,
                    ...item.obj
                })
            });
        }
    }

    showStatus(`ğŸ‰ å·²æˆåŠŸç”¢ç”Ÿ ${days} å¤©çš„æ¸¬è©¦è³‡æ–™ï¼`);
}

/* ================================
   ğŸ”¸ è¼‰å…¥ç–¼ç—›è¶¨å‹¢åœ–
================================ */
async function loadHistory() {
    if (!patientId) await findOrCreatePatient();

    showStatus("ğŸ“Š æ­£åœ¨è¼‰å…¥è³‡æ–™â€¦");

    let res = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=300&_sort=-date`);
    let data = await res.json();

    const labels = [];
    const pains = [];

    (data.entry || []).forEach(e => {
        let o = e.resource;
        if (o.code.text === "ç–¼ç—›ç¨‹åº¦" && o.valueQuantity) {
            pains.push(o.valueQuantity.value);
            labels.push(o.effectiveDateTime || "");
        }
    });

    drawChart(labels.reverse(), pains.reverse());
    showStatus("ğŸ“ˆ è¶¨å‹¢åœ–å·²æ›´æ–°ï¼");
}

let chart = null;

function drawChart(labels, data) {
    const ctx = document.getElementById("cycleChart");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type:"line",
        data:{
            labels,
            datasets:[{
                label:"ç–¼ç—›ç¨‹åº¦è¶¨å‹¢",
                data,
                borderColor:"#b47f4e",
                backgroundColor:"rgba(180,127,78,0.25)",
                borderWidth:3
            }]
        }
    });
}

/* ================================
   ğŸ”¸ æœˆæ›†ï¼ˆUIï¼‰
================================ */
let currentMonth = new Date();

function renderCalendar() {
    const y = currentMonth.getFullYear();
    const m = currentMonth.getMonth();

    document.getElementById("calendarTitle").textContent = `${y} å¹´ ${m+1} æœˆ`;

    const first = new Date(y, m, 1);
    const start = first.getDay();
    const days = new Date(y, m+1, 0).getDate();

    let html = `
      <tr style="font-weight:bold; color:#5c4839;">
        <td>æ—¥</td><td>ä¸€</td><td>äºŒ</td><td>ä¸‰</td>
        <td>å››</td><td>äº”</td><td>å…­</td>
      </tr><tr>
    `;

    for (let i = 0; i < start; i++) html += `<td></td>`;

    for (let d = 1; d <= days; d++) {
        let ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

        html += `
          <td id="d${ds}">
            <div style="font-size:14px;">${d}</div>
            <div class="dayInfo" style="font-size:12px;"></div>
          </td>
        `;

        if ((d+start) % 7 === 0) html += `</tr><tr>`;
    }

    html += "</tr>";
    document.getElementById("calendarTable").innerHTML = html;
}

function prevMonth(){
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    renderCalendar();
    fillCalendarData();
}

function nextMonth(){
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    renderCalendar();
    fillCalendarData();
}

/* ================================
   ğŸ”¸ æœˆæ›†å¡«å…¥ FHIR è³‡æ–™
================================ */
async function fillCalendarData() {
    if (!patientId) return;

    let res = await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
    let data = await res.json();

    (data.entry || []).forEach(e => {
        let o = e.resource;
        let date = o.effectiveDateTime;
        if (!date) return;

        const short = date.substring(0,10);
        const td = document.getElementById("d" + short);
        if (!td) return;

        /* å‡ºè¡€é‡ */
        if (o.code.text === "å‡ºè¡€é‡" && o.valueString) {
            let cls = "flow-low";
            if (o.valueString === "ä¸­") cls = "flow-mid";
            if (o.valueString === "å¤š") cls = "flow-high";

            td.querySelector(".dayInfo").innerHTML +=
                `<div class="${cls}">ğŸ©¸ ${o.valueString}</div>`;
        }

        /* ç–¼ç—›ç¨‹åº¦ â†’ é» */
        if (o.code.text === "ç–¼ç—›ç¨‹åº¦" && o.valueQuantity) {
            td.innerHTML += `<div class="pain-dot"></div>`;
        }

        /* ç¶“æœŸé—œéµæ—¥ */
        if (o.code.text === "ç¶“æœŸé–‹å§‹æ—¥" || o.code.text === "ç¶“æœŸçµæŸæ—¥") {
            td.classList.add("period-day");
        }
    });
}

/* ================================
   ğŸ”¸ åˆå§‹åŒ–
================================ */
renderCalendar();

findOrCreatePatient().then(id => {
    patientId = id;
    fillCalendarData();
});
</script>

</body>
</html>
