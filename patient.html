
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç¶“æœŸè§€æ¸¬ç«™ï¼ˆFirely Debug V3ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {background:#f3e9dd;font-family:Arial;color:#4b3f2f;margin:0;padding:20px;}
h2{text-align:center;color:#6d4b3a;margin-bottom:10px;}
#debugBox{background:#fff8e6;padding:10px;border-radius:10px;border:1px solid #d3b782;margin-bottom:15px;}
.status-log{font-size:15px;margin-top:4px;color:#5c4b3a;}
.row{display:flex;gap:20px;}
.col{flex:1;}
.card{background:#fffaf3;padding:18px;border-radius:12px;
box-shadow:0 3px 6px rgba(0,0,0,0.1);border-left:5px solid #c19a6b;margin-bottom:20px;}
label{font-weight:bold;margin-top:10px;display:block;}
input,select,textarea{width:100%;padding:9px;margin-top:4px;margin-bottom:12px;
border-radius:6px;border:1px solid #d8c3a5;background:#fff7ef;}
textarea{height:60px;}
.separator{width:2px;background:#c9b8a4;margin:0 10px;border-radius:2px;}
button{padding:10px 20px;margin:5px;background:#c9a37c;color:white;border:none;
border-radius:6px;font-size:15px;cursor:pointer;}
button:hover{background:#b88b63;}
#calendarTable td{border:1px solid #e5d3c0;width:14%;height:60px;vertical-align:top;padding:3px;}
.period-day{background:#ffe5e5 !important;}
#loadingOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,0.5);color:white;font-size:32px;
align-items:center;justify-content:center;z-index:9999;}
</style>
</head>
<body>

<h2>ç¶“ æœŸ è§€ æ¸¬ ç«™ï¼ˆFirely Debug V3ï¼‰</h2>
<div id="debugBox">
<b>ğŸ§© Debug æ§åˆ¶å°</b><br>
<div id="debugStatus">ç‹€æ…‹ï¼šé–’ç½®ä¸­</div>
<div id="debugError">éŒ¯èª¤ï¼šç„¡</div>
<div id="debugVersion">ç‰ˆæœ¬ï¼šFirely Debug V3</div>
</div>

<div class="row">
<div class="col">
<div class="card">
<h3>ç”Ÿç†æœŸè¨˜éŒ„</h3>
<label>ç¶“æœŸé–‹å§‹æ—¥</label><input type="date" id="startDate">
<label>ç¶“æœŸçµæŸæ—¥</label><input type="date" id="endDate">
<label>å‡ºè¡€é‡</label><select id="flow"><option>å°‘</option><option>ä¸­</option><option>å¤š</option></select>
<label>ç–¼ç—›ç¨‹åº¦ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="pain" min="0" max="10">
</div></div>

<div class="separator"></div>

<div class="col">
<div class="card">
<h3>ä»Šæ—¥èº«å¿ƒç—‡ç‹€</h3>
<label>å…¶ä»–ç—‡ç‹€</label><textarea id="symptoms"></textarea>
<label>å¿ƒæƒ…</label><select id="mood"><option>å¹³éœ</option><option>æ™®é€š</option><option>é›£é</option><option>ç”Ÿæ°£</option><option>ç„¦æ…®</option></select>
<label>å£“åŠ›æŒ‡æ•¸ï¼ˆ0ã€œ10ï¼‰</label><input type="number" id="stress" min="0" max="10">
<label>ç¡çœ å“è³ª</label><select id="sleep"><option>å¥½</option><option>æ™®é€š</option><option>å·®</option></select>
</div></div>
</div>

<div style="text-align:center;margin-bottom:10px;">
<button onclick="submitAll()">ğŸš€ é€å‡ºä»Šæ—¥ç´€éŒ„</button>
<button onclick="generateHalfYear()">ğŸ§© ç”¢ç”ŸåŠå¹´è³‡æ–™</button>
<button onclick="renderCalendar()">ğŸ“… è¼‰å…¥æœˆæ›†</button>
<button onclick="loadMonthlyPain()">ğŸ“ˆ è¼‰å…¥è¶¨å‹¢åœ–</button>
<button onclick="checkServerData()">ğŸ” æŸ¥è©¢ä¼ºæœå™¨è³‡æ–™</button>
</div>

<div class="card"><h3>æœˆç–¼ç—›è¶¨å‹¢</h3><canvas id="painChart"></canvas></div>
<div class="card"><h3>ç¶“æœŸæœˆæ›†</h3><table id="calendarTable" style="width:100%;border-collapse:collapse;"></table></div>

<script>
const server = "https://server.fire.ly/r4";
const userName = new URLSearchParams(location.search).get("name") || "è¨ªå®¢";
let patientId = null;
let painChart = null;

function updateDebug(status, error="ç„¡"){
  document.getElementById("debugStatus").textContent = "ç‹€æ…‹ï¼š" + status;
  document.getElementById("debugError").textContent = "éŒ¯èª¤ï¼š" + error;
  console.log("ğŸ§©", status, error);
}

async function findOrCreatePatient(){
 try{
  let r = await fetch(`${server}/Patient?name=${encodeURIComponent(userName)}`);
  let d = await r.json();
  if(d.entry){patientId=d.entry[0].resource.id;return patientId;}
  let res = await fetch(`${server}/Patient`,{
    method:"POST",
    headers:{"Content-Type":"application/fhir+json"},
    body:JSON.stringify({resourceType:"Patient",name:[{text:userName}]})
  });
  let x = await res.json();patientId=x.id;return patientId;
 }catch(e){updateDebug("å»ºç«‹ç—…äººå¤±æ•—",e);}
}

async function submitAll(){
 updateDebug("ğŸ“¤ å‚³é€ä¸­...");
 try{
  await findOrCreatePatient();
  let today=new Date().toISOString().substring(0,10);
  let list=[
   {name:"ç¶“æœŸé–‹å§‹æ—¥",val:{valueDateTime:startDate.value}},
   {name:"ç¶“æœŸçµæŸæ—¥",val:{valueDateTime:endDate.value}},
   {name:"å‡ºè¡€é‡",val:{valueString:flow.value}},
   {name:"ç–¼ç—›ç¨‹åº¦",val:{valueQuantity:{value:Number(pain.value)}}},
   {name:"å…¶ä»–ç—‡ç‹€",val:{valueString:symptoms.value}},
   {name:"å¿ƒæƒ…",val:{valueString:mood.value}},
   {name:"å£“åŠ›æŒ‡æ•¸",val:{valueQuantity:{value:Number(stress.value)}}},
   {name:"ç¡çœ å“è³ª",val:{valueString:sleep.value}}
  ];
  let entries=list.map(o=>({
   resource:{resourceType:"Observation",status:"final",
    code:{coding:[{system:"http://loinc.org",code:"TMP",display:o.name}],text:o.name},
    subject:{reference:`Patient/${patientId}`},effectiveDateTime:today,...o.val},
   request:{method:"POST",url:"Observation"}
  }));
  let res=await fetch(`${server}`,{method:"POST",headers:{"Content-Type":"application/fhir+json"},
   body:JSON.stringify({resourceType:"Bundle",type:"transaction",entry:entries})});
  updateDebug(res.ok?"âœ… ä»Šæ—¥ç´€éŒ„å·²é€å‡º":"âŒ å‚³é€å¤±æ•—",res.status);
 }catch(e){updateDebug("âŒ å‚³é€éŒ¯èª¤",e);}
}

async function generateHalfYear(){
 updateDebug("ğŸ§© ç”¢ç”ŸåŠå¹´è³‡æ–™ä¸­...");
 try{
  await findOrCreatePatient();
  let arr=[],today=new Date(),startYear=today.getFullYear(),startMonth=today.getMonth()-5;
  if(startMonth<0){startYear--;startMonth+=12;}
  for(let m=0;m<6;m++){let d=new Date(startYear,startMonth+m,25);
   arr.push({date:d.toISOString(),flow:["å°‘","ä¸­","å¤š"][Math.floor(Math.random()*3)],
    pain:Math.floor(Math.random()*6)+3,stress:Math.floor(Math.random()*10),
    sleep:["å¥½","æ™®é€š","å·®"][Math.floor(Math.random()*3)],
    mood:["å¹³éœ","æ™®é€š","é›£é","ç”Ÿæ°£","ç„¦æ…®"][Math.floor(Math.random()*5)]});
  }
  let res=await fetch(`${server}/Observation`,{
   method:"POST",headers:{"Content-Type":"application/fhir+json"},
   body:JSON.stringify({resourceType:"Observation",status:"final",
     code:{coding:[{system:"http://loinc.org",code:"TMP",display:"åŠå¹´è³‡æ–™(JSON)"}],text:"åŠå¹´è³‡æ–™(JSON)"},
     subject:{reference:`Patient/${patientId}`},effectiveDateTime:new Date().toISOString(),
     valueString:JSON.stringify(arr)})
  });
  updateDebug(res.ok?"âœ… åŠå¹´è³‡æ–™å¯«å…¥æˆåŠŸ":"âŒ åŠå¹´è³‡æ–™å¯«å…¥å¤±æ•—",res.status);
 }catch(e){updateDebug("âŒ åŠå¹´è³‡æ–™éŒ¯èª¤",e);}
}

async function renderCalendar(){
 updateDebug("ğŸ“… è®€å–æœˆæ›†è³‡æ–™ä¸­...");
 try{
  await findOrCreatePatient();
  let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=500`);
  let d=await r.json();
  const table=document.getElementById("calendarTable");
  table.innerHTML="";
  if(!d.entry){updateDebug("âš  ç„¡æœˆæ›†è³‡æ–™");return;}
  let map={};
  d.entry.forEach(e=>{
   let o=e.resource;let ds=o.effectiveDateTime?.substring(0,10);if(!ds)return;
   if(!map[ds])map[ds]={};if(o.code.text==="å‡ºè¡€é‡")map[ds].flow=o.valueString;
   if(o.code.text==="ç–¼ç—›ç¨‹åº¦")map[ds].pain=o.valueQuantity?.value;
  });
  let html="<tr><th>æ—¥æœŸ</th><th>å…§å®¹</th></tr>";
  Object.keys(map).sort().forEach(ds=>{
    html+=`<tr><td>${ds}</td><td>${map[ds].flow||""} ${map[ds].pain?"ç–¼ç—›:"+map[ds].pain:""}</td></tr>`;
  });
  table.innerHTML=html;
  updateDebug("âœ… æœˆæ›†è³‡æ–™å·²è¼‰å…¥");
 }catch(e){updateDebug("âŒ æœˆæ›†è¼‰å…¥éŒ¯èª¤",e);}
}

async function loadMonthlyPain(){
 updateDebug("ğŸ“ˆ è¼‰å…¥è¶¨å‹¢åœ–ä¸­...");
 try{
  await findOrCreatePatient();
  let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&code=åŠå¹´è³‡æ–™(JSON)&_count=10`);
  let d=await r.json();if(!d.entry){updateDebug("âš  ç„¡è¶¨å‹¢è³‡æ–™");return;}
  let dataMap={},arr=[];
  d.entry.forEach(e=>{try{arr=JSON.parse(e.resource.valueString);}catch{};arr.forEach(x=>{
   let m=x.date.substring(0,7);if(!dataMap[m]||x.pain>dataMap[m])dataMap[m]=x.pain;
  });});
  const ctx=document.getElementById("painChart");if(painChart)painChart.destroy();
  let labels=Object.keys(dataMap).sort(),values=labels.map(m=>dataMap[m]);
  if(labels.length===0){updateDebug("âš  ç„¡å¯ç¹ªè£½è³‡æ–™");return;}
  painChart=new Chart(ctx,{type:"line",data:{labels,datasets:[{label:"æ¯æœˆæœ€å¤§ç–¼ç—›å€¼",data:values,borderColor:"#b47f4e",borderWidth:3,tension:0.25}]}});
  updateDebug("âœ… è¶¨å‹¢åœ–å®Œæˆ");
 }catch(e){updateDebug("âŒ è¶¨å‹¢åœ–éŒ¯èª¤",e);}
}

async function checkServerData(){
 updateDebug("ğŸ” æŸ¥è©¢ä¼ºæœå™¨è³‡æ–™...");
 try{
  await findOrCreatePatient();
  let r=await fetch(`${server}/Observation?subject=Patient/${patientId}&_count=5`);
  let d=await r.json();
  if(!d.entry){updateDebug("âš  ç„¡ä¼ºæœå™¨è³‡æ–™");return;}
  updateDebug(`âœ… æ‰¾åˆ° ${d.entry.length} ç­†è³‡æ–™`, JSON.stringify(d.entry[0].resource.code.text));
 }catch(e){updateDebug("âŒ æŸ¥è©¢éŒ¯èª¤",e);}
}
</script>

<div id="loadingOverlay">è™•ç†ä¸­â€¦</div>

</body>
</html>
