<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å¤§å¥åº· FHIR ç®¡ç†ä¸­å¿ƒï¼ˆAdminï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- å­—å‹èˆ‡é¢¨æ ¼ä¸€è‡´ -->
<style>
    body {
        margin: 0;
        background: #FAF7F2; /* èˆ‡ç—…äººé ä¸€è‡´çš„æ·¡å¥¶æ²¹è‰² */
        font-family: Arial, sans-serif;
        color: #4b3f2f;
        padding-bottom: 120px;
    }

    /* â­ ä¸Šæ–¹å¢¨ç¶  Header */
    .top-header {
        width: 100%;
        background: #5A6F68;
        color: white;
        padding: 20px 28px;
        box-sizing: border-box;
    }
    .top-header-title {
        font-size: 22px;
        font-weight: bold;
        line-height: 1.3;
        white-space: pre-line;
    }

    /* â­ å³ä¸Šè§’ç™»å‡ºæŒ‰éˆ• */
    .logout-btn {
        position: fixed;
        top: 15px;
        right: 15px;
        background: #888;
        color: white;
        padding: 8px 14px;
        font-size: 14px;
        border-radius: 8px;
        cursor: pointer;
        z-index: 9999;
    }

    /* ä¸»è¦å®¹å™¨ */
    .container {
        width: 95%;
        max-width: 1200px;
        margin: auto;
        margin-top: 20px;
    }

    /* å¡ç‰‡å€åŸŸ */
    .card {
        background: #fffaf3;
        border-left: 5px solid #5A6F68;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 26px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    h2 {
        text-align: center;
        color: #5A6F68;
    }

    h3 {
        color: #5A6F68;
        margin-top: 0;
    }

    label {
        font-weight: bold;
        display: block;
        margin-top: 10px;
    }

    input, select {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        border-radius: 6px;
        border: 1px solid #c7b7a4;
        background: #fff7ef;
        box-sizing: border-box;
    }

    button {
        background: #5A6F68;
        color: white;
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        margin-top: 12px;
        margin-right: 10px;
    }

    button:hover { opacity: 0.9; }

    /* è³‡æ–™åˆ—è¡¨è¡¨æ ¼ */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
    }
    th, td {
        border: 1px solid #d2c1b0;
        padding: 8px;
        background: #fff;
    }
    th {
        background: #e8ddd3;
    }

    .list-box {
        background: #fff7ef;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #d8c8b6;
        margin-top: 10px;
    }
</style>
</head>

<body>

<!-- â­ Header -->
<div class="top-header">
    <div class="top-header-title">
å¤§å¥åº·
FHIR
ç®¡ç†ä¸­å¿ƒï¼ˆAdminï¼‰
    </div>
</div>

<!-- â­ ç™»å‡º -->
<button class="logout-btn" onclick="window.location.href='index.html'">ç™»å‡º</button>

<div class="container">

<h2>FHIR Admin å¾Œå°</h2>

<!-- ========================================================= -->
<!-- â… . å»ºç«‹ FHIR çµ„ç¹” -->
<!-- ========================================================= -->
<div class="card">
    <h3>â… . å»ºç«‹ FHIR çµ„ç¹”ï¼ˆOrganizationï¼‰</h3>

    <label>çµ„ç¹”åç¨±</label>
    <input type="text" id="orgName">

    <button onclick="createOrganization()">å»ºç«‹çµ„ç¹”</button>

    <div id="orgResult" style="margin-top:10px;font-weight:bold;"></div>

    <h4>å·²å»ºç«‹çµ„ç¹”æ¸…å–®ï¼ˆlocalStorageï¼‰</h4>
    <div id="orgList" class="list-box"></div>
</div>

<!-- ========================================================= -->
<!-- â…¡. å»ºç«‹ PHR ç—…äººï¼ˆæ°‘çœ¾ç«¯ï¼‰ -->
<!-- ========================================================= -->
<div class="card">
    <h3>â…¡. å»ºç«‹ PHR ç—…äººï¼ˆæ°‘çœ¾å¥åº·ç´€éŒ„ï¼‰</h3>

    <label>æš±ç¨±</label>
    <input type="text" id="phrNickname">

    <label>æ‰€å±¬çµ„ç¹”ï¼ˆOrganizationï¼‰</label>
    <select id="phrOrg"></select>

    <button onclick="createPHRPatient()">å»ºç«‹ PHR ç—…äºº</button>

    <div id="phrResult" style="margin-top:10px;font-weight:bold;"></div>

    <h4>å·²å»ºç«‹ PHR ç—…äººæ¸…å–®</h4>
    <div id="phrList" class="list-box"></div>
</div>

<!-- ========================================================= -->
<!-- â…¢. å»ºç«‹ EMR ç—…äººï¼ˆé†«é™¢ç«¯ï¼‰ -->
<!-- ========================================================= -->
<div class="card">
    <h3>â…¢. å»ºç«‹ EMR ç—…äººï¼ˆé†«ç™‚ç«¯ç—…æ­·è³‡æ–™ï¼‰</h3>

    <label>å§“å</label>
    <input type="text" id="emrName">

    <label>æ€§åˆ¥</label>
    <select id="emrGender">
        <option value="male">ç”·</option>
        <option value="female">å¥³</option>
    </select>

    <label>ç”Ÿæ—¥</label>
    <input type="date" id="emrBirth">

    <label>æ‰€å±¬çµ„ç¹”ï¼ˆOrganizationï¼‰</label>
    <select id="emrOrg"></select>

    <button onclick="createEMRPatient()">å»ºç«‹ EMR ç—…äºº</button>

    <div id="emrResult" style="margin-top:10px;font-weight:bold;"></div>

    <h4>å·²å»ºç«‹ EMR ç—…äººæ¸…å–®</h4>
    <div id="emrList" class="list-box"></div>
</div>

<!-- ========================================================= -->
<!-- â…£. ä¸Šå‚³ç”Ÿç†ç›£æ¸¬ï¼ˆVital Signsï¼‰ -->
<!-- ========================================================= -->
<div class="card">
    <h3>â…£. ä¸Šå‚³ç”Ÿç†ç›£æ¸¬ï¼ˆVital Signsï¼‰</h3>

    <label>Patient ID</label>
    <input type="text" id="vsPatientId">

    <label>ç›£æ¸¬é …ç›®</label>
    <select id="vsType">
        <option value="heart">å¿ƒè·³ Heart Rate</option>
        <option value="spo2">è¡€æ°§ SpO2</option>
        <option value="temp">é«”æº« Body Temperature</option>
    </select>

    <label>ç›£æ¸¬æ•¸å€¼</label>
    <input type="number" id="vsValue">

    <button onclick="uploadVital()">ä¸Šå‚³ç”Ÿç†ç›£æ¸¬</button>

    <div id="vsResult" style="margin-top:10px;font-weight:bold;"></div>
</div>

<!-- ========================================================= -->
<!-- â…¤. æŸ¥è©¢ ç”Ÿç†ç›£æ¸¬è³‡æ–™ -->
<!-- ========================================================= -->
<div class="card">
    <h3>â…¤. æŸ¥è©¢ç”Ÿç†ç›£æ¸¬è³‡æ–™</h3>

    <label>Patient ID</label>
    <input type="text" id="queryPatientId">

    <label>æŸ¥è©¢é …ç›®</label>
    <select id="queryType">
        <option value="heart">å¿ƒè·³</option>
        <option value="spo2">è¡€æ°§</option>
        <option value="temp">é«”æº«</option>
    </select>

    <button onclick="queryVital()">æŸ¥è©¢è³‡æ–™</button>

    <div id="queryResult" style="margin-top:10px;"></div>

    <table id="queryTable" class="hidden">
        <thead>
            <tr>
                <th>æ—¥æœŸ</th>
                <th>æ•¸å€¼</th>
                <th>å–®ä½</th>
                <th>Observation ID</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

</div><!-- container end -->
<script>
// =========================================
// ğŸ”§ FHIR Server
// =========================================
const server = "https://hapi.fhir.org/baseR4";

// =========================================
// ğŸ“Œ LocalStorage Keys
// =========================================
const KEY_ORG = "fhir_org_list";
const KEY_PHR = "fhir_phr_list";
const KEY_EMR = "fhir_emr_list";

// =========================================
// ğŸ“Œ localStorage Helper
// =========================================
function loadList(key) {
    return JSON.parse(localStorage.getItem(key) || "[]");
}
function saveList(key, list) {
    localStorage.setItem(key, JSON.stringify(list));
}

// =========================================
// ğŸ“Œ åˆå§‹åŒ–ï¼ˆè¼‰å…¥çµ„ç¹”ã€ç—…äººä¸‹æ‹‰é¸å–®ï¼‰
// =========================================
function refreshLists() {
    let orgs = loadList(KEY_ORG);
    let phrs = loadList(KEY_PHR);
    let emrs = loadList(KEY_EMR);

    // çµ„ç¹”æ¸…å–®é¡¯ç¤º
    orgList.innerHTML = orgs.length === 0
        ? "æš«ç„¡è³‡æ–™"
        : orgs.map(o => `â€¢ ${o.name}ï¼ˆIDï¼š${o.id}ï¼‰`).join("<br>");

    // PHR æ¸…å–®
    phrList.innerHTML = phrs.length === 0
        ? "æš«ç„¡è³‡æ–™"
        : phrs.map(p => `â€¢ ${p.nickname}ï¼ˆPatient IDï¼š${p.id}ï¼‰`).join("<br>");

    // EMR æ¸…å–®
    emrList.innerHTML = emrs.length === 0
        ? "æš«ç„¡è³‡æ–™"
        : emrs.map(p => `â€¢ ${p.name}ï¼ˆPatient IDï¼š${p.id}ï¼‰`).join("<br>");

    // ä¸‹æ‹‰é¸å–®ï¼ˆPHR & EMR éƒ½è¦ç”¨ï¼‰
    phrOrg.innerHTML = orgs.map(o => `<option value="${o.id}">${o.name}</option>`).join("");
    emrOrg.innerHTML = orgs.map(o => `<option value="${o.id}">${o.name}</option>`).join("");
}

refreshLists();

// ==========================================================
// â… . å»ºç«‹ Organizationï¼ˆFHIR Organizationï¼‰
// ==========================================================
async function createOrganization() {
    const name = orgName.value.trim();
    if (!name) {
        alert("è«‹è¼¸å…¥çµ„ç¹”åç¨±");
        return;
    }

    orgResult.textContent = "å»ºç«‹ä¸­â€¦";

    let res = await fetch(`${server}/Organization`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify({
            resourceType: "Organization",
            name: name
        })
    });

    let data = await res.json();
    let orgId = data.id;

    orgResult.textContent = `æˆåŠŸå»ºç«‹ï¼Organization IDï¼š${orgId}`;

    // å­˜å…¥ localStorage
    let list = loadList(KEY_ORG);
    list.push({ name, id: orgId });
    saveList(KEY_ORG, list);

    refreshLists();
    orgName.value = "";
}

// ==========================================================
// â…¡. å»ºç«‹ PHR ç—…äººï¼ˆæ°‘çœ¾ç«¯ï¼‰
// ==========================================================
async function createPHRPatient() {
    const nickname = phrNickname.value.trim();
    const orgId = phrOrg.value;

    if (!nickname) {
        alert("è«‹è¼¸å…¥æš±ç¨±");
        return;
    }

    phrResult.textContent = "å»ºç«‹ PHR ç—…äººä¸­â€¦";

    let res = await fetch(`${server}/Patient`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify({
            resourceType: "Patient",
            name: [{ text: nickname }],
            managingOrganization: { reference: `Organization/${orgId}` }
        })
    });

    let data = await res.json();
    let patientId = data.id;

    phrResult.textContent = `æˆåŠŸå»ºç«‹ï¼Patient IDï¼š${patientId}`;

    // å­˜å…¥ localStorage
    let list = loadList(KEY_PHR);
    list.push({ nickname, id: patientId, org: orgId });
    saveList(KEY_PHR, list);

    refreshLists();
    phrNickname.value = "";
}

// ==========================================================
// â…¢. å»ºç«‹ EMR ç—…äººï¼ˆé†«é™¢ç«¯ï¼‰
// ==========================================================
async function createEMRPatient() {
    const name = emrName.value.trim();
    const gender = emrGender.value;
    const birth = emrBirth.value;
    const orgId = emrOrg.value;

    if (!name || !birth) {
        alert("è«‹è¼¸å…¥å§“åèˆ‡ç”Ÿæ—¥");
        return;
    }

    emrResult.textContent = "å»ºç«‹ EMR ç—…äººä¸­â€¦";

    let res = await fetch(`${server}/Patient`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify({
            resourceType: "Patient",
            name: [{ text: name }],
            gender: gender,
            birthDate: birth,
            managingOrganization: { reference: `Organization/${orgId}` }
        })
    });

    let data = await res.json();
    let patientId = data.id;

    emrResult.textContent = `æˆåŠŸå»ºç«‹ï¼Patient IDï¼š${patientId}`;

    // å­˜å…¥ localStorage
    let list = loadList(KEY_EMR);
    list.push({ name, id: patientId, org: orgId });
    saveList(KEY_EMR, list);

    refreshLists();
    emrName.value = "";
    emrBirth.value = "";
}

// ==========================================================
// â…£. ä¸Šå‚³ç”Ÿç†ç›£æ¸¬ï¼ˆVital Signsï¼‰
// ==========================================================
function getVitalCode(type) {
    if (type === "heart") return { code: "8867-4", unit: "bpm", display: "Heart Rate" };
    if (type === "spo2")  return { code: "59408-5", unit: "%",   display: "SpO2" };
    if (type === "temp")  return { code: "8310-5", unit: "Â°C",   display: "Body Temperature" };
}

async function uploadVital() {
    const patientId = vsPatientId.value.trim();
    const type = vsType.value;
    const value = Number(vsValue.value);

    if (!patientId || !value) {
        alert("è«‹è¼¸å…¥æ•¸å€¼èˆ‡ Patient ID");
        return;
    }

    const vital = getVitalCode(type);

    vsResult.textContent = "ä¸Šå‚³ä¸­â€¦";

    let res = await fetch(`${server}/Observation`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify({
            resourceType: "Observation",
            status: "final",
            code: { coding: [{ system: "http://loinc.org", code: vital.code, display: vital.display }] },
            subject: { reference: `Patient/${patientId}` },
            effectiveDateTime: new Date().toISOString(),
            valueQuantity: { value: value, unit: vital.unit }
        })
    });

    let data = await res.json();

    vsResult.textContent = `ä¸Šå‚³æˆåŠŸï¼Observation IDï¼š${data.id}`;
}

// ==========================================================
// â…¤. æŸ¥è©¢ç”Ÿç†ç›£æ¸¬è³‡æ–™
// ==========================================================
function getQueryCode(type) {
    if (type === "heart") return "8867-4";
    if (type === "spo2") return "59408-5";
    if (type === "temp") return "8310-5";
}

async function queryVital() {
    const patientId = queryPatientId.value.trim();
    const type = queryType.value;
    const code = getQueryCode(type);

    if (!patientId) {
        alert("è«‹è¼¸å…¥ Patient ID");
        return;
    }

    queryResult.textContent = "æŸ¥è©¢ä¸­â€¦";
    queryTable.classList.add("hidden");
    queryTable.querySelector("tbody").innerHTML = "";

    const url = `${server}/Observation?subject=Patient/${patientId}&code=${code}&_count=500`;

    let r = await fetch(url);
    let d = await r.json();

    if (!d.entry) {
        queryResult.textContent = "æŸ¥ç„¡è³‡æ–™";
        return;
    }

    let rows = d.entry.map(e => {
        let o = e.resource;

        return `
        <tr>
            <td>${o.effectiveDateTime?.substring(0,10) || ""}</td>
            <td>${o.valueQuantity?.value || ""}</td>
            <td>${o.valueQuantity?.unit || ""}</td>
            <td>${o.id}</td>
        </tr>`;
    }).join("");

    queryTable.querySelector("tbody").innerHTML = rows;
    queryTable.classList.remove("hidden");
    queryResult.textContent = `æŸ¥è©¢å®Œæˆï¼Œå…± ${d.entry.length} ç­†è³‡æ–™`;
}
</script>
