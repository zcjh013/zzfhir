<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>大健康 FHIR 管理中心（Admin）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        margin: 0;
        background: #FAF7F2;
        font-family: Arial, sans-serif;
        color: #4b3f2f;
        padding-bottom: 120px;
    }

    .top-header {
        width: 100%;
        background: #5A6F68;
        color: white;
        padding: 20px 28px;
        box-sizing: border-box;
    }
    .top-header-title {
        font-size: 22px;
        font-weight: bold;
        line-height: 1.3;
        white-space: pre-line;
    }

    .logout-btn {
        position: fixed;
        top: 15px;
        right: 15px;
        background: #888;
        color: white;
        padding: 8px 14px;
        font-size: 14px;
        border-radius: 8px;
        cursor: pointer;
        z-index: 9999;
    }

    .container {
        width: 95%;
        max-width: 1200px;
        margin: auto;
        margin-top: 20px;
    }

    .card {
        background: #fffaf3;
        border-left: 5px solid #5A6F68;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 26px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    h2 { text-align:center;color:#5A6F68; }
    h3 { color:#5A6F68;margin-top:0; }

    label {
        font-weight: bold;
        display: block;
        margin-top: 10px;
    }

    input, select {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        border-radius: 6px;
        border: 1px solid #c7b7a4;
        background: #fff7ef;
        box-sizing: border-box;
    }

    button {
        background: #5A6F68;
        color: white;
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        margin-top: 12px;
        margin-right: 10px;
    }

    button:hover { opacity: 0.9; }

    .list-box {
        background: #fff7ef;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #d8c8b6;
        margin-top: 10px;
    }

</style>
</head>

<body>

<div class="top-header">
    <div class="top-header-title">
大健康
FHIR
管理中心（Admin）
    </div>
</div>

<button class="logout-btn" onclick="window.location.href='index.html'">登出</button>

<div class="container">

<h2>FHIR Admin 後台</h2>

<!-- ========================================================= -->
<!-- Ⅰ. 建立或輸入 FHIR 組織 -->
<!-- ========================================================= -->
<div class="card">
    <h3>Ⅰ. 建立 FHIR 組織（Organization）</h3>

    <label>建立新組織（輸入組織名稱）</label>
    <input type="text" id="orgName">
    <button onclick="createOrganization()">建立組織</button>

    <hr style="margin:18px 0;">

    <label>輸入既有 Organization ID（加入清單，不建立新組織）</label>
    <input type="text" id="orgIdInput">
    <button onclick="addExistingOrg()">加入組織 ID</button>

    <div id="orgResult" style="margin-top:10px;font-weight:bold;"></div>

    <h4>已建立 / 已加入組織清單</h4>
    <div id="orgList" class="list-box"></div>
</div>

<!-- ========================================================= -->
<!-- Ⅱ. 建立 PHR 病人 -->
<!-- ========================================================= -->
<div class="card">
    <h3>Ⅱ. 建立 PHR 病人（民眾端）</h3>

    <label>暱稱（病人顯示用名稱）</label>
    <input type="text" id="phrNickname">

    <label>所屬組織 ID（Organization ID）</label>
    <input type="text" id="phrOrgInput">

    <button onclick="createPHRPatient()">建立 PHR 病人</button>

    <div id="phrResult" style="margin-top:10px;font-weight:bold;"></div>

    <h4>已建立 PHR 病人清單</h4>
    <div id="phrList" class="list-box"></div>
</div>

<!-- ========================================================= -->
<!-- Ⅲ. 建立 EMR 病人 -->
<!-- ========================================================= -->
<div class="card">
    <h3>Ⅲ. 建立 EMR 病人（醫療院所端）</h3>

    <label>病人姓名</label>
    <input type="text" id="emrName">

    <label>性別</label>
    <select id="emrGender">
        <option value="male">男</option>
        <option value="female">女</option>
    </select>

    <label>生日</label>
    <input type="date" id="emrBirth">

    <label>所屬組織 ID（Organization ID）</label>
    <input type="text" id="emrOrgInput">

    <button onclick="createEMRPatient()">建立 EMR 病人</button>

    <div id="emrResult" style="margin-top:10px;font-weight:bold;"></div>

    <h4>已建立 EMR 病人清單</h4>
    <div id="emrList" class="list-box"></div>
</div>

<!-- ========================================================= -->
<!-- Ⅵ. 查詢 FHIR 組織底下的病人名單 -->
<!-- ========================================================= -->
<div class="card">
    <h3>Ⅵ. 查詢 FHIR 組織內的病人名單（PHR + EMR）</h3>

    <label>Organization ID</label>
    <input type="text" id="orgPatientQueryId">

    <button onclick="queryPatientsByOrg()">查詢病人名單</button>

    <div id="orgPatientsResult" style="margin-top:10px;"></div>
</div>

<!-- ========================================================= -->
<!-- Ⅳ. 上傳 Vital Signs -->
<!-- ========================================================= -->
<div class="card">
    <h3>Ⅳ. 上傳生理監測（Vital Signs）</h3>

    <label>Patient ID</label>
    <input type="text" id="vsPatientId">

    <label>監測項目</label>
    <select id="vsType">
        <option value="heart">心跳 Heart Rate</option>
        <option value="spo2">血氧 SpO2</option>
        <option value="temp">體溫 Body Temperature</option>
    </select>

    <label>數值</label>
    <input type="number" id="vsValue">

    <button onclick="uploadVital()">上傳生理監測</button>

    <div id="vsResult" style="margin-top:10px;font-weight:bold;"></div>
</div>

<!-- ========================================================= -->
<!-- Ⅴ. 查詢 Vital Signs -->
<!-- ========================================================= -->
<div class="card">
    <h3>Ⅴ. 查詢生理監測資料</h3>

    <label>Patient ID</label>
    <input type="text" id="queryPatientId">

    <label>查詢項目</label>
    <select id="queryType">
        <option value="heart">心跳</option>
        <option value="spo2">血氧</option>
        <option value="temp">體溫</option>
    </select>

    <button onclick="queryVital()">查詢資料</button>

    <div id="queryResult" style="margin-top:10px;"></div>

    <table id="queryTable" class="hidden">
        <thead>
            <tr>
                <th>日期</th>
                <th>數值</th>
                <th>單位</th>
                <th>Observation ID</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

</div> <!-- container -->

<!-- ========================================================= -->
<!-- JavaScript -->
<!-- ========================================================= -->

<script>
const server = "https://hapi.fhir.org/baseR4";

const KEY_ORG = "fhir_org_list";
const KEY_PHR = "fhir_phr_list";
const KEY_EMR = "fhir_emr_list";

function loadList(key){ return JSON.parse(localStorage.getItem(key) || "[]"); }
function saveList(key, list){ localStorage.setItem(key, JSON.stringify(list)); }

function refreshLists(){
    let orgs = loadList(KEY_ORG);
    let phrs = loadList(KEY_PHR);
    let emrs = loadList(KEY_EMR);

    orgList.innerHTML =
        orgs.length === 0 ? "暫無資料" :
        orgs.map(o => `• ${o.name || "(外部匯入)"}（ID：${o.id}）`).join("<br>");

    phrList.innerHTML =
        phrs.length === 0 ? "暫無資料" :
        phrs.map(p => `• ${p.nickname}（Patient ID：${p.id}）`).join("<br>");

    emrList.innerHTML =
        emrs.length === 0 ? "暫無資料" :
        emrs.map(p => `• ${p.name}（Patient ID：${p.id}）`).join("<br>");
}
refreshLists();

/* ==========================================================
   Ⅰ. 建立 Organization
========================================================== */
async function createOrganization(){
    const name = orgName.value.trim();
    if(!name) return alert("請輸入組織名稱");

    orgResult.textContent = "建立中…";

    let res = await fetch(`${server}/Organization`, {
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({
            resourceType:"Organization",
            name
        })
    });

    let data = await res.json();
    let orgId = data.id;

    orgResult.textContent = `成功建立！Organization ID：${orgId}`;

    let list = loadList(KEY_ORG);
    list.push({ name, id: orgId });
    saveList(KEY_ORG, list);

    refreshLists();
    orgName.value = "";
}

function addExistingOrg(){
    const id = orgIdInput.value.trim();
    if(!id) return alert("請輸入 Organization ID");

    let list = loadList(KEY_ORG);

    if(list.find(o => o.id === id)){
        alert("此 ID 已存在清單中");
        return;
    }

    list.push({ name:"（外部匯入）", id });
    saveList(KEY_ORG, list);

    orgResult.textContent = `已加入既有組織 ID：${id}`;
    orgIdInput.value = "";
    refreshLists();
}

/* ==========================================================
   Ⅱ. 建立 PHR 病人
========================================================== */
async function createPHRPatient(){
    const nickname = phrNickname.value.trim();
    const orgId = phrOrgInput.value.trim();

    if(!nickname) return alert("請輸入暱稱");
    if(!orgId) return alert("請輸入組織 ID");

    phrResult.textContent="建立中…";

    let res = await fetch(`${server}/Patient`, {
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({
            resourceType:"Patient",
            name:[{ text:nickname }],
            managingOrganization:{ reference:`Organization/${orgId}` }
        })
    });

    let data = await res.json();
    let pid = data.id;

    phrResult.textContent=`成功建立！Patient ID：${pid}`;

    let list = loadList(KEY_PHR);
    list.push({ nickname, id:pid, org:orgId });
    saveList(KEY_PHR, list);

    refreshLists();
    phrNickname.value = "";
    phrOrgInput.value = "";
}

/* ==========================================================
   Ⅲ. 建立 EMR 病人
========================================================== */
async function createEMRPatient(){
    const name = emrName.value.trim();
    const gender = emrGender.value;
    const birth = emrBirth.value;
    const orgId = emrOrgInput.value.trim();

    if(!name || !birth) return alert("請輸入姓名與生日");
    if(!orgId) return alert("請輸入組織 ID");

    emrResult.textContent="建立中…";

    let res = await fetch(`${server}/Patient`, {
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({
            resourceType:"Patient",
            name:[{ text:name }],
            gender,
            birthDate:birth,
            managingOrganization:{ reference:`Organization/${orgId}` }
        })
    });

    let data = await res.json();
    let pid = data.id;

    emrResult.textContent=`成功建立！Patient ID：${pid}`;

    let list = loadList(KEY_EMR);
    list.push({ name, id:pid, org:orgId });
    saveList(KEY_EMR, list);

    refreshLists();
    emrName.value="";
    emrBirth.value="";
    emrOrgInput.value="";
}

/* ==========================================================
   Ⅵ. 查詢組織內病人名單
========================================================== */
async function queryPatientsByOrg() {
    const orgId = orgPatientQueryId.value.trim();
    if (!orgId) return alert("請輸入 Organization ID");

    orgPatientsResult.textContent = "查詢中…";

    let url = `${server}/Patient?organization=Organization/${orgId}&_count=200`;

    let res = await fetch(url);
    let data = await res.json();

    if (!data.entry) {
        orgPatientsResult.textContent = "查無病人資料";
        return;
    }

    let html = data.entry.map(e => {
        let p = e.resource;
        let name = p.name?.[0]?.text || "(未命名)";
        let pid = p.id;
        return `• ${name}（Patient ID：${pid}）`;
    }).join("<br>");

    orgPatientsResult.innerHTML = `共 ${data.entry.length} 位病人：<br><br>${html}`;
}

/* ==========================================================
   Ⅳ. 上傳 Vital Signs
========================================================== */
function getVitalCode(type){
    if(type==="heart") return { code:"8867-4", unit:"bpm", display:"Heart Rate" };
    if(type==="spo2") return { code:"59408-5", unit:"%", display:"SpO2" };
    if(type==="temp") return { code:"8310-5", unit:"°C", display:"Body Temperature" };
}

async function uploadVital(){
    const pid = vsPatientId.value.trim();
    const type = vsType.value;
    const value = Number(vsValue.value);

    if(!pid || !value) return alert("請輸入 Patient ID 與數值");

    const vital = getVitalCode(type);

    vsResult.textContent="上傳中…";

    let res = await fetch(`${server}/Observation`, {
        method:"POST",
        headers:{ "Content-Type":"application/fhir+json" },
        body:JSON.stringify({
            resourceType:"Observation",
            status:"final",
            code:{ coding:[{ system:"http://loinc.org", code:vital.code, display:vital.display }] },
            subject:{ reference:`Patient/${pid}` },
            effectiveDateTime:new Date().toISOString(),
            valueQuantity:{ value, unit:vital.unit }
        })
    });

    let data = await res.json();
    vsResult.textContent=`上傳成功！Observation ID：${data.id}`;
}

/* ==========================================================
   Ⅴ. 查詢 Vital Signs
========================================================== */
function getQueryCode(type){
    if(type==="heart") return "8867-4";
    if(type==="spo2") return "59408-5";
    if(type==="temp") return "8310-5";
}

async function queryVital(){
    const pid = queryPatientId.value.trim();
    const type = queryType.value;
    const code = getQueryCode(type);

    if(!pid) return alert("請輸入 Patient ID");

    queryResult.textContent="查詢中…";
    queryTable.classList.add("hidden");
    queryTable.querySelector("tbody").innerHTML="";

    let url = `${server}/Observation?subject=Patient/${pid}&code=${code}&_count=500`;

    let r = await fetch(url);
    let d = await r.json();

    if(!d.entry){
        queryResult.textContent="查無資料";
        return;
    }

    let rows = d.entry
        .map(e=>{
            let o=e.resource;
            return `
                <tr>
                    <td>${o.effectiveDateTime?.substring(0,10) || ""}</td>
                    <td>${o.valueQuantity?.value || ""}</td>
                    <td>${o.valueQuantity?.unit || ""}</td>
                    <td>${o.id}</td>
                </tr>`;
        })
        .join("");

    queryTable.querySelector("tbody").innerHTML = rows;
    queryTable.classList.remove("hidden");
    queryResult.textContent = `查詢完成，共 ${d.entry.length} 筆資料`;
}

</script>

</body>
</html>
