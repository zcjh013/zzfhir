<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å¤§å¥åº· FHIR ç¶“æœŸè§€æ¸¬ç«™ â€” ç®¡ç†å¾Œå° Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background:#FAF7F2;
    font-family:Arial;
    margin:0;
    padding:0;
    color:#3b3b3b;
}

/* ğŸŸ© Header */
.top-header {
    width:100%;
    background:#5A6F68;
    color:white;
    padding:18px 28px;
    box-sizing:border-box;
}
.top-header-title {
    font-size:22px;
    font-weight:bold;
    line-height:1.3;
    white-space:pre-line;
}

/* ğŸŸ¦ å¡ç‰‡ */
.card {
    background:white;
    margin:20px auto;
    width:92%;
    max-width:1000px;
    padding:20px;
    border-radius:12px;
    border-left:6px solid #5A6F68;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

/* ğŸ”˜ æŒ‰éˆ• */
button {
    background:#5A6F68;
    color:white;
    border:none;
    padding:10px 18px;
    border-radius:8px;
    cursor:pointer;
    font-size:15px;
    margin-top:10px;
}
button:hover { opacity:0.9; }

/* è¼¸å…¥æ¡† */
input, select {
    width:100%;
    padding:8px;
    border-radius:8px;
    border:1px solid #bbb;
    margin-top:5px;
}

/* è¡¨æ ¼ */
table {
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
}
th, td {
    padding:8px;
    border:1px solid #ccc;
    text-align:left;
}
.hidden { display:none; }
</style>
</head>

<body>

<!-- ğŸŸ© Header -->
<div class="top-header">
<div class="top-header-title">
å¤§å¥åº·
FHIR
ç¶“æœŸè§€æ¸¬ç«™ Admin
</div>
</div>

<!-- ğŸŸ¦ ç™»å‡ºæŒ‰éˆ• -->
<button onclick="window.location.href='index.html'"
        style="position:fixed; top:15px; right:15px;
               background:#888; padding:8px 14px;
               border-radius:8px; font-size:14px; z-index:999;">
    ç™»å‡º
</button>

<script>
// FHIR Server
const server = "https://hapi.fhir.org/baseR4";
</script>

<!-- ===================================================== -->
<!-- â… . å»ºç«‹çµ„ç¹” (Organization) -->
<!-- ===================================================== -->
<div class="card">
<h3>â… . å»ºç«‹ FHIR çµ„ç¹”ï¼ˆOrganizationï¼‰</h3>

<label>çµ„ç¹”åç¨±</label>
<input type="text" id="orgName">

<button onclick="createOrg()">å»ºç«‹çµ„ç¹”</button>
<div id="orgResult" style="margin-top:10px;font-weight:bold;"></div>

<h4 style="margin-top:20px;">å·²å»ºç«‹çš„çµ„ç¹”</h4>
<ul id="orgList"></ul>
</div>

<script>
let organizations = [];

// å»ºç«‹çµ„ç¹”
async function createOrg() {
    const name = orgName.value.trim();
    if(!name){ alert("è«‹è¼¸å…¥çµ„ç¹”åç¨±"); return; }

    const body = {
        resourceType:"Organization",
        name:name
    };

    const r = await fetch(`${server}/Organization`, {
        method:"POST",
        headers:{"Content-Type":"application/fhir+json"},
        body:JSON.stringify(body)
    });
    const d = await r.json();

    organizations.push({name:name, id:d.id});
    orgResult.textContent = `å·²å»ºç«‹ Organizationï¼ŒIDï¼š${d.id}`;

    orgList.innerHTML = organizations
        .map(o=>`<li>${o.name}ï¼ˆIDï¼š${o.id}ï¼‰</li>`)
        .join("");
}
</script>

<!-- ===================================================== -->
<!-- â…¡. å»ºç«‹ PHR Patient -->
<!-- ===================================================== -->
<div class="card">
<h3>â…¡. å»ºç«‹ PHR ç—…äººï¼ˆæš±ç¨±ï¼‰</h3>

<label>æš±ç¨±</label>
<input type="text" id="phrName">

<label>æ‰€å±¬çµ„ç¹”ï¼ˆOrganizationï¼‰</label>
<select id="phrOrg"></select>

<button onclick="createPHR()">å»ºç«‹ PHR ç—…äºº</button>
<div id="phrResult" style="margin-top:10px;font-weight:bold;"></div>
</div>

<script>
// æ›´æ–°çµ„ç¹”åˆ—è¡¨
function refreshOrgDropdown() {
    phrOrg.innerHTML = organizations
        .map(o=>`<option value="${o.id}">${o.name}ï¼ˆ${o.id}ï¼‰</option>`)
        .join("");
}

// å»ºç«‹æ°‘çœ¾ç«¯ç—…äººï¼ˆPHRï¼‰
async function createPHR(){
    const nickname = phrName.value.trim();
    const org = phrOrg.value;
    if(!nickname){ alert("è«‹è¼¸å…¥æš±ç¨±"); return; }

    const body = {
        resourceType:"Patient",
        name:[{text:nickname}],
        managingOrganization:{ reference:`Organization/${org}` }
    };

    const r = await fetch(`${server}/Patient`,{
        method:"POST",
        headers:{"Content-Type":"application/fhir+json"},
        body:JSON.stringify(body)
    });
    const d = await r.json();

    phrResult.textContent = `PHR Patient å»ºç«‹æˆåŠŸï¼Patient IDï¼š${d.id}`;
}
</script>

<!-- ===================================================== -->
<!-- â…¢. å»ºç«‹ EMR Patient -->
<!-- ===================================================== -->
<div class="card">
<h3>â…¢. å»ºç«‹ EMR ç—…äººï¼ˆé†«é™¢ç«¯ï¼‰</h3>

<label>å§“å</label>
<input type="text" id="emrName">

<label>æ€§åˆ¥</label>
<select id="emrGender">
    <option value="male">ç”·</option>
    <option value="female">å¥³</option>
</select>

<label>ç”Ÿæ—¥</label>
<input type="date" id="emrBirth">

<label>æ‰€å±¬çµ„ç¹”</label>
<select id="emrOrg"></select>

<button onclick="createEMR()">å»ºç«‹ EMR ç—…äºº</button>
<div id="emrResult" style="margin-top:10px;font-weight:bold;"></div>
</div>

<script>
function refreshOrgForEMR() {
    emrOrg.innerHTML = organizations
        .map(o=>`<option value="${o.id}">${o.name}ï¼ˆ${o.id}ï¼‰</option>`)
        .join("");
}

// å»ºç«‹ EMR ç—…äºº
async function createEMR(){
    const name = emrName.value.trim();
    const birth = emrBirth.value;
    const gender = emrGender.value;
    const org = emrOrg.value;

    if(!name || !birth){ alert("è«‹å¡«å…¥å…¨éƒ¨è³‡æ–™"); return; }

    const body = {
        resourceType:"Patient",
        name:[{text:name}],
        gender:gender,
        birthDate:birth,
        managingOrganization:{ reference:`Organization/${org}` }
    };

    const r = await fetch(`${server}/Patient`,{
        method:"POST",
        headers:{"Content-Type":"application/fhir+json"},
        body:JSON.stringify(body)
    });
    const d = await r.json();

    emrResult.textContent = `EMR Patient å»ºç«‹æˆåŠŸï¼Patient IDï¼š${d.id}`;
}
</script>

<!-- ===================================================== -->
<!-- â…£. ä¸Šå‚³ç”Ÿç†ç›£æ¸¬ -->
<!-- ===================================================== -->
<div class="card">
<h3>â…£. ä¸Šå‚³ç”Ÿç†ç›£æ¸¬ï¼ˆVital Signsï¼‰</h3>

<label>Patient ID</label>
<input type="text" id="vPid" placeholder="ä¾‹å¦‚ 52960712">

<label>é¸æ“‡é …ç›®</label>
<select id="vType">
    <option value="heart">å¿ƒè·³ Heart Rate</option>
    <option value="spo2">è¡€æ°§ SpO2</option>
    <option value="temp">é«”æº« Body Temp</option>
</select>

<label>è¼¸å…¥æ•¸å€¼</label>
<input type="number" id="vValue">

<button onclick="uploadVital()">ä¸Šå‚³ç›£æ¸¬è³‡æ–™</button>
<div id="vResult" style="margin-top:10px;font-weight:bold;"></div>
</div>

<script>
// ä¸Šå‚³ç”Ÿç†ç›£æ¸¬
async function uploadVital() {
    const pid = vPid.value.trim();
    const type = vType.value;
    const val = Number(vValue.value);

    if(!pid || isNaN(val)){ alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™"); return; }

    let loinc = "";
    if(type==="heart") loinc="8867-4";
    if(type==="spo2")  loinc="59408-5";
    if(type==="temp")  loinc="8310-5";

    const body = {
        resourceType:"Observation",
        status:"final",
        code:{coding:[{system:"http://loinc.org", code:loinc}]},
        subject:{reference:`Patient/${pid}`},
        valueQuantity:{value:val},
        effectiveDateTime:new Date().toISOString()
    };

    const r = await fetch(`${server}/Observation`,{
        method:"POST",
        headers:{"Content-Type":"application/fhir+json"},
        body:JSON.stringify(body)
    });
    const d = await r.json();

    vResult.textContent = `å·²ä¸Šå‚³ Observationï¼ŒIDï¼š${d.id}`;
}
</script>

<!-- ===================================================== -->
<!-- â…¤. æŸ¥è©¢ç”Ÿç†ç›£æ¸¬è³‡æ–™ -->
<!-- ===================================================== -->
<div class="card">
<h3>â…¤. æŸ¥è©¢ç”Ÿç†ç›£æ¸¬è³‡æ–™</h3>

<label>Patient ID</label>
<input type="text" id="qPid">

<label>æŸ¥è©¢é …ç›®</label>
<select id="qType">
    <option value="heart">å¿ƒè·³</option>
    <option value="spo2">è¡€æ°§</option>
    <option value="temp">é«”æº«</option>
</select>

<button onclick="queryVital()">æŸ¥è©¢è³‡æ–™</button>

<div id="qStatus" style="margin-top:10px;font-weight:bold;"></div>

<table id="qTable" class="hidden">
<thead>
<tr>
    <th>æ—¥æœŸ</th>
    <th>æ•¸å€¼</th>
    <th>å–®ä½</th>
    <th>Observation ID</th>
</tr>
</thead>
<tbody id="qBody"></tbody>
</table>
</div>

<script>
// æŸ¥è©¢ç”Ÿç†ç›£æ¸¬
async function queryVital() {
    const pid = qPid.value.trim();
    const type = qType.value;

    if(!pid){ alert("è«‹è¼¸å…¥ Patient ID"); return; }

    let loinc="", unit="";
    if(type==="heart"){ loinc="8867-4"; unit="bpm"; }
    if(type==="spo2"){ loinc="59408-5"; unit="%"; }
    if(type==="temp"){ loinc="8310-5"; unit="Â°C"; }

    const url = `${server}/Observation?subject=Patient/${pid}&code=${loinc}&_count=500`;

    qStatus.textContent="æŸ¥è©¢ä¸­â€¦";
    qBody.innerHTML="";

    try{
        const res = await fetch(url);
        const data = await res.json();

        const list = data.entry || [];

        if(list.length === 0){
            qStatus.textContent="ç„¡è³‡æ–™";
            qTable.classList.add("hidden");
            return;
        }

        list.forEach(e=>{
            const o=e.resource;
            const date=o.effectiveDateTime?.substring(0,10) || "";
            const val=o.valueQuantity?.value || "";
            const id=o.id;

            qBody.innerHTML += `
                <tr>
                    <td>${date}</td>
                    <td>${val}</td>
                    <td>${unit}</td>
                    <td>${id}</td>
                </tr>`;
        });

        qTable.classList.remove("hidden");
        qStatus.textContent = `æ‰¾åˆ° ${list.length} ç­†è³‡æ–™`;

    } catch(e){
        qStatus.textContent="æŸ¥è©¢å¤±æ•—ï¼ˆé€£ç·šéŒ¯èª¤ï¼‰";
    }
}
</script>

<script>
// ç•¶å»ºç«‹çµ„ç¹”å¾ŒåŒæ­¥æ›´æ–°ä¸‹æ‹‰é¸å–®
setInterval(()=>{
    refreshOrgDropdown();
    refreshOrgForEMR();
}, 500);
</script>

</body>
</html>
